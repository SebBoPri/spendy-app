<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spendy - Your Fun Budget Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [ANCHOR: Global Styles] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #FF6B6B; --secondary: #4ECDC4; --accent: #FFE66D;
            --dark: #2A2D34; --light: #F7F9FC; --success: #95E1D3; --purple: #A78BFA;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: var(--dark); position: relative; overflow-x: hidden;
        }

        /* Animated Blobs */
        .bg-blob { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.3; animation: float 20s infinite ease-in-out; z-index: 0; }
        .blob-1 { width: 400px; height: 400px; background: var(--primary); top: -100px; right: -100px; }
        .blob-2 { width: 500px; height: 500px; background: var(--secondary); bottom: -150px; left: -150px; animation-delay: 7s; }
        .blob-3 { width: 300px; height: 300px; background: var(--accent); top: 50%; right: 20%; animation-delay: 14s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }

        /* [ANCHOR: UI Components] */
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; }
        header { text-align: center; margin-bottom: 32px; animation: slideDown 0.6s ease-out; }
        .logo-icon { width: 48px; height: 48px; background: white; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; transform: rotate(-5deg); box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: wiggle 2s infinite ease-in-out; margin: 0 auto 10px;}
        h1 { font-family: 'Fraunces', serif; font-size: 3.5em; font-weight: 900; color: white; text-shadow: 0 2px 20px rgba(0,0,0,0.2); letter-spacing: -2px; }
        
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 32px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 8px; border-radius: 20px; }
        .nav-tab { flex: 1; padding: 14px 24px; background: transparent; border: none; border-radius: 14px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-tab.active { background: white; color: var(--primary); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }

        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 32px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 14px 32px; border-radius: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255,107,107,0.4); }

        /* [ANCHOR: Table & List Styles] */
        .item { display: flex; justify-content: space-between; padding: 16px; border-radius: 12px; margin-bottom: 8px; background: rgba(247,249,252,0.5); }
        table { width: 100%; border-spacing: 0 8px; border-collapse: separate; }
        th { padding: 16px; text-align: left; background: var(--light); cursor: pointer; border-radius: 8px; }
        td { padding: 16px; background: white; border-top: 1px solid var(--light); }
        
        /* Batch UI */
        .receipt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .receipt-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .batch-progress-bar { height: 8px; background: var(--secondary); width: 0%; transition: width 0.3s; border-radius: 4px; }
        
        .upload-zone { border: 3px dashed rgba(255,255,255,0.4); border-radius: 24px; padding: 64px 32px; text-align: center; cursor: pointer; background: rgba(255,255,255,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <div class="container">
        <header>
            <div class="logo-icon">üí∞</div>
            <h1>Spendy</h1>
            <p class="tagline">Your playful budget companion</p>
            
            <div id="auth-section" style="margin-top: 20px;">
                <button id="loginBtn" class="btn" onclick="signInWithGoogle()"><span>Sign In with Google üë§</span></button>
                <div id="userProfile" style="display: none; color: white;">
                    <span id="userEmail" style="font-weight: 600; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 20px;"></span>
                    <button class="btn" onclick="signOut()" style="margin-left: 10px; padding: 5px 15px; font-size: 0.8em; background: var(--primary);">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('scan')"><span>Scan</span></button>
            <button class="nav-tab" onclick="switchTab('dashboard')"><span>Dashboard</span></button>
            <button class="nav-tab" onclick="switchTab('data')"><span>Data</span></button>
            <button class="nav-tab" onclick="switchTab('history')"><span>History</span></button>
        </nav>

        <div id="scan" class="tab-content active">
            <div class="card">
                <h2 class="card-title">Snap Your Receipt</h2>
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 40px;">üì∏</div>
                    <h3>Click to Upload</h3>
                    <p>Select one or multiple receipts at once</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" capture="environment" multiple>
                
                <div id="processingArea" style="display: none;">
                    <img id="receiptPreview" style="width:100%; max-height:400px; border-radius:16px; margin-top:20px; object-fit:contain;">
                    <div id="loadingState" style="text-align:center; padding:20px;">AI is reading... ‚ú®</div>
                    <div id="resultsArea" style="display: none;">
                        <div id="itemsList" class="item-list"></div>
                        <button class="btn" onclick="saveReceipt()"><span>Save to Budget üíæ</span></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">
                <div class="card" style="margin-bottom:0; text-align:center;">
                    <div style="font-size: 2em;">üí∏</div>
                    <div>Total Spent</div>
                    <div id="totalSpent" style="font-size: 1.5em; font-weight: 700;">0 kr</div>
                </div>
                <div class="card" style="margin-bottom:0; text-align:center;">
                    <div style="font-size: 2em;">üßæ</div>
                    <div>Receipts</div>
                    <div id="receiptCount" style="font-size: 1.5em; font-weight: 700;">0</div>
                </div>
                <div class="card" style="margin-bottom:0; text-align:center;">
                    <div style="font-size: 2em;">üõí</div>
                    <div>Items</div>
                    <div id="itemCount" style="font-size: 1.5em; font-weight: 700;">0</div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Spending Overview</h2>
                <div style="height: 300px;"><canvas id="categoryChart"></canvas></div>
            </div>

            <div class="card">
                <h2 class="card-title">Top Items Tracker</h2>
                <div id="topItemsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"></div>
            </div>

            <div class="card">
                <h2 class="card-title">Price Comparison</h2>
                <div id="priceComparison"></div>
            </div>
        </div>

        <div id="data" class="tab-content">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <input type="text" id="searchInput" placeholder="üîç Search items..." style="width:70%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <button class="btn" onclick="exportToCSV()" style="padding:10px;">Export CSV</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('date')">Date</th>
                                <th onclick="sortTable('store')">Store</th>
                                <th onclick="sortTable('item')">Item</th>
                                <th onclick="sortTable('category')">Category</th>
                                <th onclick="sortTable('price')">Price</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // [ANCHOR: Supabase Config]
        const supabaseUrl = 'https://ztdvxcekvkonipdddraj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZHZ4Y2VrdmtvbmlwZGRkcmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNzU0NDYsImV4cCI6MjA4Mzg1MTQ0Nn0.FYMo-w6HomXjaclhqdOWArIcLMqA2ZakBwYfTsgS7xI';
        const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let allReceipts = [];
        let currentReceipt = null;

        // [ANCHOR: Auth Logic]
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('userEmail').textContent = currentUser.email;
                loadData();
            } else {
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('userProfile').style.display = 'none';
            }
        });

        async function signInWithGoogle() {
            await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } });
        }

        async function signOut() {
            await supabase.auth.signOut();
            location.reload();
        }

        // [ANCHOR: Data Management]
        async function loadData() {
            const stored = localStorage.getItem('spendy-receipts');
            if (stored) {
                allReceipts = JSON.parse(stored);
                updateDashboard();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if(tabName === 'dashboard') updateDashboard();
            if(tabName === 'data') updateDataTable();
            if(tabName === 'history') updateHistory();
        }

        // [ANCHOR: Scanner Logic]
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 1) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    document.getElementById('receiptPreview').src = ev.target.result;
                    document.getElementById('processingArea').style.display = 'block';
                    document.getElementById('loadingState').style.display = 'block';
                    await analyzeReceipt(ev.target.result);
                };
                reader.readAsDataURL(files[0]);
            } else {
                await processBatchReceipts(files);
            }
        });

        async function analyzeReceipt(imageData) {
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageData })
                });
                const data = await response.json();
                currentReceipt = data;
                displayResults(data);
            } catch (e) { alert("Scan failed: " + e.message); }
        }

        function displayResults(data) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'block';
            document.getElementById('itemsList').innerHTML = data.items.map(i => `
                <div class="item">
                    <span>${i.name}</span>
                    <span style="color:var(--primary)">${i.price.toFixed(2)} kr</span>
                </div>
            `).join('');
        }

        function saveReceipt() {
            if (!currentReceipt) return;
            allReceipts.push(currentReceipt);
            localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
            alert("Saved!");
            switchTab('dashboard');
        }

        // [ANCHOR: Dashboard & UI Updates]
        function updateDashboard() {
            const total = allReceipts.reduce((s, r) => s + (r.total || 0), 0);
            document.getElementById('totalSpent').textContent = total.toFixed(2) + ' kr';
            document.getElementById('receiptCount').textContent = allReceipts.length;
            document.getElementById('itemCount').textContent = allReceipts.reduce((s, r) => s + r.items.length, 0);
            
            updateCharts();
            updateTopItems();
            updatePriceComparison();
        }

        function updateCharts() {
            const cats = {};
            allReceipts.forEach(r => r.items.forEach(i => cats[i.category] = (cats[i.category] || 0) + i.price));
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (window.chart) window.chart.destroy();
            window.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor: ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A78BFA'] }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function updateTopItems() {
            const items = {};
            allReceipts.forEach(r => r.items.forEach(i => {
                const n = i.name.toLowerCase();
                if(!items[n]) items[n] = { name: i.name, cost: 0, freq: 0 };
                items[n].cost += i.price;
                items[n].freq += 1;
            }));
            const top = Object.values(items).sort((a,b) => b.cost - a.cost).slice(0,5);
            document.getElementById('topItemsContainer').innerHTML = top.map(t => `
                <div style="font-size:0.9em;">
                    <strong>${t.name}</strong><br>${t.cost.toFixed(2)} kr (${t.freq}x)
                </div>
            `).join('');
        }

        function updateHistory() {
            document.getElementById('historyList').innerHTML = allReceipts.map((r, idx) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><strong>${r.store}</strong><br><small>${r.date}</small></div>
                    <div>${r.total.toFixed(2)} kr <button onclick="deleteReceipt(${idx})" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button></div>
                </div>
            `).reverse().join('');
        }

        function deleteReceipt(index) {
            if(confirm("Delete this?")) {
                allReceipts.splice(index, 1);
                localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
                updateHistory();
                updateDashboard();
            }
        }

        function updateDataTable() {
            const body = document.getElementById('dataTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            let rows = [];
            allReceipts.forEach(r => r.items.forEach(i => {
                if(i.name.toLowerCase().includes(search) || r.store.toLowerCase().includes(search)) {
                    rows.push(`<tr><td>${r.date}</td><td>${r.store}</td><td>${i.name}</td><td>${i.category}</td><td>${i.price.toFixed(2)}</td></tr>`);
                }
            }));
            body.innerHTML = rows.join('');
        }

        document.getElementById('searchInput').addEventListener('input', updateDataTable);

        // [ANCHOR: Utility Functions]
        function exportToCSV() {
            let csv = "Date,Store,Item,Category,Price\n";
            allReceipts.forEach(r => r.items.forEach(i => csv += `${r.date},${r.store},${i.name},${i.category},${i.price}\n`));
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'spendy_export.csv'; a.click();
        }

        function updatePriceComparison() {
            const comp = {};
            allReceipts.forEach(r => r.items.forEach(i => {
                const n = i.name.toLowerCase();
                if(!comp[n]) comp[n] = {};
                if(!comp[n][r.store] || comp[n][r.store] > i.price) comp[n][r.store] = i.price;
            }));
            const html = Object.entries(comp).filter(([_, stores]) => Object.keys(stores).length > 1).slice(0,3).map(([name, stores]) => `
                <div style="margin-bottom:10px;"><strong>${name}</strong>: ${Object.entries(stores).map(([s, p]) => `${s} (${p}kr)`).join(' vs ')}</div>
            `).join('');
            document.getElementById('priceComparison').innerHTML = html || "Scan more stores to see comparisons!";
        }
    </script>
</body>
</html>
