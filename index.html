<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">

    <!-- Primary Meta Tags -->
    <title>Spendy - Smart Receipt Tracker</title>
    <meta name="title" content="Spendy - Smart Receipt Tracker">
    <meta name="description" content="AI-powered receipt scanning and budgeting app. Track spending, scan receipts, and manage your finances with ease.">
    <meta name="keywords" content="receipt scanner, budget tracker, expense tracker, finance app, receipt organizer, spending tracker">
    <meta name="author" content="Spendy">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5BA89F">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spendy">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/icon-57x57.png">

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Splash Screens for iOS -->
    <link rel="apple-touch-startup-image" href="/splash/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://spendy-app-sebastian-bs-projects-93a4e006.vercel.app/">
    <meta property="og:title" content="Spendy - Smart Receipt Tracker">
    <meta property="og:description" content="AI-powered receipt scanning and budgeting app. Track spending, scan receipts, and manage your finances with ease.">
    <meta property="og:image" content="https://spendy-app-sebastian-bs-projects-93a4e006.vercel.app/icons/icon-512x512.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://spendy-app-sebastian-bs-projects-93a4e006.vercel.app/">
    <meta property="twitter:title" content="Spendy - Smart Receipt Tracker">
    <meta property="twitter:description" content="AI-powered receipt scanning and budgeting app. Track spending, scan receipts, and manage your finances with ease.">
    <meta property="twitter:image" content="https://spendy-app-sebastian-bs-projects-93a4e006.vercel.app/icons/icon-512x512.png">

    <!-- Fonts & Scripts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* ====================================
               SPENDY DESIGN SYSTEM
               Updated: 2026-01-18
               Design Philosophy: Vibrant, modern, floating
               ==================================== */

            /* PRIMARY COLORS - Premium Airy Teal */
            --primary: #2D9CDB;                    /* Vibrant Blue - Main brand color */
            --primary-dark: #1F7BAD;               /* Darker blue for hover states */
            --primary-light: #E3F2FD;              /* Light blue for backgrounds */
            --primary-alpha-10: rgba(45, 156, 219, 0.1);
            --primary-alpha-20: rgba(45, 156, 219, 0.2);

            /* PREMIUM AIRY TEAL COLORS */
            --teal-primary: #5aafb5;               /* Vibrant teal - Premium cards & progress */
            --teal-light: #a8dadc;                 /* Light teal - Gradients */
            --teal-alpha-10: rgba(90, 175, 181, 0.1);

            /* SEMANTIC COLORS */
            --expense-red: #E63946;                /* Red for expenses */
            --income-green: #27AE60;               /* Green for income */
            --warning-yellow: #F4A261;             /* Yellow for warnings */
            --info-blue: #2D9CDB;                  /* Blue for info (same as primary) */
            --success-green: #27AE60;              /* Success states */
            --error-red: #E63946;                  /* Error states */

            /* NEUTRAL COLORS */
            --background: #F8F9F9;                 /* Premium Airy background */
            --card: #FFFFFF;                       /* Pure White for cards */
            --white: #FFFFFF;                      /* Pure white */
            --border: #E5E7EB;                     /* Light grey borders */
            --border-light: #F3F4F6;               /* Lighter borders for Premium Airy */
            --divider: #F3F4F6;                    /* Subtle dividers */

            /* TEXT COLORS */
            --text-primary: #333333;               /* #333333 - Main text */
            --text-secondary: #6B7280;             /* Medium grey - Secondary text */
            --text-tertiary: #9CA3AF;              /* Light grey - Tertiary text */
            --text-disabled: #D1D5DB;              /* Very light grey - Disabled */
            --text-on-primary: #FFFFFF;            /* White text on primary color */

            /* SPACING SYSTEM */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --spacing-3xl: 64px;

            /* BORDER RADIUS - SPENDY STANDARD */
            --radius-small: 8px;                   /* Small elements (tags, badges) */
            --radius-medium: 12px;                 /* Buttons & small elements */
            --radius-large: 24px;                  /* Large cards (NEW: 24px) */
            --radius-xlarge: 24px;                 /* Large containers (NEW: 24px) */
            --radius-round: 50%;                   /* Circular elements */

            /* SHADOWS - SOFT FLOATING (SPENDY) */
            --shadow-soft: 0px 10px 30px rgba(0, 0, 0, 0.05);   /* Soft Floating Shadow (NEW) */
            --shadow-low: 0 2px 8px rgba(0, 0, 0, 0.04);        /* Very subtle */
            --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.06);    /* Standard elevation */
            --shadow-high: 0 12px 40px rgba(0, 0, 0, 0.08);     /* High elevation */
            --shadow-primary: 0 8px 25px rgba(45, 156, 219, 0.15); /* Primary glow */

            /* TRANSITIONS */
            --transition-fast: 0.15s ease;
            --transition-base: 0.2s ease;
            --transition-slow: 0.3s ease;
            --transition-bounce: 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* TYPOGRAPHY - CLEAN SANS-SERIF (SPENDY) */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 32px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;           /* Subheaders */
            --font-weight-bold: 700;               /* Headings */

            /* Z-INDEX SCALE */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-overlay: 500;
            --z-modal: 1000;
            --z-toast: 2000;
            --z-tooltip: 3000;

            /* LEGACY COMPATIBILITY (mapped to new theme) */
            --secondary: #2D9CDB;                  /* Maps to primary */
            --accent: #F4A261;                     /* Warning yellow */
            --dark: #333333;                       /* Text primary */
            --success: #27AE60;                    /* Success green */
            --light: #F8F9FA;                      /* Background */
        }

        body {
            font-family: var(--font-family);
            background: var(--background);
            min-height: 100vh;
            padding: 0;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Clean background - no blobs for professional look */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            padding-bottom: 100px; /* Space for floating bottom nav */
        }

        /* HomeHeader Component (Spendy Design) */
        header {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg) 0;
        }

        .home-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Spendy Logo */
        .spendy-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spendy-logo-icon {
            font-size: 28px;
            line-height: 1;
        }

        .spendy-logo-text {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        /* Profile Chip */
        .profile-chip {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--primary-alpha-10);
            padding: 8px 16px 8px 8px;
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
        }

        .profile-chip:hover {
            background: var(--primary-alpha-20);
            transform: translateY(-1px);
        }

        .profile-initial-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--text-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
        }

        .profile-email-text {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Guest Chip (when not logged in) */
        .guest-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: var(--radius-medium);
            background: var(--divider);
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        .guest-chip .login-link {
            color: var(--primary);
            font-weight: var(--font-weight-semibold);
            text-decoration: none;
            margin-left: 4px;
            cursor: pointer;
        }

        .guest-chip .login-link:hover {
            text-decoration: underline;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .profile-email-text {
                max-width: 120px;
            }

            .spendy-logo-text {
                font-size: var(--font-size-xl);
            }
        }

        /* ====================================
           RECEIPT SCANNER COMPONENT
           Full-screen camera viewfinder
           ==================================== */

        .receipt-scanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: var(--z-modal);
            display: none;
        }

        .receipt-scanner.active {
            display: flex;
            flex-direction: column;
        }

        /* Camera Viewfinder */
        .camera-viewfinder {
            position: relative;
            flex: 1;
            width: 100%;
            overflow: hidden;
            background: #000;
        }

        .camera-viewfinder video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Overlay */
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        /* Focus Frame (80% width, centered) */
        .focus-frame {
            position: relative;
            width: 80%;
            aspect-ratio: 3/4;
            border: 3px solid var(--primary);
            border-radius: var(--radius-large);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            background: transparent;
            overflow: hidden;
        }

        /* Corner Indicators */
        .focus-frame::before,
        .focus-frame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--primary);
            box-shadow: 0 0 10px rgba(45, 156, 219, 0.5);
        }

        .focus-frame::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: var(--radius-large);
        }

        .focus-frame::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: var(--radius-large);
        }

        /* Scanning Animation Line */
        .scan-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--primary) 50%,
                transparent 100%
            );
            box-shadow: 0 0 10px var(--primary), 0 0 20px rgba(45, 156, 219, 0.5);
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% {
                top: 10%;
                opacity: 0.8;
            }
            50% {
                top: 90%;
                opacity: 1;
            }
        }

        /* Tip Box */
        .scanner-tip {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-medium);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-align: center;
            max-width: 90%;
            pointer-events: none;
        }

        /* Bottom Control Bar */
        .scanner-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            pointer-events: none;
        }

        .scanner-controls > * {
            pointer-events: auto;
        }

        /* Control Buttons */
        .control-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .control-button:active {
            transform: scale(0.95);
        }

        .control-button.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Shutter Button (large, circular, teal) */
        .shutter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            border: 4px solid white;
            box-shadow: 0 4px 20px rgba(45, 156, 219, 0.5), 0 0 0 8px rgba(45, 156, 219, 0.2);
            color: white;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .shutter-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(45, 156, 219, 0.6), 0 0 0 8px rgba(45, 156, 219, 0.3);
        }

        .shutter-button:active {
            transform: scale(0.95);
        }

        /* Close Scanner Button */
        .close-scanner {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            z-index: 10;
        }

        .close-scanner:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        /* Processing Spinner Overlay */
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 20;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(45, 156, 219, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            color: white;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }

        /* Category Pill Selector */
        .category-pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin-bottom: 8px;
        }

        .category-pills::-webkit-scrollbar {
            display: none;
        }

        .category-pill {
            flex-shrink: 0;
            padding: 10px 20px;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 24px;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .category-pill:hover {
            border-color: var(--primary);
            background: var(--primary-alpha-10);
        }

        .category-pill.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Floating Pill Bottom Navigation (Premium Airy) */
        .nav-tabs {
            position: fixed;
            bottom: 16px;  /* bottom-4 */
            left: 16px;    /* left-4 */
            right: 16px;   /* right-4 */
            display: flex;
            gap: 0;
            background: #FFFFFF;  /* Pure white for Premium Airy */
            padding: 12px 8px;
            border-radius: 9999px;  /* Fully rounded pill */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);  /* Soft shadow */
            z-index: var(--z-sticky);
            border: none;
            transition: opacity var(--transition-base), visibility var(--transition-base);
        }

        /* Hide BottomNav when scanner is active */
        .receipt-scanner.active ~ * .nav-tabs {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* ====================================
           DATA ANALYTICS COMPONENTS
           Charts and visualizations
           ==================================== */

        /* Time Period Toggle (Segmented Control) */
        .time-toggle {
            display: flex;
            gap: 8px;
            background: var(--background);
            padding: 6px;
            border-radius: 32px;
            margin-bottom: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .time-toggle-btn {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 24px;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
        }

        .time-toggle-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(0, 0, 0, 0.03);
        }

        .time-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(45, 156, 219, 0.25);
        }

        /* Chart Container */
        .chart-container {
            background: var(--card);
            border-radius: var(--radius-large);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .chart-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        /* Donut Chart */
        .donut-chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 280px;
            margin: 0 auto 24px;
        }

        .donut-chart {
            width: 100%;
            height: auto;
            display: block;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .donut-total-label {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .donut-total-amount {
            font-size: 28px;
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            line-height: 1;
        }

        /* Category Legend */
        .category-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            max-width: 100%;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            min-width: 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .legend-amount {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Area Chart */
        .area-chart-wrapper {
            width: 100%;
            height: 260px;
            position: relative;
            overflow: hidden;
        }

        .area-chart {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Chart axis labels */
        .chart-axis-label {
            font-size: var(--font-size-xs);
            fill: var(--text-tertiary);
        }

        /* Tooltip for charts */
        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: var(--font-size-xs);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: 100;
            white-space: nowrap;
        }

        .chart-tooltip.visible {
            opacity: 1;
        }

        /* Top Spending Category Cards */
        .category-spending-card {
            background: var(--card);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
            transition: all var(--transition-base);
            cursor: default;
        }

        .category-spending-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .category-icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .spending-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--divider);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        .spending-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        /* ====================================
           INSIGHT CARD COMPONENT
           AI-generated insights with gradient
           ==================================== */

        .insight-card {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: 2px solid #2D9CDB;
            border-radius: var(--radius-large);
            padding: 24px;
            margin-top: 32px;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
        }

        .insight-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-slow);
        }

        .insight-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .insight-card:hover::before {
            opacity: 1;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insight-icon {
            font-size: 32px;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.1) rotate(5deg);
                opacity: 0.9;
            }
        }

        .insight-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--primary-dark);
            margin: 0;
        }

        .insight-text {
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: #1565C0;
            font-weight: var(--font-weight-medium);
            position: relative;
            z-index: 1;
        }

        .insight-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ====================================
           TAG SYSTEM
           Tag pills and management
           ==================================== */

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 24px;
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary-alpha-10);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            white-space: nowrap;
            transition: all var(--transition-fast);
            cursor: default;
        }

        .tag-pill:hover {
            background: var(--primary-alpha-20);
            transform: scale(1.05);
        }

        .tag-remove {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 0;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            transition: all var(--transition-fast);
        }

        .tag-remove:hover {
            background: var(--primary);
            color: white;
        }

        .tag-add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--divider);
            color: var(--text-tertiary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all var(--transition-fast);
        }

        .tag-add-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .tag-input-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tag-input-popup.active {
            display: flex;
        }

        .tag-input-content {
            background: var(--card);
            border-radius: var(--radius-large);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-high);
        }

        .tag-input-header {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .tag-input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-medium);
            font-size: var(--font-size-base);
            margin-bottom: 16px;
            transition: all var(--transition-fast);
        }

        .tag-input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-alpha-10);
        }

        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tag-suggestion {
            background: var(--background);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid var(--border);
        }

        .tag-suggestion:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .tag-input-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Tag filter in Data tab */
        .tag-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: var(--background);
            border-radius: var(--radius-medium);
        }

        .tag-filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 2px solid transparent;
        }

        .tag-filter-pill:hover {
            border-color: var(--primary);
        }

        .tag-filter-pill.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ====================================
           MANUAL ENTRY MODAL
           Form for adding expenses manually
           ==================================== */

        .manual-entry-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .manual-entry-modal.active {
            display: flex;
        }

        .manual-entry-content {
            background: var(--card);
            border-radius: var(--radius-large);
            padding: 32px;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-high);
            max-height: 90vh;
            overflow-y: auto;
        }

        .manual-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .manual-entry-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .manual-entry-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .manual-entry-close:hover {
            background: var(--background);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: var(--font-size-xs);  /* Smaller labels to save space */
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);  /* Lighter color, less prominent */
            margin-bottom: 6px;
            text-transform: uppercase;  /* Small caps for professional look */
            letter-spacing: 0.5px;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--error-red);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 14px 16px;  /* Increased padding for better touch targets */
            border: 2px solid #F3F4F6;  /* Light gray border (border-gray-100 equivalent) */
            border-radius: var(--radius-medium);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: all var(--transition-base);
            background: var(--card);
            color: var(--text-primary);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #60A5FA;  /* Blue-400 equivalent */
            border-width: 3px;  /* Thicker border on focus */
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);  /* Blue glow */
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-hint {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .form-buttons button {
            flex: 1;
        }

        /* ====================================
           CATEGORY PILLS
           Horizontal scrolling category selector
           ==================================== */

        .category-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 80px;
            flex-shrink: 0;
        }

        .category-pill:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .category-pill.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .category-pill.selected span:last-child {
            color: white;
        }

        .category-pill span:last-child {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        /* ====================================
           CUSTOM NUMERIC KEYPAD
           Finance app-style number input
           ==================================== */

        .keypad-btn {
            padding: 20px;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 24px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
        }

        .keypad-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .keypad-btn:active {
            transform: scale(0.95);
            background: var(--primary);
            color: white;
        }

        .keypad-backspace {
            background: var(--expense-red);
            color: white;
            border-color: var(--expense-red);
        }

        .keypad-backspace:hover {
            background: #C92A35;
        }

        @media (max-width: 768px) {
            .manual-entry-content {
                padding: 0;
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
            }

            .manual-entry-title {
                font-size: var(--font-size-xl);
            }

            .keypad-btn {
                padding: 16px;
                font-size: 20px;
            }
        }

        /* ====================================
           INTERACTIVE CHART ELEMENTS
           Hover states and click interactions
           ==================================== */

        .donut-segment {
            cursor: pointer;
            transition: opacity var(--transition-fast);
        }

        .donut-segment:hover {
            opacity: 0.8;
            filter: brightness(1.1);
        }

        .donut-segment.selected {
            opacity: 1;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .legend-item {
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: 8px;
            border-radius: 8px;
        }

        .legend-item:hover {
            background: var(--primary-alpha-10);
        }

        .legend-item.selected {
            background: var(--primary-alpha-20);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .category-spending-card {
            cursor: pointer;
        }

        /* Category Detail Modal */
        .category-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .category-modal.active {
            display: flex;
        }

        .category-modal-content {
            background: var(--card);
            border-radius: var(--radius-large);
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-high);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .category-modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--divider);
        }

        .category-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-tertiary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .category-modal-close:hover {
            background: var(--background);
            color: var(--text-primary);
        }

        .category-detail-item {
            padding: 12px;
            border-radius: 12px;
            background: var(--background);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tab {
            flex: 1;
            padding: 10px 4px;
            background: transparent;
            border: none;
            border-radius: var(--radius-medium);
            color: var(--text-tertiary);
            font-size: 10px;
            font-weight: var(--font-weight-medium);
            text-transform: capitalize;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            position: relative;
        }

        .nav-tab:hover:not(.active) {
            color: var(--text-secondary);
            background: var(--teal-alpha-10);
        }

        .nav-tab.active {
            color: var(--teal-primary);  /* Premium Airy Teal */
        }

        /* Teal dot indicator underneath active icon */
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background: var(--teal-primary);
            border-radius: 50%;
        }

        /* Icon styling for nav tabs */
        .nav-tab .nav-icon {
            font-size: 20px;
            line-height: 1;
        }

        /* Content sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Component - Premium Airy Design */
        .card {
            background: #FFFFFF;                     /* Pure white for Premium Airy */
            border-radius: var(--radius-large);      /* 24px per spec */
            padding: 20px;                           /* Minimum 20px padding per spec */
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04); /* Subtle shadow for Airy */
            transition: all var(--transition-base);
            border: 1px solid var(--border-light);   /* Light border for Premium Airy */
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        /* Balance Card with Gradient */
        .balance-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-medium);
        }

        .balance-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: var(--spacing-sm);
        }

        .balance-amount {
            font-size: 40px;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -1px;
            margin-bottom: var(--spacing-lg);
        }

        /* Stats Grid - Financial Hub Style */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: #FFFFFF;                     /* Pure white for Premium Airy */
            padding: 20px;                           /* Minimum 20px padding */
            border-radius: var(--radius-large);      /* 24px per spec */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04); /* Subtle shadow for Airy */
            transition: all var(--transition-bounce);
            border: 1px solid var(--border-light);   /* Light border for Premium Airy */
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-high);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-round);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: var(--spacing-md);
        }

        .stat-card:nth-child(1) .stat-icon {
            background: var(--primary-alpha-10);
            color: var(--primary);
        }

        .stat-card:nth-child(2) .stat-icon {
            background: var(--primary-alpha-10);
            color: var(--info-blue);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: rgba(244, 162, 97, 0.1);
            color: var(--warning-yellow);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.8px;
        }

        /* Upload Zone - Financial Hub Style */
        .upload-zone {
            border: 2px dashed rgba(91, 168, 159, 0.3);
            border-radius: 20px;
            padding: var(--spacing-3xl) var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(91, 168, 159, 0.03) 0%, rgba(91, 168, 159, 0.08) 100%);
            position: relative;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(91, 168, 159, 0.1) 0%, rgba(91, 168, 159, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-zone:hover::before {
            opacity: 1;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(91, 168, 159, 0.15);
        }

        .upload-zone:active {
            transform: translateY(0) scale(0.98);
        }

        .upload-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius-large);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto var(--spacing-md);
            box-shadow: var(--shadow-primary);
            transition: all var(--transition-bounce);
        }

        .upload-zone:hover .upload-icon {
            transform: translateY(-6px) rotate(5deg);
            box-shadow: var(--shadow-high);
        }

        .upload-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .upload-subtitle {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        /* Button Component - Modern Minimalist Design */
        .btn {
            /* Layout */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--spacing-xl);  /* Horizontal padding only */
            height: 56px;  /* Fixed height for all primary buttons */
            min-height: 56px;

            /* Appearance */
            background: var(--primary);
            color: var(--text-on-primary);
            border: none;
            border-radius: 9999px;  /* Fully rounded (rounded-full) */
            box-shadow: var(--shadow-primary);

            /* Typography */
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);  /* Bolder for primary actions */

            /* Interaction */
            cursor: pointer;
            transition: all var(--transition-base);  /* Subtle hover transition per spec */
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ripple effect on click */
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        /* Hover state - subtle transition */
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-high);
        }

        /* Active/pressed state */
        .btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-primary);
        }

        /* Disabled state */
        .btn:disabled {
            background: var(--text-disabled);
            color: var(--text-tertiary);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Secondary button variant */
        .btn-secondary {
            background: var(--card);
            color: var(--primary);
            border: 2px solid #F3F4F6;  /* Matches form inputs */
            box-shadow: var(--shadow-soft);
            height: 56px;  /* Same height as primary buttons */
            min-height: 56px;
        }

        .btn-secondary:hover {
            background: var(--primary-light);
            border-color: #60A5FA;  /* Blue-400 on hover */
            border-width: 3px;  /* Thicker on hover */
        }

        /* Global button styles */
        button {
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-base);
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            transform: scale(0.98);
        }

        /* Interactive chart area */
        .chart-container {
            position: relative;
            height: 320px;
            margin: 24px 0;
            padding: 20px;
            background: rgba(247,249,252,0.5);
            border-radius: 20px;
        }

        /* Item list with hover effects */
        .item-list {
            margin-top: 24px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: rgba(247,249,252,0.6);
            border: 1px solid rgba(0,0,0,0.02);
        }

        .item:hover {
            background: white;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: rgba(91, 168, 159, 0.1);
        }

        .item:active {
            transform: translateX(2px) scale(0.99);
        }

        .item-name {
            font-weight: 600;
            color: var(--dark);
            flex: 2;
        }

        .item-category {
            flex: 1;
            color: var(--primary);
            font-size: 0.9em;
            font-weight: 500;
        }

        .item-price {
            font-family: 'Fraunces', serif;
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1em;
        }

        /* Loading animation */
        .loading {
            text-align: center;
            padding: 48px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.1em;
            font-weight: 600;
        }

        /* Receipt preview */
        .receipt-preview {
            max-width: 100%;
            max-height: 400px;
            margin: 24px auto;
            display: block;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        /* Data table */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        thead tr {
            background: var(--light);
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 12px;
        }

        th:hover {
            background: var(--primary);
            color: white;
        }

        tbody tr {
            background: white;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        tbody tr:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        td {
            padding: 16px;
            border-top: 1px solid var(--light);
            border-bottom: 1px solid var(--light);
        }

        td:first-child {
            border-left: 1px solid var(--light);
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        td:last-child {
            border-right: 1px solid var(--light);
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        /* Search and filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="url"],
        select {
            flex: 1;
            padding: 12px var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-medium);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--white);
            color: var(--text-primary);
            min-height: 48px;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="url"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-alpha-10);
        }

        input::placeholder {
            color: var(--text-tertiary);
        }

        /* Expandable Receipt Cards */
        .expandable {
            margin-bottom: var(--spacing-md);
            border-radius: var(--radius-large);      /* 16px per spec */
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow-soft);          /* Soft shadow per spec */
            transition: all var(--transition-bounce);
            border: 1px solid var(--border);
        }

        .expandable:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .expandable-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light);
            transition: all 0.3s ease;
        }

        .expandable-header:hover {
            background: white;
        }

        .expandable-header.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .expandable-title {
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .expandable-content.expanded {
            max-height: 2000px;
        }

        .expandable-body {
            padding: 20px;
        }

        /* Close button */
        .close-btn {
            background: var(--light);
            color: var(--dark);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
            animation: float 3s infinite ease-in-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                max-width: 100%;
                padding: 16px;
                padding-bottom: 90px; /* Space for floating bottom nav on mobile */
                margin: 0;
            }

            h1 {
                font-size: 1.6em;
                margin: 12px 0 8px 0;
                text-align: center;
                letter-spacing: -0.5px;
            }

            .tagline {
                display: none;
            }

            /* Floating pill navigation stays consistent on mobile */
            .nav-tabs {
                bottom: 12px;  /* Slightly closer on mobile */
                left: 12px;
                right: 12px;
                padding: 10px 6px;
            }

            .nav-tab {
                padding: 8px 2px;
                font-size: 9px;
                gap: 3px;
            }

            .nav-tab .nav-icon {
                font-size: 18px;
            }

            .card {
                margin-bottom: 20px;
                padding: 20px;
                border-radius: 16px;
            }

            .card-title {
                font-size: 1.25em;
                margin-bottom: 20px;
                letter-spacing: -0.3px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 28px;
            }

            .upload-zone {
                padding: 40px 20px;
                margin: 16px 0;
            }

            .upload-icon {
                font-size: 3em;
            }

            .upload-title {
                font-size: 1.2em;
            }

            /* Analytics charts mobile responsive */
            .chart-container {
                padding: 16px;
                margin-bottom: 16px;
            }

            .chart-title {
                font-size: var(--font-size-base);
                margin-bottom: 16px;
            }

            .donut-chart-wrapper {
                max-width: 240px;
                margin-bottom: 16px;
            }

            .donut-total-amount {
                font-size: 24px;
            }

            .time-toggle {
                padding: 4px;
                margin-bottom: 16px;
            }

            .time-toggle-btn {
                padding: 8px 16px;
                font-size: var(--font-size-xs);
            }

            .legend-item {
                gap: 8px;
                padding: 6px;
                font-size: var(--font-size-xs);
            }

            .area-chart-wrapper {
                height: 200px;
            }

            .upload-subtitle {
                font-size: 0.9em;
            }

            /* Make buttons larger for touch */
            button {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 1em;
            }

            /* Receipt cards more compact on mobile */
            .expandable-header {
                padding: 14px;
                font-size: 0.95em;
            }
        }

        /* Input file hidden */
        input[type="file"] {
            display: none;
        }

        /* Batch processing */
        .batch-container {
            margin-top: 24px;
        }

        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .batch-progress {
            background: var(--light);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .batch-progress-bar {
            height: 100%;
            background: var(--teal-primary);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .receipt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .receipt-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .receipt-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .receipt-card.processing {
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.3);
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.3);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(78, 205, 196, 0.5);
            }
        }

        .receipt-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .receipt-status {
            padding: 12px;
            font-size: 0.85em;
        }

        .receipt-progress-wrapper {
            padding: 0 12px 12px 12px;
        }

        .receipt-mini-progress {
            height: 4px;
            background: var(--light);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .receipt-mini-progress-bar {
            height: 100%;
            background: var(--teal-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .receipt-details {
            padding: 0 12px 8px 12px;
            font-size: 0.8em;
            color: #666;
            min-height: 40px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85em;
        }

        .status-pending {
            background: #FFF3CD;
            color: #856404;
        }

        .status-uploading {
            background: #E7F3FF;
            color: #0066CC;
            animation: pulse 1.5s infinite;
        }

        .status-processing {
            background: #D1ECF1;
            color: #0C5460;
            animation: pulse 1.5s infinite;
        }

        .status-analyzing {
            background: #E8DAFF;
            color: #6A1B9A;
            animation: pulse 1.5s infinite;
        }

        .status-done {
            background: #D4EDDA;
            color: #155724;
        }

        .status-error {
            background: #F8D7DA;
            color: #721C24;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        @keyframes receiptFloat {
            0%, 100% { transform: translate(-50%, -50%) rotate(-2deg); }
            50% { transform: translate(-50%, -55%) rotate(2deg); }
        }

        @keyframes scanMove {
            0% { top: 15%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 85%; opacity: 0; }
        }

        @keyframes scanLine {
            0%, 100% { opacity: 0.3; transform: scaleX(0.8); }
            50% { opacity: 1; transform: scaleX(1); }
        }

        .batch-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        /* Transaction List Items - Financial Hub Style */
        .item,
        .history-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border-radius: var(--radius-medium);
            margin-bottom: var(--spacing-sm);
            transition: background 0.2s ease;
            min-height: 72px;
        }

        .item:hover,
        .history-item:hover {
            background: var(--background);
        }

        .item-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-round);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .item-category {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .item-price {
            font-size: 16px;
            font-weight: 600;
            margin-left: var(--spacing-md);
            white-space: nowrap;
        }

        .item-price.negative {
            color: var(--expense-red);
        }

        .item-price.positive {
            color: var(--income-green);
        }

        /* Summary box */
        .summary-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: var(--spacing-lg);
            border-radius: var(--radius-large);
            color: var(--white);
            font-weight: 600;
            margin-top: var(--spacing-lg);
            box-shadow: var(--shadow-medium);
        }

        /* User Status & Dropdown Menu */
        #user-status {
            position: relative;
        }

        #user-status .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--card);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-high);
            min-width: 220px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-base);
            z-index: var(--z-dropdown);
        }

        #user-status .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu .menu-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-menu .menu-item:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .dropdown-menu .menu-item.danger {
            color: var(--expense-red);
        }

        .dropdown-menu .menu-item.danger:hover {
            background: rgba(230, 57, 70, 0.1);
        }

        .dropdown-menu .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        .dropdown-menu .menu-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Dark Mode - Financial Hub */
        body.dark-mode {
            background: #121416;
            color: #e8e9ed;
        }

        body.dark-mode .card {
            background: #1e2024;
            border-color: #2a2d33;
        }

        body.dark-mode .balance-card {
            background: linear-gradient(135deg, #478A82 0%, #3a6f69 100%);
        }

        body.dark-mode .card-title,
        body.dark-mode h1 {
            color: #f5f5f7;
        }

        body.dark-mode .tagline,
        body.dark-mode .stat-label,
        body.dark-mode .item-category {
            color: #8a8d94;
        }

        body.dark-mode .nav-tabs {
            background: #1e2024;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .nav-tab {
            color: #8a8d94;
        }

        body.dark-mode .nav-tab:hover:not(.active) {
            background: rgba(45, 156, 219, 0.15);
        }

        body.dark-mode .nav-tab.active {
            color: var(--primary);
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="url"],
        body.dark-mode select {
            background: #121416;
            border-color: #2a2d33;
            color: #e8e9ed;
        }

        body.dark-mode .item,
        body.dark-mode .history-item,
        body.dark-mode tbody tr {
            background: transparent;
        }

        body.dark-mode .item:hover,
        body.dark-mode .history-item:hover {
            background: #1a1d21;
        }

        body.dark-mode .stat-card {
            background: #1e2024;
            border-color: #2a2d33;
        }

        body.dark-mode .stat-value,
        body.dark-mode .item-name,
        body.dark-mode td {
            color: #f5f5f7;
        }

        body.dark-mode .expandable {
            background: #1a1d21;
        }

        body.dark-mode .expandable-header {
            background: #1e2024;
        }

        body.dark-mode th {
            background: #1e2024;
            color: #f5f5f7;
        }

        body.dark-mode .upload-zone {
            background: #1e2024;
            border-color: #2a2d33;
        }

        body.dark-mode #user-status .user-badge {
            background: #1e2024;
            border-color: #2a2d33;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: var(--white);
            border-radius: var(--radius-medium);
            padding: 16px 20px;
            box-shadow: var(--shadow-high);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            min-width: 300px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }

        .toast.success {
            border-left-color: var(--income-green);
        }

        .toast.error {
            border-left-color: var(--expense-red);
        }

        .toast.warning {
            border-left-color: var(--warning-yellow);
        }

        .toast.info {
            border-left-color: var(--info-blue);
        }

        .toast-icon {
            font-size: 24px;
            line-height: 1;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0;
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: var(--background);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        @media (max-width: 768px) {
            #toast-container {
                top: auto;
                bottom: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }

            .toast {
                min-width: auto;
            }

            @keyframes slideInRight {
                from {
                    transform: translateY(100px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            @keyframes slideOutRight {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(100px);
                    opacity: 0;
                }
            }
        }

        /* Drag and Drop Styles */
        .upload-zone {
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-zone.drag-over {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .upload-zone.drag-over::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 3px dashed var(--primary);
            border-radius: var(--radius-xlarge);
            animation: dashAnimation 1s linear infinite;
        }

        @keyframes dashAnimation {
            to {
                stroke-dashoffset: 20;
            }
        }

        /* Bounce animation for celebrations */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            25% {
                transform: translateY(-20px) scale(1.1);
            }
            50% {
                transform: translateY(0) scale(1);
            }
            75% {
                transform: translateY(-10px) scale(1.05);
            }
        }

        /* Confetti animation */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            top: -10px;
            animation: confetti-fall 3s linear;
            pointer-events: none;
            z-index: 9999;
        }

        /* Skeleton Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
            border-radius: 6px;
        }

        .skeleton-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .skeleton-stat {
            background: white;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .skeleton-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Savings Goal Modal -->
    <div id="goalModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 20px;">
        <div class="card" style="max-width: 500px; width: 100%; margin: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="card-title" style="margin: 0;">Set Savings Goal</h2>
                <button onclick="closeGoalModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);"></button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Monthly Savings Target (kr)</label>
                <input type="number" id="goalTargetInput" placeholder="500" min="1" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 16px;">
                <p style="color: var(--text-secondary); font-size: 0.85em; margin-top: 4px;">How much do you want to save in discounts this month?</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveGoal()" style="flex: 1;"><span>Set Goal</span></button>
                <button class="btn btn-secondary" onclick="closeGoalModal()" style="flex: 1;"><span>Cancel</span></button>
            </div>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 20px;">
        <div class="card" style="max-width: 500px; width: 100%; margin: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="card-title" style="margin: 0;">Set Category Budget</h2>
                <button onclick="closeBudgetModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);"></button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Category</label>
                <select id="budgetCategoryInput" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 16px;">
                    <option value="">Select a category...</option>
                    <option value="Groceries">Groceries</option>
                    <option value="Dining">Dining</option>
                    <option value="Transport">Transport</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Household">Household</option>
                    <option value="Personal Care">Personal Care</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Monthly Limit (kr)</label>
                <input type="number" id="budgetLimitInput" placeholder="1500" min="1" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 16px;">
                <p style="color: var(--text-secondary); font-size: 0.85em; margin-top: 4px;">Maximum amount to spend in this category each month</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveBudget()" style="flex: 1;"><span>Set Budget</span></button>
                <button class="btn btn-secondary" onclick="closeBudgetModal()" style="flex: 1;"><span>Cancel</span></button>
            </div>
        </div>
    </div>

    <!-- Category Detail Modal -->
    <div id="categoryModal" class="category-modal">
        <div class="category-modal-content">
            <button class="category-modal-close" onclick="closeCategoryModal()"></button>

            <div class="category-modal-header">
                <div class="category-icon-circle" id="modalCategoryIcon" style="width: 56px; height: 56px; font-size: 28px;">
                    
                </div>
                <div>
                    <h2 class="card-title" style="margin: 0;" id="modalCategoryName">Category</h2>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);" id="modalCategoryPeriod">This week</div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                <div style="text-align: center; padding: 16px; background: var(--background); border-radius: 12px;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Total Spent</div>
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--primary);" id="modalCategoryTotal">0 kr</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--background); border-radius: 12px;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Transactions</div>
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--expense-red);" id="modalCategoryCount">0</div>
                </div>
            </div>

            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: 16px;">All Items</h3>
            <div id="modalCategoryItems">
                <!-- Items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Tag Input Modal -->
    <div id="tagInputPopup" class="tag-input-popup">
        <div class="tag-input-content">
            <h3 class="tag-input-header">Add Tags</h3>
            <p style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: 16px;">
                Add tags to organize and categorize this item
            </p>

            <input
                type="text"
                id="tagInputField"
                class="tag-input-field"
                placeholder="Enter tag name..."
                onkeypress="if(event.key==='Enter') addTagFromInput()"
            />

            <div style="margin-bottom: 12px;">
                <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 8px; text-transform: uppercase;">Quick suggestions:</div>
                <div class="tag-suggestions" id="tagSuggestions">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>

            <div class="tag-input-buttons">
                <button class="btn btn-secondary" onclick="closeTagInputPopup()">
                    <span>Cancel</span>
                </button>
                <button class="btn" onclick="addTagFromInput()">
                    <span>Add Tag</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal - Redesigned Finance App Style -->
    <div id="manualEntryModal" class="manual-entry-modal">
        <div class="manual-entry-content" style="max-width: 480px; height: 100%; display: flex; flex-direction: column; background: var(--background);">

            <!-- Header -->
            <div style="padding: 20px 24px; background: white; border-bottom: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between;">
                <h2 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary); margin: 0;">Add Expense</h2>
                <button onclick="closeManualEntryModal()" style="width: 32px; height: 32px; border-radius: 50%; background: var(--background); border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);"></button>
            </div>

            <form id="manualEntryForm" onsubmit="submitManualEntry(event)" style="flex: 1; display: flex; flex-direction: column; overflow-y: auto;">

                <!-- Amount Input (Primary Focus - Large, Centered, Blue) -->
                <div style="padding: 32px 24px; background: white; text-align: center; border-bottom: 1px solid var(--divider);">
                    <div style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-bottom: 8px; font-weight: var(--font-weight-medium);">AMOUNT</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <input
                            type="text"
                            id="manualAmount"
                            placeholder="0"
                            inputmode="decimal"
                            style="
                                font-size: 56px;
                                font-weight: var(--font-weight-bold);
                                color: var(--primary);
                                border: none;
                                outline: none;
                                text-align: center;
                                width: auto;
                                min-width: 100px;
                                max-width: 300px;
                                background: transparent;
                                font-family: var(--font-family);
                            "
                            required
                        >
                        <span style="font-size: 32px; font-weight: var(--font-weight-semibold); color: var(--primary); margin-top: 12px;">kr</span>
                    </div>
                </div>

                <!-- Details Card (White card with grouped fields) -->
                <div style="padding: 24px; flex: 1;">
                    <div style="background: white; border-radius: 24px; padding: 24px; box-shadow: var(--shadow-soft);">

                        <!-- Description -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 6px; font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px;">DESCRIPTION</label>
                            <input
                                type="text"
                                id="manualItem"
                                placeholder="e.g., Lunch, Coffee, Groceries"
                                style="
                                    width: 100%;
                                    padding: 14px 16px;
                                    border: 2px solid #F3F4F6;
                                    border-radius: 12px;
                                    font-size: var(--font-size-base);
                                    outline: none;
                                    transition: all var(--transition-base);
                                    font-family: var(--font-family);
                                "
                                onfocus="this.style.borderColor='#60A5FA'; this.style.borderWidth='3px'"
                                onblur="this.style.borderColor='#F3F4F6'; this.style.borderWidth='2px'"
                                required
                            >
                        </div>

                        <!-- Store/Vendor -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 6px; font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px;">STORE/VENDOR</label>
                            <input
                                type="text"
                                id="manualStore"
                                placeholder="e.g., ICA, Willys, Restaurant"
                                style="
                                    width: 100%;
                                    padding: 14px 16px;
                                    border: 2px solid #F3F4F6;
                                    border-radius: 12px;
                                    font-size: var(--font-size-base);
                                    outline: none;
                                    transition: all var(--transition-base);
                                    font-family: var(--font-family);
                                "
                                onfocus="this.style.borderColor='#60A5FA'; this.style.borderWidth='3px'"
                                onblur="this.style.borderColor='#F3F4F6'; this.style.borderWidth='2px'"
                                required
                            >
                        </div>

                        <!-- Category Pills (Horizontal Scrolling) -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 12px; font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px;">CATEGORY</label>
                            <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none;">
                                <button type="button" class="category-pill" data-category="Groceries" onclick="selectCategory('Groceries', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Groceries</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Dining" onclick="selectCategory('Dining', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Dining</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Transport" onclick="selectCategory('Transport', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Transport</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Entertainment" onclick="selectCategory('Entertainment', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Entertainment</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Shopping" onclick="selectCategory('Shopping', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Shopping</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Healthcare" onclick="selectCategory('Healthcare', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Healthcare</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Household" onclick="selectCategory('Household', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Household</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Personal Care" onclick="selectCategory('Personal Care', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Personal</span>
                                </button>
                                <button type="button" class="category-pill" data-category="Other" onclick="selectCategory('Other', this)">
                                    <span style="font-size: 20px;"></span>
                                    <span>Other</span>
                                </button>
                            </div>
                            <input type="hidden" id="manualCategory" required>
                        </div>

                        <!-- Date -->
                        <div>
                            <label style="display: block; font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 6px; font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px;">DATE</label>
                            <input
                                type="date"
                                id="manualDate"
                                style="
                                    width: 100%;
                                    padding: 14px 16px;
                                    border: 2px solid #F3F4F6;
                                    border-radius: 12px;
                                    font-size: var(--font-size-base);
                                    outline: none;
                                    transition: all var(--transition-base);
                                    font-family: var(--font-family);
                                "
                                onfocus="this.style.borderColor='#60A5FA'; this.style.borderWidth='3px'"
                                onblur="this.style.borderColor='#F3F4F6'; this.style.borderWidth='2px'"
                                required
                            >
                        </div>

                    </div>
                </div>

                <!-- Custom Numeric Keypad -->
                <div id="customKeypad" style="background: white; border-top: 1px solid var(--divider); padding: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <button type="button" class="keypad-btn" onclick="appendNumber('1')">1</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('2')">2</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('3')">3</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('4')">4</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('5')">5</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('6')">6</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('7')">7</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('8')">8</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('9')">9</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('.')">.</button>
                    <button type="button" class="keypad-btn" onclick="appendNumber('0')">0</button>
                    <button type="button" class="keypad-btn keypad-backspace" onclick="backspaceNumber()"></button>
                </div>

                <!-- Save Button (Fixed at bottom) -->
                <div style="padding: 16px 24px; background: white; border-top: 1px solid var(--divider);">
                    <button
                        type="submit"
                        style="
                            width: 100%;
                            height: 56px;
                            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                            color: white;
                            border: none;
                            border-radius: 9999px;
                            font-size: var(--font-size-lg);
                            font-weight: var(--font-weight-bold);
                            cursor: pointer;
                            transition: all var(--transition-base);
                            box-shadow: var(--shadow-primary);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 30px rgba(45, 156, 219, 0.35)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-primary)'"
                    >
                        Save Expense
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- Level Up Celebration Modal -->
    <div id="levelUpModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; padding: 20px;">
        <div class="card" style="max-width: 400px; width: 100%; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: relative; overflow: hidden;">
            <div style="font-size: 80px; margin-bottom: 16px; animation: bounce 0.6s ease-in-out;"></div>
            <h2 style="color: white; font-size: 2em; margin-bottom: 8px;">Level Up!</h2>
            <div style="font-size: 3em; font-weight: 700; margin-bottom: 8px;">Level <span id="newLevelNumber">2</span></div>
            <div style="font-size: 1.3em; opacity: 0.9; margin-bottom: 24px;"><span id="newLevelName">Silver</span></div>
            <button class="btn" onclick="closeLevelUpModal()" style="background: white; color: #667eea;"><span>Awesome!</span></button>
        </div>
    </div>

    <!-- Goal Completed Modal -->
    <div id="goalCompletedModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; padding: 20px;">
        <div class="card" style="max-width: 400px; width: 100%; text-align: center;">
            <div style="font-size: 80px; margin-bottom: 16px; animation: bounce 0.6s ease-in-out;"></div>
            <h2 class="card-title" style="font-size: 2em; margin-bottom: 8px;">Goal Reached!</h2>
            <p style="font-size: 1.3em; margin-bottom: 8px;">You saved <strong><span id="goalAmountSaved">500</span> kr</strong> in discounts!</p>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">Great job hitting your savings target!</p>
            <button class="btn" onclick="closeGoalCompletedModal()"><span>Celebrate!</span></button>
        </div>
    </div>

    <div id="login-overlay" style="position: fixed; inset: 0; background: var(--background); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: var(--spacing-lg);">
        <div class="card" style="width: 100%; max-width: 420px; text-align: center; box-shadow: var(--shadow-medium); padding: var(--spacing-xl);">
            <div style="width: 64px; height: 64px; background: var(--primary); border-radius: var(--radius-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--spacing-lg); font-size: 32px;"></div>
            <h2 class="card-title" id="auth-title" style="margin-bottom: var(--spacing-sm); font-size: 24px;">Financial Hub</h2>
            <p style="margin-bottom: var(--spacing-xl); color: var(--text-tertiary); font-size: 14px;" id="auth-subtitle">Sign in to track your receipts and manage your budget</p>
            <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                <input type="email" id="email-input" placeholder="Email" style="width: 100%;">
                <input type="password" id="password-input" placeholder="Password" style="width: 100%;">
                <div style="display: flex; gap: var(--spacing-md);">
                    <button class="btn" id="signin-btn" onclick="signIn()" style="flex: 1;"><span>Sign In</span></button>
                    <button class="btn btn-secondary" id="signup-btn" onclick="signUp()" style="flex: 1;"><span>Sign Up</span></button>
                </div>
                <button onclick="forgotPassword()" style="background: none; border: none; color: var(--primary); text-decoration: underline; cursor: pointer; padding: var(--spacing-sm); font-size: 14px;">Forgot Password?</button>
                <button class="btn-secondary btn" onclick="continueAsGuest()" style="margin-top: var(--spacing-sm);"><span>Continue as Guest</span></button>
            </div>
        </div>
    </div>

    <!-- Receipt Scanner Component -->
    <div class="receipt-scanner" id="receiptScanner">
        <!-- Close Button -->
        <button class="close-scanner" onclick="closeScanner()"></button>

        <!-- Camera Viewfinder -->
        <div class="camera-viewfinder">
            <video id="cameraVideo" autoplay playsinline></video>

            <!-- Overlay with Focus Frame -->
            <div class="scanner-overlay">
                <div class="focus-frame">
                    <!-- Scanning Animation Line -->
                    <div class="scan-line"></div>
                </div>
            </div>

            <!-- Tip Box -->
            <div class="scanner-tip">
                 Align receipt within the frame for best results
            </div>

            <!-- Bottom Control Bar -->
            <div class="scanner-controls">
                <!-- Flash Toggle (Left) -->
                <button class="control-button" id="flashButton" onclick="toggleFlash()" title="Toggle Flash">
                    <span id="flashIcon"></span>
                </button>

                <!-- Shutter Button (Center) -->
                <button class="shutter-button" onclick="capturePhoto()" title="Capture Photo">
                    
                </button>

                <!-- Upload from Gallery (Right) -->
                <button class="control-button" onclick="openGallery()" title="Upload from Gallery">
                    
                </button>
            </div>

            <!-- Processing Overlay -->
            <div class="processing-overlay" id="processingOverlay">
                <div class="processing-spinner"></div>
                <div class="processing-text">Processing...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="home-header">
                <!-- Spendy Logo (Left) -->
                <div class="spendy-logo">
                    <span class="spendy-logo-icon"></span>
                    <span class="spendy-logo-text">Spendy</span>
                </div>

                <!-- Profile Chip (Right) - Logged In -->
                <div id="user-status" style="display: none;">
                    <div class="profile-chip" onclick="toggleUserMenu()">
                        <div class="profile-initial-circle" id="userAvatar">U</div>
                        <div class="profile-email-text" id="user-email">user@example.com</div>
                    </div>

                    <!-- Dropdown Menu -->
                    <div class="dropdown-menu" id="userDropdown">
                        <button class="menu-item" onclick="switchTab('account'); toggleUserMenu();">
                            <span class="menu-item-icon"></span>
                            Account Settings
                        </button>
                        <button class="menu-item" onclick="switchTab('dashboard'); toggleUserMenu();">
                            <span class="menu-item-icon"></span>
                            Dashboard
                        </button>
                        <div class="menu-divider"></div>
                        <button class="menu-item danger" onclick="logout(); toggleUserMenu();">
                            <span class="menu-item-icon"></span>
                            Sign Out
                        </button>
                    </div>
                </div>

                <!-- Guest Chip (Right) - Not Logged In -->
                <div id="guest-status" style="display: none;" class="guest-chip">
                    <span></span>
                    <span>Guest Mode</span>
                    <a class="login-link" onclick="showLoginModal()">Sign In</a>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('scan')">
                <span class="nav-icon"></span>
                <span>Scan</span>
            </button>
            <button class="nav-tab" onclick="switchTab('dashboard')">
                <span class="nav-icon"></span>
                <span>Dashboard</span>
            </button>
            <button class="nav-tab" onclick="switchTab('budgets')">
                <span class="nav-icon"></span>
                <span>Budgets</span>
            </button>
            <button class="nav-tab" onclick="switchTab('analytics')">
                <span class="nav-icon"></span>
                <span>Analytics</span>
            </button>
            <button class="nav-tab" onclick="switchTab('data')">
                <span class="nav-icon"></span>
                <span>Data</span>
            </button>
            <button class="nav-tab" onclick="switchTab('history')">
                <span class="nav-icon"></span>
                <span>Receipts</span>
            </button>
            <button class="nav-tab" id="account-tab" onclick="switchTab('account')">
                <span class="nav-icon"></span>
                <span>Account</span>
            </button>
        </nav>


        <!-- Scan Tab -->
        <div id="scan" class="tab-content active">
            <!-- Scan Options -->
            <div class="card">
                <h2 class="card-title">Add Expense</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Choose how you'd like to add your expense</p>

                <!-- Action Tiles Menu -->
                <div style="display: flex; flex-direction: column; gap: 16px;">

                    <!-- Primary Tile: Scan Receipt (Large, Blue) -->
                    <button
                        onclick="openScanner()"
                        style="
                            width: 100%;
                            padding: 32px 24px;
                            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                            border: none;
                            border-radius: 24px;
                            box-shadow: var(--shadow-soft), 0 4px 20px rgba(45, 156, 219, 0.25);
                            cursor: pointer;
                            transition: all var(--transition-base);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 12px;
                        "
                        onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-medium), 0 8px 30px rgba(45, 156, 219, 0.35)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-soft), 0 4px 20px rgba(45, 156, 219, 0.25)'"
                    >
                        <div style="font-size: 48px; line-height: 1;"></div>
                        <div style="color: white; font-size: var(--font-size-xl); font-weight: var(--font-weight-bold);">Scan Receipt</div>
                        <div style="color: rgba(255, 255, 255, 0.9); font-size: var(--font-size-sm);">Use your camera to scan instantly</div>
                    </button>

                    <!-- Secondary Tiles Row: Upload Options (Outline Style) -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <!-- Upload Photo Tile -->
                        <button
                            onclick="document.getElementById('fileInput').click()"
                            style="
                                padding: 24px 16px;
                                background: white;
                                border: 2px solid var(--border);
                                border-radius: 16px;
                                box-shadow: var(--shadow-low);
                                cursor: pointer;
                                transition: all var(--transition-base);
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 8px;
                            "
                            onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='var(--shadow-medium)'; this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='var(--shadow-low)'; this.style.transform='translateY(0)'"
                        >
                            <div style="font-size: 32px; line-height: 1;"></div>
                            <div style="color: var(--text-primary); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); text-align: center;">Upload Photo</div>
                            <div style="color: var(--text-tertiary); font-size: var(--font-size-xs); text-align: center;">From gallery</div>
                        </button>

                        <!-- Multiple Files Tile -->
                        <button
                            onclick="document.getElementById('fileInputMultiple').click()"
                            style="
                                padding: 24px 16px;
                                background: white;
                                border: 2px solid var(--border);
                                border-radius: 16px;
                                box-shadow: var(--shadow-low);
                                cursor: pointer;
                                transition: all var(--transition-base);
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 8px;
                            "
                            onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='var(--shadow-medium)'; this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='var(--shadow-low)'; this.style.transform='translateY(0)'"
                        >
                            <div style="font-size: 32px; line-height: 1;"></div>
                            <div style="color: var(--text-primary); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); text-align: center;">Multiple Files</div>
                            <div style="color: var(--text-tertiary); font-size: var(--font-size-xs); text-align: center;">Batch upload</div>
                        </button>
                    </div>

                    <!-- Divider -->
                    <div style="display: flex; align-items: center; gap: 16px; margin: 8px 0;">
                        <div style="flex: 1; height: 1px; background: var(--divider);"></div>
                        <span style="color: var(--text-tertiary); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">or</span>
                        <div style="flex: 1; height: 1px; background: var(--divider);"></div>
                    </div>

                    <!-- Manual Entry Tile (Soft Green Background) -->
                    <button
                        onclick="openManualEntryModal()"
                        style="
                            width: 100%;
                            padding: 24px;
                            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
                            border: 2px solid #86EFAC;
                            border-radius: 20px;
                            box-shadow: var(--shadow-soft);
                            cursor: pointer;
                            transition: all var(--transition-base);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 8px;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-medium)'; this.style.borderColor='#4ADE80'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-soft)'; this.style.borderColor='#86EFAC'"
                    >
                        <div style="font-size: 36px; line-height: 1;"></div>
                        <div style="color: #166534; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold);">Add Manually</div>
                        <div style="color: #15803D; font-size: var(--font-size-sm); text-align: center;">For cash purchases or when you don't have a receipt</div>
                    </button>

                </div>

                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;">
                <input type="file" id="fileInputMultiple" accept="image/*" multiple style="display: none;">

                <div id="processingArea" style="display: none;">
                    <img id="receiptPreview" class="receipt-preview">
                    <div id="loadingState" class="loading" style="display: none;">
                        <!-- Fun animated pending UI -->
                        <div style="text-align: center; padding: 40px 20px;">
                            <!-- Animated receipt icon -->
                            <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 24px;">
                                <div style="
                                    width: 80px;
                                    height: 100px;
                                    background: white;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                                    position: absolute;
                                    left: 50%;
                                    top: 50%;
                                    transform: translate(-50%, -50%);
                                    animation: receiptFloat 2s ease-in-out infinite;
                                ">
                                    <div style="padding: 12px 8px;">
                                        <div style="height: 6px; background: var(--teal-light); border-radius: 3px; margin-bottom: 8px; animation: scanLine 1.5s ease-in-out infinite;"></div>
                                        <div style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-bottom: 6px; width: 70%;"></div>
                                        <div style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-bottom: 6px; width: 90%;"></div>
                                        <div style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-bottom: 6px; width: 60%;"></div>
                                        <div style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-bottom: 6px; width: 80%;"></div>
                                        <div style="height: 4px; background: #e5e7eb; border-radius: 2px; width: 50%;"></div>
                                    </div>
                                </div>
                                <!-- Scanning effect -->
                                <div style="
                                    position: absolute;
                                    width: 100px;
                                    height: 3px;
                                    background: linear-gradient(90deg, transparent, var(--teal-primary), transparent);
                                    left: 50%;
                                    transform: translateX(-50%);
                                    animation: scanMove 2s ease-in-out infinite;
                                    border-radius: 2px;
                                    box-shadow: 0 0 10px var(--teal-primary);
                                "></div>
                            </div>

                            <!-- Fun rotating messages -->
                            <p class="loading-text" style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">AI is reading your receipt...</p>
                            <p id="funMessage" style="font-size: 14px; color: var(--text-secondary); min-height: 20px; transition: opacity 0.2s ease;"></p>

                            <!-- Pulsing dots -->
                            <div style="display: flex; justify-content: center; gap: 8px; margin-top: 24px;">
                                <div style="width: 10px; height: 10px; background: var(--teal-primary); border-radius: 50%; animation: pulse 1.4s ease-in-out infinite;"></div>
                                <div style="width: 10px; height: 10px; background: var(--teal-primary); border-radius: 50%; animation: pulse 1.4s ease-in-out 0.2s infinite;"></div>
                                <div style="width: 10px; height: 10px; background: var(--teal-primary); border-radius: 50%; animation: pulse 1.4s ease-in-out 0.4s infinite;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="resultsArea" style="display: none;">
                        <h3 style="margin-top: 24px; margin-bottom: 8px; font-size: 1.5em; font-weight: 700;">Review Your Receipt</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">Please verify the items and categories before saving</p>
                        <div id="itemsList" class="item-list"></div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button class="btn" onclick="saveReceipt()" style="flex: 1;"><span> Confirm & Save</span></button>
                            <button class="btn btn-secondary" onclick="cancelReceipt()" style="flex: 1;"><span> Cancel</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <!-- Premium Airy NetWorth Card -->
            <div class="card" style="padding: 0; border: none; box-shadow: var(--shadow-soft); margin-bottom: 24px; overflow: hidden;">
                <!-- Teal Gradient Top Section -->
                <div style="background: linear-gradient(135deg, var(--teal-primary) 0%, var(--teal-light) 100%); color: white; padding: 32px;">
                    <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); opacity: 0.9; margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase;">Net Worth</div>
                    <div style="font-size: 48px; font-weight: var(--font-weight-bold); line-height: 1; margin-bottom: 4px;" id="heroTotalSpent">0 kr</div>
                    <div style="font-size: var(--font-size-sm); opacity: 0.9;">Total spending tracked</div>
                </div>
                <!-- Pure White Bottom Section -->
                <div style="background: white; padding: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">This Month</div>
                            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--text-primary);"><span id="netWorthThisMonth">0</span> kr</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Saved</div>
                            <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--teal-primary);"><span id="netWorthSaved">0</span> kr</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Stats: Horizontal Row of Cards -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--text-secondary); margin-bottom: 16px;">Budget Stats</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Receipts</div>
                        <div class="stat-value" id="receiptCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Items</div>
                        <div class="stat-value" id="itemCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Saved</div>
                        <div class="stat-value" id="totalSavingsStat">0 kr</div>
                    </div>
                </div>
            </div>

            <!-- Progress & Level Card -->
            <div class="card" id="levelCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; backdrop-filter: blur(10px);">
                            
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 4px;">Your Progress</div>
                            <h2 style="color: white; margin: 0; font-size: 1.8em;">Level <span id="userLevel">1</span></h2>
                            <div style="font-size: 1em; opacity: 0.95; font-weight: 600; margin-top: 4px;" id="levelName">Bronze</div>
                        </div>
                    </div>
                    <div style="text-align: right; background: rgba(255,255,255,0.15); padding: 16px 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 4px;">Total XP</div>
                        <div style="font-size: 2.2em; font-weight: 700; line-height: 1;"><span id="totalXP">0</span></div>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 12px; backdrop-filter: blur(10px);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-size: 0.9em; opacity: 0.9;">Progress to Level <span id="nextLevel">2</span></span>
                        <span style="font-weight: 700;"><span id="xpProgressPercent">0</span>%</span>
                    </div>
                    <div style="width: 100%; height: 14px; background: rgba(0,0,0,0.2); border-radius: 7px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);">
                        <div id="xpProgressBar" style="width: 0%; height: 100%; background: var(--teal-primary); transition: width 0.5s ease; box-shadow: 0 0 10px rgba(90, 175, 181, 0.5);"></div>
                    </div>
                    <div style="text-align: center; opacity: 0.85; font-size: 0.85em; margin-top: 8px;"><span id="xpToNext">100</span> XP to next level</div>
                </div>
            </div>

            <!-- Savings Goal Card -->
            <div class="card" id="savingsGoalCard" style="display: none; background: linear-gradient(135deg, #10b98115 0%, #10b98105 100%); border-left: 4px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                            
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Monthly Goal</div>
                            <h2 class="card-title" style="margin: 0;">Savings Target</h2>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showGoalModal()" style="padding: 8px 16px; font-size: 0.9em;"><span>Edit</span></button>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Current Savings</div>
                            <div style="font-weight: 700; font-size: 2.2em; color: #10b981;"><span id="goalCurrent">0</span> kr</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Target</div>
                            <div style="font-weight: 600; font-size: 1.5em; color: var(--text-primary);"><span id="goalTarget">500</span> kr</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 16px; background: #f3f4f6; border-radius: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                        <div id="goalProgressBar" style="width: 0%; height: 100%; background: var(--teal-primary); transition: width 0.5s ease; box-shadow: 0 0 10px rgba(90, 175, 181, 0.3);"></div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div style="padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Progress</div>
                        <div style="font-weight: 700; font-size: 1.5em; color: #10b981;"><span id="goalProgressPercent">0</span>%</div>
                    </div>
                    <div style="padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Days Left</div>
                        <div style="font-weight: 700; font-size: 1.5em; color: var(--primary);"><span id="goalDaysRemaining">30</span></div>
                    </div>
                </div>
            </div>

            <!-- Create Goal Card (shown when no goal exists) -->
            <div class="card" id="createGoalCard">
                <h2 class="card-title">Set a Savings Goal</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Track your monthly discount savings and reach your target!</p>
                <button class="btn" onclick="showGoalModal()"><span>Create Savings Goal</span></button>
            </div>

            <!-- Quick Stats Card -->
            <div class="card">
                <h2 class="card-title">Quick Stats</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div style="padding: 20px; background: linear-gradient(135deg, #667eea15 0%, #667eea05 100%); border-radius: 12px; border-left: 4px solid #667eea;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                                
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); font-weight: 600;">This Month</div>
                        </div>
                        <div style="font-weight: 700; font-size: 2.5em; color: #667eea; line-height: 1;"><span id="receiptsThisMonth">0</span></div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">receipts scanned</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #10b98115 0%, #10b98105 100%); border-radius: 12px; border-left: 4px solid #10b981;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                                
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); font-weight: 600;">Total Saved</div>
                        </div>
                        <div style="font-weight: 700; font-size: 2.5em; color: #10b981; line-height: 1;"><span id="totalSavings">0</span> <span style="font-size: 0.5em;">kr</span></div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">from discounts</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #f59e0b15 0%, #f59e0b05 100%); border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                                
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); font-weight: 600;">Biggest Receipt</div>
                        </div>
                        <div style="font-weight: 700; font-size: 2.5em; color: #f59e0b; line-height: 1;"><span id="biggestReceipt">0</span> <span style="font-size: 0.5em;">kr</span></div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">personal record</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #ec489915 0%, #ec489905 100%); border-radius: 12px; border-left: 4px solid #ec4899;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #ec4899; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                                
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); font-weight: 600;">Best Discount</div>
                        </div>
                        <div style="font-weight: 700; font-size: 2.5em; color: #ec4899; line-height: 1;"><span id="biggestDiscount">0</span> <span style="font-size: 0.5em;">kr</span></div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">single receipt</div>
                    </div>
                </div>
            </div>

            <!-- Budget Overview Card -->
            <div class="card" id="budgetOverviewCard" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">Budget Overview</h2>
                    <button class="btn" onclick="showBudgetModal()" style="padding: 8px 16px; font-size: 0.9em;"><span>+ Add Budget</span></button>
                </div>

                <div id="budgetSummary" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Total Budget</div>
                            <div style="font-size: 2em; font-weight: 700;"><span id="totalBudget">0</span> kr</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Spent</div>
                            <div style="font-size: 2em; font-weight: 700;"><span id="totalSpent">0</span> kr</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(255,255,255,0.2); border-radius: 6px; overflow: hidden; margin-bottom: 12px;">
                        <div id="totalBudgetProgressBar" style="width: 0%; height: 100%; background: var(--teal-primary); transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                        <span><span id="totalRemaining">0</span> kr remaining</span>
                        <span><span id="budgetDaysLeft">30</span> days left</span>
                    </div>
                </div>

                <div id="categoryBudgets"></div>
            </div>

            <!-- Create Budget Card (shown when no budgets exist) -->
            <div class="card" id="createBudgetCard">
                <h2 class="card-title">Budget Your Spending</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Set monthly spending limits for different categories and track your progress in real-time!</p>
                <button class="btn" onclick="showBudgetModal()"><span>Create Your First Budget</span></button>
            </div>

            <!-- Category Spending Cards Grid -->
            <div class="card">
                <h2 class="card-title">Category Breakdown</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Your spending by category this month</p>
                <div id="categoryCardsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;"></div>
            </div>

            <!-- Enhanced Donut Chart -->
            <div class="card">
                <h2 class="card-title">Spending Distribution</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Interactive view of your spending  Click segments to explore</p>

                <!-- Insight Cards -->
                <div id="distributionInsights" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <!-- Populated by JS -->
                </div>

                <div class="chart-container" style="position: relative; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; padding: 20px;">
                    <canvas id="categoryChart"></canvas>
                    <div id="chartCenterText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                        <div style="font-size: 2.2em; font-weight: 700; color: var(--primary);" id="centerAmount">0 kr</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;" id="centerLabel">Total Spending</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Comparison Chart -->
            <div class="card">
                <h2 class="card-title">Spending Trends</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Compare your spending across months</p>

                <!-- Trend Insight Cards -->
                <div id="trendInsights" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <!-- Populated by JS -->
                </div>

                <div class="chart-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; padding: 20px;">
                    <canvas id="monthlyComparisonChart"></canvas>
                </div>
            </div>

            <div class="card" id="deepDiveCard" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 class="card-title" id="deepDiveTitle" style="margin: 0;">Category Deep Dive</h2>
                    <button class="close-btn" onclick="closeDeepDive()"> Close</button>
                </div>
                <div id="deepDiveDetails"></div>
            </div>

            <div class="card">
                <h2 class="card-title">Price Comparison</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Find the best deals across stores</p>
                <div id="priceComparison" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;"></div>
            </div>

            <div class="card">
                <h2 class="card-title">Top Items Tracker</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Your most frequent and expensive purchases</p>
                <div id="topItemsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                </div>
            </div>

            <!-- Recent Transactions: 5 Most Recent -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--text-secondary); margin-bottom: 16px;">Recent Transactions</h3>
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div id="recentTransactionsList">
                        <!-- Populated by JavaScript with 5 most recent -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Goals Tab -->
        <div id="budgets" class="tab-content">
            <!-- Budget Overview Hero Card -->
            <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--text-on-primary); border: none; box-shadow: var(--shadow-high); padding: 32px; margin-bottom: 24px;">
                <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); opacity: 0.9; margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase;">Budget Health</div>
                <div style="font-size: 48px; font-weight: var(--font-weight-bold); line-height: 1; margin-bottom: 4px;" id="budgetHealthScore">-</div>
                <div style="font-size: var(--font-size-sm); opacity: 0.85;" id="budgetHealthMessage">Set budgets to track your spending</div>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <button class="btn" onclick="showSmartRecommendations()" style="flex: 1;">
                    <span> Smart Recommendations</span>
                </button>
                <button class="btn btn-secondary" onclick="openBudgetModal('new')" style="flex: 1;">
                    <span>+ New Budget</span>
                </button>
            </div>

            <!-- Active Budgets Section -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--text-secondary); margin-bottom: 16px;">Active Budgets</h3>
                <div id="activeBudgetsGrid">
                    <!-- Budget cards will be inserted here -->
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-tertiary);">
                        <div style="font-size: 4em; margin-bottom: 16px; opacity: 0.3;"></div>
                        <h3 style="font-size: 1.3em; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">No budgets yet</h3>
                        <p style="font-size: 0.95em; margin-bottom: 24px;">Start by creating your first budget or use smart recommendations</p>
                    </div>
                </div>
            </div>

            <!-- Budget Alerts -->
            <div id="budgetAlertsSection" style="display: none; margin-bottom: 24px;">
                <h3 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--text-secondary); margin-bottom: 16px;"> Budget Alerts</h3>
                <div id="budgetAlertsList"></div>
            </div>

            <!-- Monthly Spending Summary -->
            <div class="card">
                <h3 class="card-title">This Month's Spending</h3>
                <div id="monthlySpendingSummary">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No data for this month yet</p>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <!-- Time Period Toggle -->
            <div class="time-toggle">
                <button class="time-toggle-btn active" id="toggle-week" onclick="setAnalyticsPeriod('week')">Week</button>
                <button class="time-toggle-btn" id="toggle-month" onclick="setAnalyticsPeriod('month')">Month</button>
                <button class="time-toggle-btn" id="toggle-year" onclick="setAnalyticsPeriod('year')">Year</button>
            </div>

            <!-- Donut Chart: Category Breakdown -->
            <div class="chart-container">
                <h3 class="chart-title">Spending by Category</h3>

                <div class="donut-chart-wrapper">
                    <svg class="donut-chart" viewBox="0 0 200 200" id="donutChart">
                        <!-- Chart will be rendered here by JavaScript -->
                    </svg>
                    <div class="donut-center">
                        <div class="donut-total-label">Total Spent</div>
                        <div class="donut-total-amount" id="donutTotalAmount">0 kr</div>
                    </div>
                </div>

                <!-- Category Legend -->
                <div class="category-legend" id="categoryLegend">
                    <!-- Legend items will be populated by JavaScript -->
                </div>
            </div>

            <!-- Area Chart: Spending Trend -->
            <div class="chart-container">
                <h3 class="chart-title">Spending Trend</h3>
                <div class="area-chart-wrapper">
                    <svg class="area-chart" id="areaChart" viewBox="0 0 800 280">
                        <!-- Chart will be rendered here by JavaScript -->
                    </svg>
                </div>
                <!-- Chart Tooltip -->
                <div class="chart-tooltip" id="chartTooltip"></div>
            </div>

            <!-- Quick Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 24px;">
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Avg per Day</div>
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--primary);" id="avgPerDay">0 kr</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Top Category</div>
                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary);" id="topCategory">-</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Transactions</div>
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--expense-red);" id="transactionCount">0</div>
                </div>
            </div>

            <!-- Top Spending Section -->
            <div style="margin-top: 32px;">
                <h3 class="chart-title">Top Spending Categories</h3>
                <div id="topSpendingList">
                    <!-- Category cards will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Data Tab -->
        <div id="data" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">All Transactions</h2>
                    <button class="btn" onclick="exportToCSV()" style="padding: 10px 20px;">
                        <span> Export CSV</span>
                    </button>
                </div>
                <div class="filters">
                    <input type="text" id="searchInput" placeholder=" Search items or stores...">
                    <select id="filterCategory" onchange="updateDataTable()">
                        <option value="">All Categories</option>
                    </select>
                </div>

                <!-- Tag Filter -->
                <div id="tagFilterContainer" class="tag-filter-container" style="display: none;">
                    <span style="font-size: var(--font-size-sm); color: var(--text-tertiary); margin-right: 8px;">Filter by tag:</span>
                    <div id="tagFilterPills"></div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('date')">Date </th>
                                <th onclick="sortTable('store')">Store </th>
                                <th onclick="sortTable('item')">Item </th>
                                <th onclick="sortTable('category')">Category </th>
                                <th onclick="sortTable('subcategory')">Subcategory </th>
                                <th>Tags</th>
                                <th onclick="sortTable('price')" style="text-align: right;">Price </th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="summary-box" id="dataTableSummary"></div>
            </div>

            <!-- AI Insight Card -->
            <div class="insight-card">
                <div class="insight-header">
                    <div class="insight-icon"></div>
                    <h3 class="insight-title">Smart Insights</h3>
                </div>
                <div class="insight-text" id="insightText">
                    Loading insights...
                </div>
                <span class="insight-badge">AI-Powered</span>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="card">
                <h2 class="card-title">My Receipts</h2>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Account Tab -->
        <div id="account" class="tab-content">
            <!-- Account Overview Card -->
            <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, #4a90e2 100%); color: white;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 700; color: var(--primary); box-shadow: 0 4px 16px rgba(0,0,0,0.2);" id="accountAvatar">U</div>
                    <div style="flex: 1;">
                        <div style="font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Your Account</div>
                        <h2 style="color: white; margin: 0 0 8px 0; font-size: 24px;" id="accountEmail">user@example.com</h2>
                        <div style="font-size: 14px; opacity: 0.9;" id="accountLevel">Level 1 - Bronze</div>
                    </div>
                </div>
            </div>

            <!-- Profile Settings -->
            <div class="card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(91, 168, 159, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
                    <div>
                        <h2 class="card-title" style="margin: 0;">Profile Settings</h2>
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0;">Customize your profile information</p>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Display Name</label>
                    <input type="text" id="display-name-input" placeholder="Your name" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid var(--border); font-size: 15px; transition: border-color 0.2s;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Profile Picture URL <span style="color: var(--text-tertiary); font-weight: 400;">(optional)</span></label>
                    <input type="url" id="profile-pic-input" placeholder="https://example.com/avatar.jpg" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid var(--border); font-size: 15px;">
                    <div id="profile-pic-preview" style="margin-top: 16px; display: none;">
                        <img id="profile-pic-img" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 4px solid white;">
                    </div>
                </div>
                <button class="btn" onclick="updateProfile()"><span> Save Profile</span></button>
            </div>

            <!-- Security Settings -->
            <div class="card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(74, 144, 226, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
                    <div>
                        <h2 class="card-title" style="margin: 0;">Security</h2>
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0;">Update your password</p>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">New Password</label>
                    <input type="password" id="account-new-password-input" placeholder="Minimum 6 characters" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid var(--border); font-size: 15px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Confirm New Password</label>
                    <input type="password" id="account-confirm-password-input" placeholder="Re-enter password" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid var(--border); font-size: 15px;">
                </div>
                <button class="btn" onclick="changePassword()"><span> Update Password</span></button>
            </div>

            <!-- Preferences -->
            <div class="card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(244, 162, 97, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
                    <div>
                        <h2 class="card-title" style="margin: 0;">Preferences</h2>
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0;">Customize your experience</p>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Currency</label>
                    <select id="currency-select" style="width: 100%; padding: 14px; border-radius: 10px; border: 2px solid var(--border); font-size: 15px; cursor: pointer;">
                        <option value="kr"> Swedish Krona (kr)</option>
                        <option value="$"> US Dollar ($)</option>
                        <option value=""> Euro ()</option>
                        <option value=""> British Pound ()</option>
                        <option value=""> Japanese Yen ()</option>
                        <option value=""> Indian Rupee ()</option>
                    </select>
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; font-size: 14px;">Theme</label>
                    <button class="btn" onclick="toggleDarkMode()" style="width: 100%;"><span id="theme-toggle-text"> Enable Dark Mode</span></button>
                </div>
                <button class="btn" onclick="savePreferences()"><span> Save Preferences</span></button>
            </div>

            <!-- Data Export -->
            <div class="card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(16, 185, 129, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
                    <div>
                        <h2 class="card-title" style="margin: 0;">Export Data</h2>
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0;">Download all your receipts and transaction data</p>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn" onclick="exportAllDataJSON()"><span> Export JSON</span></button>
                    <button class="btn" onclick="exportToCSV()"><span> Export CSV</span></button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card" style="border: 2px solid var(--expense-red); background: rgba(230, 57, 70, 0.02);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(230, 57, 70, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
                    <div>
                        <h2 class="card-title" style="color: var(--expense-red); margin: 0;">Danger Zone</h2>
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0;">Irreversible actions</p>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">Permanently delete your account and all associated data. This action cannot be undone.</p>
                <button class="btn" style="background: linear-gradient(135deg, #FF6B6B, #E63946); width: 100%;" onclick="deleteAccount()"><span> Delete Account</span></button>
            </div>
        </div>
    </div>

    <script>
        let currentReceipt = null;
        let allReceipts = [];
        let userPreferences = {
            currency: 'kr',
            darkMode: false,
            displayName: '',
            profilePic: ''
        };

        // ============ RECEIPT SCANNER CAMERA CONTROLS ============
        let cameraStream = null;
        let flashEnabled = false;

        async function openScanner() {
            const scanner = document.getElementById('receiptScanner');
            const video = document.getElementById('cameraVideo');

            try {
                // Request camera access with rear camera preference
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',  // Use rear camera on mobile
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                video.srcObject = cameraStream;
                scanner.classList.add('active');

                // Check if flash is available
                const track = cameraStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (!capabilities.torch) {
                    document.getElementById('flashButton').style.opacity = '0.5';
                    document.getElementById('flashButton').style.pointerEvents = 'none';
                }

                showToast('Camera ready!', 'success');
            } catch (error) {
                console.error('Camera access error:', error);
                showToast('Camera access denied. Please enable camera permissions.', 'error');
            }
        }

        function closeScanner() {
            const scanner = document.getElementById('receiptScanner');
            const video = document.getElementById('cameraVideo');

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            video.srcObject = null;
            scanner.classList.remove('active');
            flashEnabled = false;
            document.getElementById('flashButton').classList.remove('active');
        }

        async function toggleFlash() {
            if (!cameraStream) return;

            const track = cameraStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (!capabilities.torch) {
                showToast('Flash not available on this device', 'warning');
                return;
            }

            flashEnabled = !flashEnabled;

            try {
                await track.applyConstraints({
                    advanced: [{ torch: flashEnabled }]
                });

                const flashButton = document.getElementById('flashButton');
                if (flashEnabled) {
                    flashButton.classList.add('active');
                    showToast('Flash enabled', 'info');
                } else {
                    flashButton.classList.remove('active');
                    showToast('Flash disabled', 'info');
                }
            } catch (error) {
                console.error('Flash toggle error:', error);
                showToast('Failed to toggle flash', 'error');
            }
        }

        async function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const processingOverlay = document.getElementById('processingOverlay');

            if (!video.srcObject) {
                showToast('Camera not ready', 'error');
                return;
            }

            // Show processing overlay
            processingOverlay.classList.add('active');

            // Create canvas to capture frame
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Convert to blob
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    processingOverlay.classList.remove('active');
                    showToast('Failed to capture image', 'error');
                    return;
                }

                // Brief delay to show processing state
                await new Promise(resolve => setTimeout(resolve, 800));

                // Close scanner
                closeScanner();
                processingOverlay.classList.remove('active');

                // Create file from blob
                const file = new File([blob], 'receipt.jpg', { type: 'image/jpeg' });

                // Show processing UI
                document.getElementById('processingArea').style.display = 'block';
                const preview = document.getElementById('receiptPreview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';

                // Switch to scan tab to show results
                switchTab('scan');

                // Process the image
                await handleReceiptUpload(file);
            }, 'image/jpeg', 0.9);
        }

        function openGallery() {
            // Close scanner and open file picker
            closeScanner();
            document.getElementById('fileInput').click();
        }

        // ============ TOAST NOTIFICATION SYSTEM ============
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toast-container');

            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };

            const titles = {
                success: title || 'Success',
                error: title || 'Error',
                warning: title || 'Warning',
                info: title || 'Info'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()"></button>
            `;

            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ============ DRAG & DROP FUNCTIONALITY ============
        function initDragAndDrop() {
            const uploadZone = document.querySelector('.upload-zone');
            const fileInput = document.getElementById('fileInput');

            if (!uploadZone) return;

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight drop zone when dragging over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.remove('drag-over');
                }, false);
            });

            // Handle dropped files
            uploadZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            }, false);
        }

        // Initialize drag & drop when page loads
        document.addEventListener('DOMContentLoaded', initDragAndDrop);

        // ============ PROGRESS BAR FUNCTIONALITY ============
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-percentage');

            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = `${percentage}%`;
        }

        // Load saved data
        async function loadData() {
            try {
                // Check if window.storage is available (Claude.ai feature)
                if (typeof window.storage !== 'undefined' && window.storage) {
                    const result = await window.storage.get('receipts');
                    if (result && result.value) {
                        allReceipts = JSON.parse(result.value);
                        updateDashboard();
                        updateHistory();
                    }
                } else {
                    // Fallback to localStorage for deployed version
                    const stored = localStorage.getItem('spendy-receipts');
                    if (stored) {
                        allReceipts = JSON.parse(stored);
                        updateDashboard();
                        updateHistory();
                    }
                }
            } catch (error) {
                console.log('No saved data:', error);
                allReceipts = [];
            }
        }

        loadData();

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Find and activate the correct nav-tab button
            const navTab = document.querySelector(`.nav-tab[onclick*="'${tabName}'"]`);
            if (navTab) {
                navTab.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') updateDashboard();
            else if (tabName === 'budgets') updateBudgetGoalsUI();
            else if (tabName === 'analytics') updateAnalytics();
            else if (tabName === 'history') updateHistory();
            else if (tabName === 'data') updateDataTable();
            else if (tabName === 'account') updateAccountPage();
        }

        // Update account page with user info
        async function updateAccountPage() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;

            // Update account overview
            document.getElementById('accountEmail').textContent = user.email;
            const firstLetter = user.email.charAt(0).toUpperCase();
            document.getElementById('accountAvatar').textContent = firstLetter;

            // Get user progress for level display
            try {
                const { data: progressData } = await _supabase
                    .rpc('get_user_progress', { p_user_id: user.id });

                if (progressData && progressData.length > 0) {
                    const progress = progressData[0];
                    document.getElementById('accountLevel').textContent =
                        `Level ${progress.current_level} - ${progress.level_name}`;
                }
            } catch (error) {
                console.error('Error loading user level:', error);
                document.getElementById('accountLevel').textContent = 'Level 1 - Bronze';
            }
        }

        // Single file input (camera on mobile)
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate is image
            if (!file.type.startsWith('image/')) {
                alert('Please upload only image files');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                const imgData = event.target.result;
                document.getElementById('receiptPreview').src = imgData;
                document.getElementById('processingArea').style.display = 'block';
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('resultsArea').style.display = 'none';

                await analyzeReceipt(imgData);
            };
            reader.readAsDataURL(file);
        });

        // Multiple file input (batch upload)
        document.getElementById('fileInputMultiple').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // Validate all are images
            const invalidFiles = files.filter(f => !f.type.startsWith('image/'));
            if (invalidFiles.length > 0) {
                alert('Please upload only image files');
                return;
            }

            // Batch processing
            await processBatchReceipts(files);
        });

        async function processBatchReceipts(files) {
            document.getElementById('processingArea').style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'block';

            const batchResults = [];
            const itemsList = document.getElementById('itemsList');

            itemsList.innerHTML = `
                <div class="batch-container">
                    <div class="batch-header">
                        <h3 style="font-family: 'Fraunces', serif; font-size: 1.5em;">Processing ${files.length} Receipts</h3>
                        <span id="batchCounter" style="font-weight: 600; color: var(--primary);">0 / ${files.length}</span>
                    </div>
                    <div class="batch-progress">
                        <div class="batch-progress-bar" id="batchProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="receipt-grid" id="receiptGrid"></div>
                </div>
            `;

            const grid = document.getElementById('receiptGrid');
            const progressBar = document.getElementById('batchProgressBar');
            const counter = document.getElementById('batchCounter');

            // Create cards for each receipt
            const cardPromises = files.map((file, index) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const card = document.createElement('div');
                        card.className = 'receipt-card';
                        card.id = `receipt-${index}`;
                        card.innerHTML = `
                            <img src="${e.target.result}" alt="Receipt ${index + 1}">
                            <div class="receipt-status">
                                <span class="status-badge status-pending" id="status-${index}"> Pending</span>
                            </div>
                            <div class="receipt-progress-wrapper">
                                <div class="receipt-mini-progress">
                                    <div class="receipt-mini-progress-bar" id="progress-${index}"></div>
                                </div>
                            </div>
                            <div class="receipt-details" id="details-${index}">
                                Waiting in queue...
                            </div>
                        `;
                        grid.appendChild(card);
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            });

            // Wait for all cards to be created
            await Promise.all(cardPromises);

            // Process each receipt sequentially with detailed progress
            let completed = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const card = document.getElementById(`receipt-${i}`);
                const statusBadge = document.getElementById(`status-${i}`);
                const progressBar = document.getElementById(`progress-${i}`);
                const details = document.getElementById(`details-${i}`);

                // Add processing glow effect
                card.classList.add('processing');

                try {
                    // Stage 1: Loading image
                    statusBadge.className = 'status-badge status-uploading';
                    statusBadge.textContent = ' Uploading...';
                    progressBar.style.width = '20%';
                    details.textContent = 'Reading image data...';
                    await sleep(300);

                    const imgData = await readFileAsDataURL(file);

                    // Stage 2: Sending to AI
                    statusBadge.className = 'status-badge status-processing';
                    statusBadge.textContent = ' Sending to AI...';
                    progressBar.style.width = '40%';
                    details.textContent = 'Connecting to Claude AI...';
                    await sleep(300);

                    // Stage 3: AI Analyzing
                    statusBadge.className = 'status-badge status-analyzing';
                    statusBadge.textContent = ' Analyzing...';
                    progressBar.style.width = '60%';
                    details.textContent = 'AI is reading the receipt...';

                    const receiptData = await analyzeReceiptBatch(imgData, (stage) => {
                        // Real-time updates during analysis
                        if (stage === 'extracting') {
                            progressBar.style.width = '70%';
                            details.textContent = 'Extracting items and prices...';
                        } else if (stage === 'categorizing') {
                            progressBar.style.width = '85%';
                            details.textContent = 'Categorizing items...';
                        }
                    });

                    // Stage 4: Complete
                    progressBar.style.width = '100%';
                    details.textContent = `Found ${receiptData.items.length} items  ${receiptData.total ? receiptData.total.toFixed(2) + ' kr' : 'Total N/A'}`;

                    batchResults.push(receiptData);
                    statusBadge.className = 'status-badge status-done';
                    statusBadge.textContent = ` Complete`;

                    // Success animation
                    card.classList.remove('processing');
                    card.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        card.style.transform = 'scale(1)';
                    }, 300);

                } catch (error) {
                    console.error(`Error processing receipt ${i + 1}:`, error);
                    statusBadge.className = 'status-badge status-error';
                    statusBadge.textContent = ' Error';
                    progressBar.style.width = '100%';
                    progressBar.style.background = '#dc3545';
                    details.textContent = error.message || 'Failed to process';
                    card.classList.remove('processing');
                }

                completed++;
                const overallProgress = (completed / files.length) * 100;
                document.getElementById('batchProgressBar').style.width = `${overallProgress}%`;
                counter.textContent = `${completed} / ${files.length}`;
            }

            // Show summary and save button
            const successCount = batchResults.length;
            const totalItems = batchResults.reduce((sum, r) => sum + r.items.length, 0);
            const totalAmount = batchResults.reduce((sum, r) => sum + (r.total || 0), 0);

            itemsList.innerHTML += `
                <div style="background: linear-gradient(135deg, var(--success), var(--secondary)); padding: 24px; border-radius: 16px; color: white; margin-top: 24px; animation: slideUp 0.5s ease-out;">
                    <h3 style="font-family: 'Fraunces', serif; font-size: 1.4em; margin-bottom: 12px;">Batch Complete! </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 2em; font-weight: 700;">${successCount}</div>
                            <div style="opacity: 0.9;">Receipts</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: 700;">${totalItems}</div>
                            <div style="opacity: 0.9;">Items</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: 700;">${totalAmount.toFixed(0)}</div>
                            <div style="opacity: 0.9;">kr Total</div>
                        </div>
                    </div>
                    ${files.length > successCount ? `<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-bottom: 12px;"> ${files.length - successCount} receipt(s) failed to process</div>` : ''}
                </div>
                <div class="batch-actions">
                    <button class="btn" onclick="saveBatchReceipts()" style="flex: 1;"><span> Save All ${successCount} Receipts</span></button>
                    <button class="btn-secondary btn" onclick="reviewBatchReceipts()" style="flex: 1;"><span> Review Details</span></button>
                </div>
            `;

            // Store batch results globally
            window.currentBatchResults = batchResults;

            // Automatically save batch receipts
            await saveBatchReceipts();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function analyzeReceiptBatch(imageData, progressCallback) {
            if (progressCallback) progressCallback('extracting');

            // Call our secure backend API instead of calling Claude directly
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageData })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `API Error: ${response.status}`);
            }

            if (progressCallback) progressCallback('categorizing');

            const receiptData = await response.json();

            if (!receiptData.items || !Array.isArray(receiptData.items)) {
                throw new Error('Invalid receipt data');
            }

            return receiptData;
        }

        async function saveBatchReceipts() {
            if (!window.currentBatchResults || window.currentBatchResults.length === 0) return;

            const batchCount = window.currentBatchResults.length;
            const { data: { user } } = await _supabase.auth.getUser();

            try {
                if (user) {
                    // Save to Supabase if logged in
                    const receiptsToSave = window.currentBatchResults.map(receipt => ({
                        user_id: user.id,
                        store_name: receipt.store || "Unknown Store",
                        purchase_date: receipt.date || new Date().toISOString(),
                        total_amount: receipt.total || 0,
                        items: receipt.items
                    }));

                    const { error } = await _supabase
                        .from('receipts')
                        .insert(receiptsToSave);

                    if (error) {
                        throw error;
                    }

                    await loadLongTermData();
                    const totalReceipts = allReceipts.length;
                    showToast(`${batchCount} receipt${batchCount !== 1 ? 's' : ''} saved successfully! You now have ${totalReceipts} receipt${totalReceipts !== 1 ? 's' : ''} total.`, 'success');
                } else {
                    // Save locally if not logged in
                    allReceipts.push(...window.currentBatchResults);
                    localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
                    const totalReceipts = allReceipts.length;
                    showToast(`${batchCount} receipt${batchCount !== 1 ? 's' : ''} saved locally! You now have ${totalReceipts} receipt${totalReceipts !== 1 ? 's' : ''} total.`, 'success');
                    updateDashboard();
                    updateHistory();
                    updateDataTable();
                }

                document.getElementById('processingArea').style.display = 'none';
                document.getElementById('fileInput').value = '';
                window.currentBatchResults = null;
                document.querySelectorAll('.nav-tab')[1].click();
            } catch (error) {
                showToast(error.message, 'error', 'Save Failed');
            }
        }

        function reviewBatchReceipts() {
            if (!window.currentBatchResults || window.currentBatchResults.length === 0) return;

            const itemsList = document.getElementById('itemsList');

            let allItemsHTML = '';
            window.currentBatchResults.forEach((receipt, idx) => {
                allItemsHTML += `
                    <div style="margin-bottom: 24px; padding: 20px; background: var(--light); border-radius: 16px;">
                        <h4 style="font-family: 'Fraunces', serif; margin-bottom: 12px; font-size: 1.2em;">Receipt ${idx + 1}: ${receipt.store || 'Unknown Store'}</h4>
                        <div style="color: #666; margin-bottom: 12px;">
                            <strong>Date:</strong> ${receipt.date || 'Not visible'}  
                            <strong>Total:</strong> ${receipt.total ? receipt.total.toFixed(2) + ' kr' : 'Not visible'}
                        </div>
                        ${receipt.items.map(item => `
                            <div class="item">
                                <div class="item-name">${item.name}</div>
                                <div class="item-category">${item.category}${item.subcategory ? '  ' + item.subcategory : ''}</div>
                                <div class="item-price">${(item.price || 0).toFixed(2)} kr</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            itemsList.innerHTML = `
                <div class="batch-header">
                    <h3 style="font-family: 'Fraunces', serif; font-size: 1.5em;">Review ${window.currentBatchResults.length} Receipts</h3>
                </div>
                ${allItemsHTML}
                <div class="batch-actions">
                    <button class="btn" onclick="saveBatchReceipts()" style="flex: 1;"><span> Save All to Budget</span></button>
                    <button class="btn-secondary btn" onclick="cancelBatch()" style="flex: 1;"><span> Cancel</span></button>
                </div>
            `;
        }

        function cancelBatch() {
            document.getElementById('processingArea').style.display = 'none';
            document.getElementById('fileInput').value = '';
            window.currentBatchResults = null;
        }

        // Fun messages to show while analyzing
        const funMessages = [
            "Deciphering cashier handwriting... ",
            "Teaching AI about Swedish groceries... ",
            "Counting every krona... ",
            "Hunting for hidden discounts... ",
            "Reading between the lines... ",
            "Organizing your spending... ",
            "Almost there, hang tight... ",
            "Making sense of receipt hieroglyphics... ",
            "Crunching the numbers... ",
            "Finding the best categories... "
        ];

        let funMessageInterval = null;

        function startFunMessages() {
            const funMessageEl = document.getElementById('funMessage');
            if (!funMessageEl) return;

            let messageIndex = 0;
            funMessageEl.textContent = funMessages[0];

            funMessageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % funMessages.length;
                funMessageEl.style.opacity = '0';
                setTimeout(() => {
                    funMessageEl.textContent = funMessages[messageIndex];
                    funMessageEl.style.opacity = '1';
                }, 200);
            }, 2500);
        }

        function stopFunMessages() {
            if (funMessageInterval) {
                clearInterval(funMessageInterval);
                funMessageInterval = null;
            }
        }

        async function analyzeReceipt(imageData) {
            try {
                // Start fun animated messages
                document.querySelector('.loading-text').textContent = 'AI is reading your receipt...';
                startFunMessages();

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageData })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API Error: ${response.status}`);
                }

                const receiptData = await response.json();

                if (!receiptData.items || !Array.isArray(receiptData.items)) {
                    throw new Error('Invalid receipt data received from AI');
                }

                stopFunMessages();
                currentReceipt = receiptData;
                displayResults(receiptData);

                // Show success message - user will review before saving
                showToast('Receipt analyzed! Please review the details before saving.', 'info');
            } catch (error) {
                stopFunMessages();
                showToast(error.message, 'error', 'Analysis Failed');
                console.error(error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('processingArea').style.display = 'none';
            }
        }

        // Cancel receipt without saving
        function cancelReceipt() {
            currentReceipt = null;
            document.getElementById('processingArea').style.display = 'none';
            document.getElementById('fileInput').value = '';
            showToast('Receipt cancelled', 'info');
        }

        function displayResults(data) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'block';

            // Show validation warnings if any
            let validationHTML = '';
            if (data._validation && data._validation.warnings && data._validation.warnings.length > 0) {
                validationHTML = `
                    <div style="background: #FFF3CD; border-left: 4px solid var(--warning-yellow); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #856404;"> Validation Warnings</div>
                        ${data._validation.warnings.map(w => `
                            <div style="font-size: 13px; color: #856404; margin-bottom: 4px;"> ${w.message}</div>
                        `).join('')}
                    </div>
                `;
            }

            // Editable metadata display
            let metadataHTML = `
                <div style="background: var(--primary-light); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div>
                            <label style="font-size: 0.75em; color: var(--text-tertiary); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Store</label>
                            <input type="text" id="editStore" value="${data.store || ''}" placeholder="Store name"
                                style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; background: white;">
                        </div>
                        <div>
                            <label style="font-size: 0.75em; color: var(--text-tertiary); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Date</label>
                            <input type="date" id="editDate" value="${data.date || new Date().toISOString().split('T')[0]}"
                                style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; background: white;">
                        </div>
                        <div>
                            <label style="font-size: 0.75em; color: var(--text-tertiary); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Total</label>
                            <div style="position: relative;">
                                <input type="number" id="editTotal" value="${data.total || 0}" step="0.01" min="0"
                                    style="width: 100%; padding: 10px 12px; padding-right: 35px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 700; color: var(--primary); background: white;">
                                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 14px;">kr</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Items section header with Add button
            let itemsHeaderHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Items (${data.items.length})</h4>
                    <button onclick="addNewItem()" style="background: var(--teal-primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 16px;">+</span> Add Item
                    </button>
                </div>
            `;

            // Available categories for dropdown
            const availableCategories = [
                'Groceries', 'Dining', 'Transport', 'Entertainment',
                'Shopping', 'Healthcare', 'Household', 'Personal Care', 'Other'
            ];

            // Editable items display
            const itemsHTML = data.items.map((item, index) => {
                const currentCategory = item.category || 'Other';

                return `
                    <div class="edit-item-card" id="itemCard-${index}" style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative;">
                        <!-- Delete button -->
                        <button onclick="removeItem(${index})" style="position: absolute; top: 8px; right: 8px; background: rgba(248, 113, 113, 0.1); border: none; color: #f87171; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;" title="Remove item">
                            
                        </button>

                        <!-- Item name -->
                        <div style="margin-bottom: 12px; padding-right: 36px;">
                            <label style="font-size: 0.7em; color: var(--text-tertiary); margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Item Name</label>
                            <input type="text" value="${item.name || ''}" onchange="updateItemField(${index}, 'name', this.value)"
                                style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-weight: 500;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 120px; gap: 12px;">
                            <!-- Category dropdown -->
                            <div>
                                <label style="font-size: 0.7em; color: var(--text-tertiary); margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Category</label>
                                <select onchange="updateItemField(${index}, 'category', this.value)"
                                    style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                                    ${availableCategories.map(cat => `
                                        <option value="${cat}" ${cat === currentCategory ? 'selected' : ''}>${cat}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <!-- Price -->
                            <div>
                                <label style="font-size: 0.7em; color: var(--text-tertiary); margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Price</label>
                                <div style="position: relative;">
                                    <input type="number" value="${item.price || 0}" step="0.01" min="0" onchange="updateItemField(${index}, 'price', parseFloat(this.value) || 0)"
                                        style="width: 100%; padding: 8px 10px; padding-right: 28px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-weight: 600; color: var(--expense-red);">
                                    <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); font-size: 12px;">kr</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Recalculate total button
            let recalcHTML = `
                <button onclick="recalculateTotal()" style="width: 100%; background: var(--primary-light); color: var(--primary); border: 1px dashed var(--primary); padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 8px; margin-bottom: 16px;">
                     Recalculate Total from Items
                </button>
            `;

            document.getElementById('itemsList').innerHTML = validationHTML + metadataHTML + itemsHeaderHTML + itemsHTML + recalcHTML;
        }

        // Update a specific field on an item
        function updateItemField(itemIndex, field, value) {
            if (!currentReceipt || !currentReceipt.items || !currentReceipt.items[itemIndex]) {
                console.error('Invalid item index or no receipt loaded');
                return;
            }

            currentReceipt.items[itemIndex][field] = value;

            // Also update in _items_detailed if it exists
            if (currentReceipt._items_detailed && currentReceipt._items_detailed[itemIndex]) {
                currentReceipt._items_detailed[itemIndex][field] = value;
            }
        }

        // Remove an item from the receipt
        function removeItem(itemIndex) {
            if (!currentReceipt || !currentReceipt.items) return;

            currentReceipt.items.splice(itemIndex, 1);

            if (currentReceipt._items_detailed) {
                currentReceipt._items_detailed.splice(itemIndex, 1);
            }

            // Re-render the results
            displayResults(currentReceipt);
            showToast('Item removed', 'info');
        }

        // Add a new item to the receipt
        function addNewItem() {
            if (!currentReceipt) return;

            const newItem = {
                name: 'New Item',
                price: 0,
                category: 'Other'
            };

            currentReceipt.items.push(newItem);

            if (currentReceipt._items_detailed) {
                currentReceipt._items_detailed.push({
                    ...newItem,
                    total_price: 0
                });
            }

            // Re-render the results
            displayResults(currentReceipt);

            // Scroll to the new item and focus on its name input
            setTimeout(() => {
                const newIndex = currentReceipt.items.length - 1;
                const newCard = document.getElementById(`itemCard-${newIndex}`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const nameInput = newCard.querySelector('input[type="text"]');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.select();
                    }
                }
            }, 100);

            showToast('New item added', 'success');
        }

        // Recalculate total from all items
        function recalculateTotal() {
            if (!currentReceipt || !currentReceipt.items) return;

            const newTotal = currentReceipt.items.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
            currentReceipt.total = newTotal;

            document.getElementById('editTotal').value = newTotal.toFixed(2);
            showToast(`Total updated to ${newTotal.toFixed(2)} kr`, 'success');
        }

        // Update receipt metadata before saving
        function updateReceiptFromForm() {
            if (!currentReceipt) return;

            currentReceipt.store = document.getElementById('editStore').value || 'Unknown Store';
            currentReceipt.date = document.getElementById('editDate').value || new Date().toISOString().split('T')[0];
            currentReceipt.total = parseFloat(document.getElementById('editTotal').value) || 0;
        }

        function updateItemCategory(itemIndex, newCategory) {
            updateItemField(itemIndex, 'category', newCategory);
        }

        async function saveReceiptAuto() {
            if (!currentReceipt) return;

            // Check if user is logged in to Supabase
            const { data: { user } } = await _supabase.auth.getUser();

            if (user) {
                // Save to Supabase if logged in with rich metadata
                const metadata = currentReceipt._metadata || {};
                const financial = currentReceipt._financial || {};

                const receiptToSave = {
                    user_id: user.id,
                    store_name: metadata.store_name || currentReceipt.store || "Unknown Store",
                    store_chain: metadata.store_chain,
                    store_address: metadata.store_location?.address,
                    store_city: metadata.store_location?.city,
                    store_postal_code: metadata.store_location?.postal_code,
                    receipt_number: metadata.receipt_number,
                    purchase_date: metadata.purchase_date || currentReceipt.date || new Date().toISOString(),
                    purchase_time: metadata.purchase_time || currentReceipt.time,
                    currency: metadata.currency || 'SEK',
                    subtotal: financial.subtotal || 0,
                    total_discounts: financial.total_discounts || 0,
                    total_amount: financial.total || currentReceipt.total || 0,
                    loyalty_points_earned: financial.loyalty_points_earned || 0,
                    loyalty_points_used: financial.loyalty_points_used || 0,
                    items: currentReceipt._items_detailed || currentReceipt.items,
                    items_count: currentReceipt.items?.length || 0,
                    time_of_day: currentReceipt._analytics?.time_of_day,
                    day_of_week: currentReceipt._analytics?.day_of_week
                };

                const { data: insertedReceipt, error } = await _supabase
                    .from('receipts')
                    .insert([receiptToSave])
                    .select();

                if (error) {
                    console.error("Error saving to cloud:", error);
                    showToast("Failed to save to cloud. Saving locally instead.", 'warning');
                    // Fallback to localStorage
                    allReceipts.push(currentReceipt);
                    localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
                } else {
                    await loadLongTermData();

                    // Check for budget alerts
                    if (insertedReceipt && insertedReceipt.length > 0) {
                        await checkBudgetAlerts(insertedReceipt[0].id);
                    }

                    // Show quick stats with gamification feedback
                    await showQuickStats(currentReceipt);

                    document.getElementById('processingArea').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    currentReceipt = null;
                    document.querySelectorAll('.nav-tab')[1].click();
                    return;
                }
            }

            // If not logged in, save locally
            allReceipts.push(currentReceipt);
            localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
            const totalReceipts = allReceipts.length;
            showToast(`Receipt saved locally! You now have ${totalReceipts} receipt${totalReceipts !== 1 ? 's' : ''} saved.`, 'success');
            updateDashboard();
            updateHistory();
            updateDataTable();
            document.getElementById('processingArea').style.display = 'none';
            document.getElementById('fileInput').value = '';
            currentReceipt = null;
            document.querySelectorAll('.nav-tab')[1].click();
        }

        async function saveReceipt() {
            if (!currentReceipt) return;

            // Update receipt from form fields before saving
            updateReceiptFromForm();

            // Check if user is logged in to Supabase
            const { data: { user } } = await _supabase.auth.getUser();

            if (user) {
                // Save to Supabase if logged in
                const receiptToSave = {
                    user_id: user.id,
                    store_name: currentReceipt.store || "Unknown Store",
                    purchase_date: currentReceipt.date || new Date().toISOString(),
                    total_amount: currentReceipt.total || 0,
                    items: currentReceipt.items
                };

                const { error } = await _supabase
                    .from('receipts')
                    .insert([receiptToSave]);

                if (error) {
                    console.error("Error saving to cloud:", error);
                    alert("Failed to save to cloud. Saving locally instead.");
                } else {
                    alert(" Saved permanently to your account!");
                    await loadLongTermData();
                    document.getElementById('processingArea').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    currentReceipt = null;
                    document.querySelectorAll('.nav-tab')[1].click();
                    return;
                }
            }

            // Fallback to local storage if not logged in or Supabase failed
            allReceipts.push(currentReceipt);

            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    await window.storage.set('receipts', JSON.stringify(allReceipts));
                } else {
                    localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
                }

                alert(' Receipt saved locally!');

                document.getElementById('processingArea').style.display = 'none';
                document.getElementById('fileInput').value = '';
                currentReceipt = null;

                document.querySelectorAll('.nav-tab')[1].click();
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        }

        async function updateDashboard() {
            if (allReceipts.length === 0) {
                // Hero card
                document.getElementById('heroTotalSpent').textContent = '0 kr';
                // Budget stats
                document.getElementById('receiptCount').textContent = '0';
                document.getElementById('itemCount').textContent = '0';
                document.getElementById('totalSavingsStat').textContent = '0 kr';
                // Recent transactions
                document.getElementById('recentTransactionsList').innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-tertiary);"><div style="font-size: 3em; margin-bottom: 12px; opacity: 0.3;"></div><p>No transactions yet. Start scanning receipts!</p></div>';
                document.getElementById('priceComparison').innerHTML = '<div class="empty-state"><div class="empty-icon"></div><p>No data yet. Start scanning receipts!</p></div>';
                return;
            }

            const totalSpent = allReceipts.reduce((sum, r) => sum + (r.total || 0), 0);
            const totalItems = allReceipts.reduce((sum, r) => sum + r.items.length, 0);
            const totalSavings = allReceipts.reduce((sum, r) => {
                return sum + r.items.reduce((itemSum, item) => itemSum + (item.discount || 0), 0);
            }, 0);

            // Update hero card
            document.getElementById('heroTotalSpent').textContent = totalSpent.toFixed(2) + ' kr';

            // Update budget stats
            document.getElementById('receiptCount').textContent = allReceipts.length;
            document.getElementById('itemCount').textContent = totalItems;
            document.getElementById('totalSavingsStat').textContent = totalSavings.toFixed(2) + ' kr';

            const categoryTotals = {};
            allReceipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    const cat = item.category || 'Other';
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + item.price;
                });
            });

            updateCategoryChart(categoryTotals);
            updateCategoryCardsGrid(categoryTotals);
            updateMonthlyComparisonChart();
            updatePriceComparison();
            updateTopItems();
            updateRecentTransactions(); // New function for 5 recent transactions

            // Load gamification data and budgets
            await loadGamificationData();
            await loadBudgetData();
        }

        // New function: Display 5 most recent transactions
        function updateRecentTransactions() {
            const recentList = document.getElementById('recentTransactionsList');
            if (!recentList) return;

            // Get 5 most recent receipts (already sorted newest first)
            const recentReceipts = allReceipts.slice(0, 5);

            if (recentReceipts.length === 0) {
                recentList.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-tertiary);">No recent transactions</div>';
                return;
            }

            recentList.innerHTML = recentReceipts.map((receipt, index) => {
                const total = receipt.total || 0;
                const isNegative = total < 0;
                // Coral Red for expenses, Emerald Green for income/savings
                const amountColor = isNegative ? '#10b981' : '#f87171';  // Emerald green for refunds, Coral red for expenses

                // Get store initial for icon
                const storeInitial = (receipt.store || 'U')[0].toUpperCase();

                return `
                <div style="
                    background: var(--card);
                    border: 1px solid #f3f4f6;
                    border-radius: var(--radius-medium);
                    padding: 16px;
                    margin-bottom: 12px;
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    transition: all var(--transition-fast);
                    cursor: pointer;
                " onmouseover="this.style.boxShadow='var(--shadow-low)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <!-- Circular Icon -->
                    <div style="
                        width: 44px;
                        height: 44px;
                        border-radius: 50%;
                        background: var(--primary-alpha-10);
                        color: var(--primary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: var(--font-weight-bold);
                        font-size: var(--font-size-lg);
                        flex-shrink: 0;
                    ">
                        ${storeInitial}
                    </div>

                    <!-- Store Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: 4px; font-size: var(--font-size-base); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${receipt.store || 'Unknown Store'}
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-tertiary);">
                            ${receipt.date || 'N/A'}  ${receipt.items.length} items
                        </div>
                    </div>

                    <!-- Amount (Right-aligned) -->
                    <div style="text-align: right; flex-shrink: 0;">
                        <div style="font-weight: var(--font-weight-bold); font-size: var(--font-size-xl); color: ${amountColor};">
                            ${total.toFixed(2)} kr
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateCategoryChart(categoryTotals) {
            const ctx = document.getElementById('categoryChart');

            if (window.categoryChartInstance) {
                window.categoryChartInstance.destroy();
            }

            const total = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);
            document.getElementById('centerAmount').textContent = total.toFixed(0) + ' kr';

            // Add insight cards
            const categories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            const topCategory = categories[0];
            const numCategories = categories.length;
            const avgPerCategory = total / numCategories;

            const insightHTML = `
                <div style="padding: 16px; background: linear-gradient(135deg, #667eea15 0%, #764ba205 100%); border-radius: 10px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Top Category</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--text);">${topCategory ? topCategory[0] : 'N/A'}</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">${topCategory ? topCategory[1].toFixed(0) : '0'} kr (${topCategory ? ((topCategory[1] / total) * 100).toFixed(0) : '0'}%)</div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #f09433155 0%, #e6683c05 100%); border-radius: 10px; border-left: 4px solid #f09433;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Categories</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--text);">${numCategories}</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">Avg: ${avgPerCategory.toFixed(0)} kr</div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #11998e15 0%, #38ef7d05 100%); border-radius: 10px; border-left: 4px solid #11998e;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Total Spent</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--text);">${total.toFixed(0)} kr</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">Across all categories</div>
                </div>
            `;
            document.getElementById('distributionInsights').innerHTML = insightHTML;

            // Generate teal color palette based on primary color
            const generateTealPalette = (count) => {
                const colors = [];
                const baseHue = 198; // Teal hue from #2D9CDB
                const baseSat = 65;
                const baseLightStart = 45;
                const baseLightEnd = 70;

                for (let i = 0; i < count; i++) {
                    const lightness = baseLightStart + (baseLightEnd - baseLightStart) * (i / Math.max(count - 1, 1));
                    const saturation = baseSat - (i * 5); // Slightly reduce saturation for variety
                    colors.push(`hsl(${baseHue}, ${saturation}%, ${lightness}%)`);
                }
                return colors;
            };

            const tealPalette = generateTealPalette(numCategories);

            window.categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: tealPalette,
                        borderWidth: 4,
                        borderColor: '#fff',
                        hoverOffset: 8,
                        hoverBorderWidth: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(51, 51, 51, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'var(--primary)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + value.toFixed(0) + ' kr (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const category = Object.keys(categoryTotals)[index];
                            showCategoryDeepDive(category);
                        }
                    },
                    onHover: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const category = Object.keys(categoryTotals)[index];
                            const value = Object.values(categoryTotals)[index];
                            const percentage = ((value / total) * 100).toFixed(1);
                            document.getElementById('centerAmount').textContent = value.toFixed(0) + ' kr';
                            document.getElementById('centerLabel').textContent = category + ' (' + percentage + '%)';
                        } else {
                            document.getElementById('centerAmount').textContent = total.toFixed(0) + ' kr';
                            document.getElementById('centerLabel').textContent = 'Total Spending';
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            if (window.trendChartInstance) {
                window.trendChartInstance.destroy();
            }

            // Group receipts by date
            const dateSpending = {};
            allReceipts.forEach(receipt => {
                const date = receipt.date ? receipt.date.split('T')[0] : new Date().toISOString().split('T')[0];
                dateSpending[date] = (dateSpending[date] || 0) + (receipt.total || 0);
            });

            // Sort by date and get last 14 days or all if less
            const sortedDates = Object.keys(dateSpending).sort();
            const last14Dates = sortedDates.slice(-14);
            const labels = last14Dates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const data = last14Dates.map(date => dateSpending[date]);

            window.trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: data,
                        borderColor: '#5BA89F',
                        backgroundColor: 'rgba(91, 168, 159, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointBackgroundColor: '#5BA89F',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + ' kr';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' kr';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Category Cards Grid with Trends
        function updateCategoryCardsGrid(categoryTotals) {
            const container = document.getElementById('categoryCardsGrid');
            if (!container) return;

            const total = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);
            const colors = {
                'Groceries': '#10b981',
                'Dining': '#f59e0b',
                'Transport': '#3b82f6',
                'Entertainment': '#a78bfa',
                'Shopping': '#ec4899',
                'Healthcare': '#ef4444',
                'Household': '#06b6d4',
                'Personal Care': '#8b5cf6',
                'Other': '#6b7280'
            };

            // Calculate previous month totals for comparison
            const lastMonthStart = new Date();
            lastMonthStart.setMonth(lastMonthStart.getMonth() - 1);
            lastMonthStart.setDate(1);
            const lastMonthEnd = new Date(lastMonthStart);
            lastMonthEnd.setMonth(lastMonthEnd.getMonth() + 1);
            lastMonthEnd.setDate(0);

            const lastMonthTotals = {};
            allReceipts.forEach(receipt => {
                const receiptDate = new Date(receipt.date);
                if (receiptDate >= lastMonthStart && receiptDate <= lastMonthEnd) {
                    receipt.items.forEach(item => {
                        const cat = item.category || 'Other';
                        lastMonthTotals[cat] = (lastMonthTotals[cat] || 0) + item.price;
                    });
                }
            });

            container.innerHTML = '';

            Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).forEach(([category, amount]) => {
                const percentage = ((amount / total) * 100).toFixed(1);
                const lastMonthAmount = lastMonthTotals[category] || 0;
                const change = lastMonthAmount > 0 ? ((amount - lastMonthAmount) / lastMonthAmount * 100).toFixed(1) : 0;
                const trendIcon = change > 5 ? '' : change < -5 ? '' : '';
                const trendColor = change > 5 ? '#ef4444' : change < -5 ? '#10b981' : '#6b7280';
                const categoryColor = colors[category] || colors['Other'];

                const card = document.createElement('div');
                card.style.cssText = `
                    padding: 20px;
                    border-radius: 12px;
                    background: linear-gradient(135deg, ${categoryColor}15 0%, ${categoryColor}05 100%);
                    border-left: 4px solid ${categoryColor};
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                card.onmouseenter = () => card.style.transform = 'translateY(-4px)';
                card.onmouseleave = () => card.style.transform = 'translateY(0)';
                card.onclick = () => showCategoryDeepDive(category);

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">${category}</div>
                            <div style="font-size: 1.8em; font-weight: 700; color: ${categoryColor};">${amount.toFixed(0)} kr</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 2em; color: ${trendColor};">${trendIcon}</div>
                            <div style="font-size: 0.85em; color: ${trendColor};">${change > 0 ? '+' : ''}${change}%</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9em; color: var(--text-secondary);">${percentage}% of total</div>
                        <div style="font-size: 0.85em; color: var(--text-tertiary);">vs last month</div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Monthly Comparison Chart
        function updateMonthlyComparisonChart() {
            const ctx = document.getElementById('monthlyComparisonChart');
            if (!ctx) return;

            if (window.monthlyComparisonChartInstance) {
                window.monthlyComparisonChartInstance.destroy();
            }

            // Get last 6 months
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                    label: date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })
                });
            }

            // Group spending by month and category
            const monthlyData = {};
            months.forEach(m => monthlyData[m.key] = {});

            allReceipts.forEach(receipt => {
                const receiptDate = new Date(receipt.date);
                const monthKey = `${receiptDate.getFullYear()}-${String(receiptDate.getMonth() + 1).padStart(2, '0')}`;

                if (monthlyData[monthKey]) {
                    receipt.items.forEach(item => {
                        const cat = item.category || 'Other';
                        monthlyData[monthKey][cat] = (monthlyData[monthKey][cat] || 0) + item.price;
                    });
                }
            });

            // Get all categories
            const allCategories = new Set();
            Object.values(monthlyData).forEach(monthCats => {
                Object.keys(monthCats).forEach(cat => allCategories.add(cat));
            });

            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A78BFA', '#95E1D3', '#FF8E53', '#44A3FF', '#FFBE0B'];
            const datasets = Array.from(allCategories).map((category, index) => ({
                label: category,
                data: months.map(m => monthlyData[m.key][category] || 0),
                backgroundColor: colors[index % colors.length],
                borderWidth: 0
            }));

            // Calculate trend insights
            const monthlyTotals = months.map(m => Object.values(monthlyData[m.key]).reduce((sum, val) => sum + val, 0));
            const currentMonth = monthlyTotals[monthlyTotals.length - 1];
            const previousMonth = monthlyTotals[monthlyTotals.length - 2] || 0;
            const avgMonthly = monthlyTotals.reduce((sum, val) => sum + val, 0) / monthlyTotals.filter(v => v > 0).length;
            const trend = previousMonth > 0 ? ((currentMonth - previousMonth) / previousMonth * 100) : 0;
            const trendIcon = trend > 0 ? '' : trend < 0 ? '' : '';
            const trendColor = trend > 0 ? '#ef4444' : trend < 0 ? '#10b981' : '#6b7280';

            const trendInsightHTML = `
                <div style="padding: 16px; background: linear-gradient(135deg, #667eea15 0%, #764ba205 100%); border-radius: 10px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">This Month</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--text);">${currentMonth.toFixed(0)} kr</div>
                    <div style="font-size: 0.9em; color: ${trendColor}; margin-top: 4px;">${trendIcon} ${Math.abs(trend).toFixed(1)}% vs last month</div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #f09433155 0%, #e6683c05 100%); border-radius: 10px; border-left: 4px solid #f09433;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">6-Month Average</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--text);">${avgMonthly.toFixed(0)} kr</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">Per month</div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #11998e15 0%, #38ef7d05 100%); border-radius: 10px; border-left: 4px solid #11998e;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Trend</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--text);">${trend > 5 ? 'Rising' : trend < -5 ? 'Falling' : 'Stable'}</div>
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">${currentMonth > avgMonthly ? 'Above' : 'Below'} average</div>
                </div>
            `;
            document.getElementById('trendInsights').innerHTML = trendInsightHTML;

            window.monthlyComparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => m.label),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' kr';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12, weight: '600' },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' kr';
                                },
                                footer: function(tooltipItems) {
                                    const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return 'Total: ' + total.toFixed(0) + ' kr';
                                }
                            }
                        }
                    }
                }
            });
        }

        function showCategoryDeepDive(category) {
            const card = document.getElementById('deepDiveCard');
            const title = document.getElementById('deepDiveTitle');
            const details = document.getElementById('deepDiveDetails');

            const subcategories = {};
            allReceipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    if (item.category === category) {
                        const sub = item.subcategory || 'Uncategorized';
                        if (!subcategories[sub]) {
                            subcategories[sub] = { total: 0, items: [] };
                        }
                        subcategories[sub].total += item.price;
                        subcategories[sub].items.push({
                            name: item.name,
                            price: item.price,
                            store: receipt.store,
                            date: receipt.date
                        });
                    }
                });
            });

            const sorted = Object.entries(subcategories).sort((a, b) => b[1].total - a[1].total);

            title.textContent = `${category} Breakdown`;

            details.innerHTML = sorted.map(([sub, data]) => {
                const subId = `detail-${sub.replace(/\s+/g, '-')}`;

                const itemGroups = {};
                data.items.forEach(item => {
                    const key = item.name.toLowerCase();
                    if (!itemGroups[key]) {
                        itemGroups[key] = {
                            displayName: item.name,
                            purchases: [],
                            total: 0,
                            count: 0
                        };
                    }
                    itemGroups[key].purchases.push(item);
                    itemGroups[key].total += item.price;
                    itemGroups[key].count++;
                });

                const sortedItems = Object.values(itemGroups)
                    .map(g => {
                        g.avgPrice = g.total / g.count;
                        return g;
                    })
                    .sort((a, b) => b.total - a.total);

                return `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpand('${subId}')">
                            <div class="expandable-title">
                                <span class="expand-icon" id="${subId}-icon"></span>
                                ${sub}
                            </div>
                            <strong>${data.total.toFixed(2)} kr</strong>
                        </div>
                        <div class="expandable-content" id="${subId}-content">
                            <div class="expandable-body">
                                ${sortedItems.map(g => `
                                    <div style="margin-bottom: 20px; padding: 16px; background: var(--light); border-radius: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                            <strong style="font-size: 1.1em;">${g.displayName}</strong>
                                            <strong style="color: var(--primary); font-size: 1.1em;">${g.total.toFixed(2)} kr</strong>
                                        </div>
                                        <div style="color: #666; font-size: 0.9em; margin-bottom: 12px;">
                                            Purchased ${g.count}x  Avg: ${g.avgPrice.toFixed(2)} kr
                                        </div>
                                        ${g.purchases.map(p => `
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                                <div>
                                                    <div style="font-weight: 600;">${p.store || 'Unknown'}</div>
                                                    <div style="font-size: 0.85em; color: #999;">${p.date || 'N/A'}</div>
                                                </div>
                                                <div style="font-weight: 600;">${(p.price || 0).toFixed(2)} kr</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            card.style.display = 'block';
            card.scrollIntoView({ behavior: 'smooth' });
        }

        function toggleExpand(id) {
            const content = document.getElementById(`${id}-content`);
            const icon = document.getElementById(`${id}-icon`);
            const header = icon.closest('.expandable-header');

            const isExpanded = content.classList.contains('expanded');
            content.classList.toggle('expanded');
            icon.classList.toggle('rotated');
            header.classList.toggle('active');
        }

        function closeDeepDive() {
            document.getElementById('deepDiveCard').style.display = 'none';
        }

        function updatePriceComparison() {
            const prices = {};
            allReceipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    const key = item.name.toLowerCase();
                    if (!prices[key]) prices[key] = [];
                    prices[key].push({
                        store: receipt.store,
                        price: item.price,
                        date: receipt.date
                    });
                });
            });

            const html = Object.entries(prices)
                .filter(([_, p]) => p.length > 1)
                .slice(0, 6)
                .map(([name, p]) => {
                    p.sort((a, b) => a.price - b.price);
                    const bestPrice = p[0].price;
                    const worstPrice = p[p.length - 1].price;
                    const savings = worstPrice - bestPrice;

                    return `
                        <div style="padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em;">
                                    
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="text-transform: capitalize; margin: 0; font-size: 1.1em; color: var(--text);">${name}</h3>
                                    <div style="font-size: 0.85em; color: var(--success); margin-top: 4px;">Save up to ${savings.toFixed(2)} kr</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${p.map((item, i) => {
                                    const isBest = i === 0;
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${isBest ? 'linear-gradient(135deg, #10b98115 0%, #10b98105 100%)' : '#fff'}; border-radius: 8px; border-left: 3px solid ${isBest ? '#10b981' : '#e5e7eb'};">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                ${isBest ? '<span style="font-size: 1.2em;"></span>' : ''}
                                                <strong style="color: var(--text);">${item.store}</strong>
                                            </div>
                                            <span style="font-weight: 700; font-size: 1.1em; color: ${isBest ? '#10b981' : 'var(--text)'};">${(item.price || 0).toFixed(2)} kr</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('priceComparison').innerHTML = html ||
                '<div class="empty-state"><div class="empty-icon"></div><p>Price comparisons appear when you have items from different stores</p></div>';
        }
        function updateTopItems() {
            const itemStats = {};

            allReceipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    const name = item.name.trim().toLowerCase();
                    if (!itemStats[name]) {
                        itemStats[name] = { displayName: item.name, totalCost: 0, frequency: 0 };
                    }
                    itemStats[name].totalCost += item.price;
                    itemStats[name].frequency += 1;
                });
            });

            const statsArray = Object.values(itemStats);
            if (statsArray.length === 0) return;

            const mostFrequent = [...statsArray].sort((a, b) => b.frequency - a.frequency).slice(0, 10);
            const mostExpensive = [...statsArray].sort((a, b) => b.totalCost - a.totalCost).slice(0, 10);

            const maxFreq = mostFrequent[0].frequency;
            const maxCost = mostExpensive[0].totalCost;

            const container = document.getElementById('topItemsContainer');
            container.innerHTML = `
                <div style="padding: 20px; background: linear-gradient(135deg, #f093331515 0%, #e6683c05 100%); border-radius: 12px; border-left: 4px solid #f09433;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f09433 0%, #e6683c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                            
                        </div>
                        <h3 style="margin: 0; font-size: 1.2em; color: var(--text);">Most Frequent</h3>
                    </div>
                    ${mostFrequent.slice(0, 5).map((item, index) => `
                        <div style="margin-bottom: 16px; padding: 14px; background: #fff; border-radius: 10px; border: 1px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.4em; font-weight: 700; color: #f09433; width: 24px;">#${index + 1}</span>
                                    <strong style="color: var(--text);">${item.displayName}</strong>
                                </div>
                                <span style="padding: 4px 12px; background: linear-gradient(135deg, #f0943315 0%, #e6683c05 100%); border-radius: 20px; font-weight: 600; font-size: 0.9em; color: #f09433;">${item.frequency}x</span>
                            </div>
                            <div style="height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${(item.frequency / maxFreq) * 100}%; background: linear-gradient(90deg, #f09433 0%, #e6683c 100%); transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #667eea15 0%, #764ba205 100%); border-radius: 12px; border-left: 4px solid #667eea;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em;">
                            
                        </div>
                        <h3 style="margin: 0; font-size: 1.2em; color: var(--text);">Highest Total Cost</h3>
                    </div>
                    ${mostExpensive.slice(0, 5).map((item, index) => `
                        <div style="margin-bottom: 16px; padding: 14px; background: #fff; border-radius: 10px; border: 1px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.4em; font-weight: 700; color: #667eea; width: 24px;">#${index + 1}</span>
                                    <strong style="color: var(--text);">${item.displayName}</strong>
                                </div>
                                <span style="padding: 4px 12px; background: linear-gradient(135deg, #667eea15 0%, #764ba205 100%); border-radius: 20px; font-weight: 600; font-size: 0.9em; color: #667eea;">${item.totalCost.toFixed(0)} kr</span>
                            </div>
                            <div style="height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${(item.totalCost / maxCost) * 100}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        function updateHistory() {
            const list = document.getElementById('historyList');

            if (allReceipts.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><p>No receipts yet</p></div>';
                return;
            }

            // Sort receipts by date (newest first) while preserving original index for deletion
            const sortedReceipts = allReceipts
                .map((receipt, originalIndex) => ({ receipt, originalIndex }))
                .sort((a, b) => {
                    const dateA = new Date(a.receipt.date || 0);
                    const dateB = new Date(b.receipt.date || 0);
                    return dateB - dateA; // Newest first
                });

            const historyHTML = sortedReceipts.map(({ receipt, originalIndex }) => {
                const index = originalIndex; // Use original index for deletion
                const total = receipt.total || 0;
                const storeInitial = (receipt.store || 'U')[0].toUpperCase();
                // Coral red for expenses
                const amountColor = '#f87171';

                return `
                <div style="
                    background: var(--card);
                    border: 1px solid #f3f4f6;
                    border-radius: var(--radius-medium);
                    padding: 16px;
                    margin-bottom: 12px;
                    transition: all var(--transition-fast);
                " onmouseover="this.style.boxShadow='var(--shadow-low)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <!-- Header (clickable to expand) -->
                    <div onclick="toggleExpand('hist-${index}')" style="display: flex; align-items: center; gap: 16px; cursor: pointer;">
                        <!-- Circular Icon -->
                        <div style="
                            width: 44px;
                            height: 44px;
                            border-radius: 50%;
                            background: var(--primary-alpha-10);
                            color: var(--primary);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: var(--font-weight-bold);
                            font-size: var(--font-size-lg);
                            flex-shrink: 0;
                        ">
                            ${storeInitial}
                        </div>

                        <!-- Store Info -->
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: var(--font-weight-semibold); font-size: var(--font-size-base); color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${receipt.store || 'Unknown'}
                            </div>
                            <div style="color: var(--text-tertiary); font-size: var(--font-size-sm);">
                                ${receipt.date || 'N/A'}  ${receipt.items.length} items
                            </div>
                        </div>

                        <!-- Amount -->
                        <div style="text-align: right; flex-shrink: 0;">
                            <div style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: ${amountColor};">
                                ${total.toFixed(2)} kr
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="event.stopPropagation(); viewReceiptImage(${index})" style="flex: 1; background: var(--primary-light); border: none; color: var(--primary); padding: 10px; border-radius: var(--radius-medium); cursor: pointer; font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); transition: all var(--transition-fast);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                             View Details
                        </button>
                        <button onclick="event.stopPropagation(); deleteReceipt(${index})" style="flex: 1; background: rgba(248, 113, 113, 0.1); border: none; color: #f87171; padding: 10px; border-radius: var(--radius-medium); cursor: pointer; font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); transition: all var(--transition-fast);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                             Delete
                        </button>
                    </div>

                    <!-- Expandable Items -->
                    <div class="expandable-content" id="hist-${index}-content">
                        <div class="expandable-body" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--divider);">
                            ${receipt.items.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--divider);">
                                    <div style="flex: 1;">
                                        <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: 2px;">${item.name}</div>
                                        <div style="font-size: var(--font-size-xs); color: var(--text-tertiary);">${item.category}</div>
                                    </div>
                                    <div style="font-weight: var(--font-weight-bold); color: #f87171; font-size: var(--font-size-base);">
                                        ${(item.price || 0).toFixed(2)} kr
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                `;
            }).reverse().join('');

            list.innerHTML = historyHTML;
        }

        // Data table
        let currentTableData = [];
        let currentSort = { column: 'date', direction: 'desc' };

        function updateDataTable() {
            const filter = document.getElementById('filterCategory').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            const categoryFilter = document.getElementById('filterCategory');
            if (categoryFilter.options.length === 1) {
                const cats = new Set();
                allReceipts.forEach(r => {
                    r.items.forEach(i => cats.add(i.category || 'Other'));
                });
                Array.from(cats).sort().forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    categoryFilter.appendChild(opt);
                });
            }

            currentTableData = [];
            allReceipts.forEach(receipt => {
                receipt.items.forEach((item, itemIdx) => {
                    currentTableData.push({
                        date: receipt.date || 'N/A',
                        store: receipt.store || 'Unknown',
                        item: item.name,
                        category: item.category || 'Other',
                        subcategory: item.subcategory || 'N/A',
                        price: item.price,
                        receiptId: receipt.id,
                        itemId: itemIdx,
                        tags: item.tags || []
                    });
                });
            });

            let filtered = currentTableData;
            if (filter) filtered = filtered.filter(r => r.category === filter);
            if (search) filtered = filtered.filter(r =>
                r.item.toLowerCase().includes(search) ||
                r.store.toLowerCase().includes(search)
            );

            // Apply tag filter
            if (activeTagFilter) {
                filtered = filtered.filter(r => r.tags && r.tags.includes(activeTagFilter));
            }

            filtered.sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                if (currentSort.column === 'price') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            const tbody = document.getElementById('dataTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No data found</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(row => `
                    <tr>
                        <td>${row.date}</td>
                        <td>${row.store}</td>
                        <td style="font-weight: 600;">${row.item}</td>
                        <td>${row.category}</td>
                        <td>${row.subcategory}</td>
                        <td>${renderTags(row.receiptId, row.itemId)}</td>
                        <td style="text-align: right; font-weight: 600;">${(row.price || 0).toFixed(2)} kr</td>
                    </tr>
                `).join('');
            }

            const total = filtered.reduce((sum, row) => sum + row.price, 0);
            document.getElementById('dataTableSummary').textContent =
                ` Showing ${filtered.length} items  Total: ${total.toFixed(2)} kr`;

            // Update tag filters
            updateTagFilters();

            // Generate AI insight
            generateInsight();
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            updateDataTable();
        }

        document.getElementById('searchInput')?.addEventListener('input', updateDataTable);

        // CSV Export functionality
        function exportToCSV() {
            if (allReceipts.length === 0) {
                alert('No data to export! Scan some receipts first.');
                return;
            }

            // Build CSV data
            const csvRows = [];

            // Header row
            csvRows.push(['Date', 'Store', 'Item', 'Category', 'Subcategory', 'Price (kr)', 'Receipt Total (kr)'].join(','));

            // Data rows
            allReceipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    const row = [
                        receipt.date || 'N/A',
                        `"${(receipt.store || 'Unknown').replace(/"/g, '""')}"`, // Escape quotes
                        `"${item.name.replace(/"/g, '""')}"`,
                        item.category || 'Other',
                        item.subcategory || 'N/A',
                        (item.price || 0).toFixed(2),
                        receipt.total ? receipt.total.toFixed(2) : 'N/A'
                    ];
                    csvRows.push(row.join(','));
                });
            });

            // Add summary row
            const totalSpent = allReceipts.reduce((sum, r) => sum + (r.total || 0), 0);
            const totalItems = allReceipts.reduce((sum, r) => sum + r.items.length, 0);
            csvRows.push('');
            csvRows.push(['Summary', '', '', '', '', '', ''].join(','));
            csvRows.push(['Total Receipts', allReceipts.length, '', '', '', '', ''].join(','));
            csvRows.push(['Total Items', totalItems, '', '', '', '', ''].join(','));
            csvRows.push(['Total Amount', '', '', '', '', totalSpent.toFixed(2), ''].join(','));

            // Create CSV string
            const csvString = csvRows.join('\n');

            // Create download link
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `spendy-budget-export-${today}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            alert(` Exported ${allReceipts.length} receipts (${totalItems} items) to ${filename}\n\nYou can now:\n Open it in Excel/Google Sheets\n Email it as an attachment\n Import it into other tools`);
        }
        // Function to delete a receipt
        async function deleteReceipt(index) {
            if (confirm('Are you sure you want to delete this receipt?')) {
                const receipt = allReceipts[index];

                // If receipt has a database ID, delete from Supabase
                if (receipt.id) {
                    const { error } = await _supabase
                        .from('receipts')
                        .delete()
                        .eq('id', receipt.id);

                    if (error) {
                        console.error('Error deleting from database:', error);
                        alert('Failed to delete receipt from database. Please try again.');
                        return;
                    }
                }

                // Remove the receipt from the local array
                allReceipts.splice(index, 1);

                // Save the updated list back to local storage (for offline support)
                if (typeof window.storage !== 'undefined' && window.storage) {
                    window.storage.set('receipts', JSON.stringify(allReceipts));
                } else {
                    localStorage.setItem('spendy-receipts', JSON.stringify(allReceipts));
                }

                // Refresh the UI
                updateDashboard();
                updateHistory();
                updateDataTable();

                alert('Receipt deleted!');
            }
        }

        // View receipt details in modal
        function viewReceiptImage(receiptIndex) {
            const receipt = allReceipts[receiptIndex];
            if (!receipt) return;

            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'receiptDetailsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
                overflow-y: auto;
            `;

            // Create content container
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                max-width: 700px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                position: relative;
            `;

            // Build content HTML
            content.innerHTML = `
                <div style="position: sticky; top: 0; background: var(--primary); color: white; padding: 20px; border-radius: 16px 16px 0 0; z-index: 1;">
                    <h2 style="margin: 0; font-size: 1.5em;">Receipt Details</h2>
                    <button id="closeModalBtn" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;"></button>
                </div>

                <div style="padding: 24px;">
                    <!-- Store Info -->
                    <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid #f0f0f0;">
                        <h3 style="margin: 0 0 12px 0; color: var(--primary); font-size: 1.3em;"> ${receipt.store || 'Unknown Store'}</h3>
                        <div style="color: #666; font-size: 0.95em;">
                            <div style="margin: 4px 0;"> ${receipt.date || 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 4px;">Total Amount</div>
                                <div style="font-size: 2em; font-weight: bold;">${receipt.total ? receipt.total.toFixed(2) : '0.00'} kr</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 4px;">Items</div>
                                <div style="font-size: 2em; font-weight: bold;">${receipt.items?.length || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items List -->
                    <h3 style="margin: 0 0 16px 0; color: #333;"> Items</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${receipt.items.map((item, idx) => `
                            <div style="display: flex; justify-content: space-between; align-items: start; padding: 12px; background: ${idx % 2 === 0 ? '#f9f9f9' : 'white'}; border-radius: 8px; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${item.name || 'Unknown Item'}</div>
                                    ${item.category ? `<div style="font-size: 0.85em; color: #666;">Category: ${item.category}</div>` : ''}
                                    ${item.subcategory ? `<div style="font-size: 0.85em; color: #999;">${item.subcategory}</div>` : ''}
                                    ${item.quantity && item.quantity > 1 ? `<div style="font-size: 0.85em; color: #666;">Qty: ${item.quantity}</div>` : ''}
                                </div>
                                <div style="text-align: right; margin-left: 16px;">
                                    <div style="font-size: 1.1em; font-weight: bold; color: var(--primary);">${(item.price || 0).toFixed(2)} kr</div>
                                    ${item.discount ? `<div style="font-size: 0.85em; color: var(--income-green);">-${item.discount.toFixed(2)} kr saved</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            modal.appendChild(content);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Close on ESC key
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            });

            // Add to page
            document.body.appendChild(modal);

            // Close button click handler (must be added after modal is in DOM)
            document.getElementById('closeModalBtn')?.addEventListener('click', () => {
                modal.remove();
            });
        }

        // Initialize Supabase
        const { createClient } = supabase;
        const _supabase = createClient('https://ztdvxcekvkonipdddraj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZHZ4Y2VrdmtvbmlwZGRkcmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNzU0NDYsImV4cCI6MjA4Mzg1MTQ0Nn0.FYMo-w6HomXjaclhqdOWArIcLMqA2ZakBwYfTsgS7xI');

        // Sign in function
        async function signIn() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    alert('Sign in failed: ' + error.message);
                    return;
                }

                alert(' Successfully signed in!');

                // Hide login overlay and show user status
                document.getElementById('login-overlay').style.display = 'none';
                updateUserStatus(data.user);

                // Show account tab
                document.getElementById('account-tab').style.display = 'block';

                // Load user's receipts from Supabase
                await loadLongTermData();
                loadUserPreferences();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Sign up function
        async function signUp() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                const { data, error } = await _supabase.auth.signUp({
                    email,
                    password
                });

                if (error) {
                    alert('Sign up failed: ' + error.message);
                    return;
                }

                // Check if email confirmation is required
                if (data.user && !data.session) {
                    alert(' Account created! Please check your email to verify your account before signing in.');
                    return;
                }

                alert(' Account created successfully! You are now signed in.');

                // Hide login overlay and show user status
                document.getElementById('login-overlay').style.display = 'none';
                updateUserStatus(data.user);

                // Show account tab
                document.getElementById('account-tab').style.display = 'block';

                // Load user's receipts from Supabase
                await loadLongTermData();
                loadUserPreferences();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Forgot password function
        async function forgotPassword() {
            const email = document.getElementById('email-input').value;

            if (!email) {
                alert('Please enter your email address first');
                return;
            }

            try {
                const { error } = await _supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: 'https://spendy-app-sebastian-bs-projects-93a4e006.vercel.app/'
                });

                if (error) {
                    alert('Error: ' + error.message);
                    return;
                }

                alert(' Password reset email sent! Check your inbox (and spam folder) for the reset link.');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Show password reset form
        function showPasswordResetForm() {
            const overlay = document.getElementById('login-overlay');
            overlay.style.display = 'flex';

            const card = overlay.querySelector('.card');
            card.innerHTML = `
                <div style="width: 64px; height: 64px; background: var(--primary); border-radius: var(--radius-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--spacing-lg); font-size: 32px;"></div>
                <h2 class="card-title" style="margin-bottom: var(--spacing-sm); font-size: 24px;">Reset Your Password</h2>
                <p style="margin-bottom: var(--spacing-xl); color: var(--text-tertiary); font-size: 14px;">Enter your new password below</p>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <input type="password" id="new-password-input" placeholder="New Password" style="width: 100%;">
                    <input type="password" id="confirm-password-input" placeholder="Confirm New Password" style="width: 100%;">
                    <button class="btn" onclick="updatePassword()" style="width: 100%;"><span>Update Password</span></button>
                </div>
            `;
        }

        // Update password function
        async function updatePassword() {
            const newPassword = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-password-input').value;

            if (!newPassword || !confirmPassword) {
                alert('Please enter both password fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                const { error } = await _supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    alert('Error updating password: ' + error.message);
                    return;
                }

                alert(' Password updated successfully! You can now sign in with your new password.');

                // Reload the page to show normal login
                window.location.href = window.location.origin + '/index.html';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Continue as guest function
        function continueAsGuest() {
            document.getElementById('login-overlay').style.display = 'none';
            updateUserStatus(null); // Show guest status
            loadData(); // Load local data only
            loadUserPreferences(); // Load preferences even as guest
        }

        // Update user status display
        function updateUserStatus(user) {
            const userStatus = document.getElementById('user-status');
            const guestStatus = document.getElementById('guest-status');
            const accountTab = document.getElementById('account-tab');

            if (user) {
                // Show logged-in user status
                userStatus.style.display = 'block';
                guestStatus.style.display = 'none';
                accountTab.style.display = 'block';

                // Set user email
                document.getElementById('user-email').textContent = user.email;

                // Set user avatar with first letter of email
                const firstLetter = user.email.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;
            } else {
                // Show guest status
                userStatus.style.display = 'none';
                guestStatus.style.display = 'inline-flex';
                accountTab.style.display = 'none';

                document.getElementById('user-email').textContent = '';
            }
        }

        // Toggle user dropdown menu
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userStatus = document.getElementById('user-status');
            const dropdown = document.getElementById('userDropdown');

            if (userStatus && !userStatus.contains(event.target)) {
                dropdown?.classList.remove('show');
            }
        });

        // Show login modal
        function showLoginModal() {
            document.getElementById('login-overlay').style.display = 'flex';
        }

        // Logout function
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }

            try {
                const { error } = await _supabase.auth.signOut();

                if (error) {
                    alert('Error logging out: ' + error.message);
                    return;
                }

                // Clear local data
                allReceipts = [];

                // Hide user status
                updateUserStatus(null);

                // Show login overlay again
                document.getElementById('login-overlay').style.display = 'flex';

                // Clear form fields
                document.getElementById('email-input').value = '';
                document.getElementById('password-input').value = '';

                // Reset dashboard
                updateDashboard();
                updateHistory();
                updateDataTable();

                alert(' Successfully logged out!');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Load receipts from Supabase
        async function loadLongTermData() {
            const { data: { user } } = await _supabase.auth.getUser();

            if (!user) {
                return;
            }

            const { data, error } = await _supabase
                .from('receipts')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching receipts:", error);
                return;
            }

            // Map database fields back to app's internal format
            allReceipts = data.map(r => ({
                id: r.id,  // Include database ID for deletion
                store: r.store_name,
                date: r.purchase_date,
                total: parseFloat(r.total_amount),
                items: r.items.map(item => ({
                    ...item,
                    price: item.price || item.total_price || 0  // Ensure price field exists
                })),
                image_url: r.image_url  // Include image URL for viewing
            }));

            updateDashboard();
            updateHistory();
            updateDataTable();
        }

        // Check if URL contains password recovery token
        function checkForPasswordRecovery() {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const type = hashParams.get('type');

            if (type === 'recovery') {
                showPasswordResetForm();
                return true;
            }
            return false;
        }

        // Check on page load
        if (!checkForPasswordRecovery()) {
            // Check if user is already logged in on page load
            _supabase.auth.onAuthStateChange((event, session) => {
                // Handle password recovery
                if (event === 'PASSWORD_RECOVERY') {
                    showPasswordResetForm();
                    return;
                }

                if (session && session.user) {
                    document.getElementById('login-overlay').style.display = 'none';
                    updateUserStatus(session.user);
                    loadLongTermData();
                    loadUserPreferences();
                    document.getElementById('account-tab').style.display = 'block';
                } else {
                    updateUserStatus(null);
                    document.getElementById('account-tab').style.display = 'none';
                }
            });
        }

        // ============ ACCOUNT MANAGEMENT FUNCTIONS ============

        // Load user preferences from localStorage
        function loadUserPreferences() {
            const saved = localStorage.getItem('spendy-preferences');
            if (saved) {
                userPreferences = JSON.parse(saved);

                // Apply preferences
                document.getElementById('currency-select').value = userPreferences.currency || 'kr';
                document.getElementById('display-name-input').value = userPreferences.displayName || '';
                document.getElementById('profile-pic-input').value = userPreferences.profilePic || '';

                if (userPreferences.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('theme-toggle-text').textContent = ' Disable Dark Mode';
                }

                if (userPreferences.profilePic) {
                    showProfilePicPreview(userPreferences.profilePic);
                }

                // Update display name in header if available
                if (userPreferences.displayName) {
                    const emailSpan = document.getElementById('user-email');
                    emailSpan.textContent = userPreferences.displayName;
                }
            }
        }

        // Profile picture preview
        document.getElementById('profile-pic-input')?.addEventListener('input', (e) => {
            const url = e.target.value;
            if (url) {
                showProfilePicPreview(url);
            }
        });

        function showProfilePicPreview(url) {
            const preview = document.getElementById('profile-pic-preview');
            const img = document.getElementById('profile-pic-img');
            img.src = url;
            img.onerror = () => {
                preview.style.display = 'none';
                alert('Invalid image URL');
            };
            img.onload = () => {
                preview.style.display = 'block';
            };
        }

        // Update Profile
        async function updateProfile() {
            const displayName = document.getElementById('display-name-input').value;
            const profilePic = document.getElementById('profile-pic-input').value;

            userPreferences.displayName = displayName;
            userPreferences.profilePic = profilePic;

            localStorage.setItem('spendy-preferences', JSON.stringify(userPreferences));

            // Update display in header
            const emailSpan = document.getElementById('user-email');
            if (displayName) {
                emailSpan.textContent = displayName;
            } else {
                const { data: { user } } = await _supabase.auth.getUser();
                if (user) {
                    emailSpan.textContent = user.email;
                }
            }

            alert(' Profile updated successfully!');
        }

        // Change Password
        async function changePassword() {
            const newPassword = document.getElementById('account-new-password-input').value;
            const confirmPassword = document.getElementById('account-confirm-password-input').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in both password fields');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            try {
                const { error } = await _supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    alert('Failed to update password: ' + error.message);
                    return;
                }

                alert(' Password updated successfully!');
                document.getElementById('new-password-input').value = '';
                document.getElementById('confirm-password-input').value = '';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Save Preferences (Currency)
        function savePreferences() {
            const currency = document.getElementById('currency-select').value;
            userPreferences.currency = currency;

            localStorage.setItem('spendy-preferences', JSON.stringify(userPreferences));

            // Refresh displays with new currency
            updateDashboard();
            updateHistory();
            updateDataTable();

            alert(' Preferences saved! Currency changed to ' + currency);
        }

        // Toggle Dark Mode
        function toggleDarkMode() {
            userPreferences.darkMode = !userPreferences.darkMode;
            localStorage.setItem('spendy-preferences', JSON.stringify(userPreferences));

            document.body.classList.toggle('dark-mode');

            const toggleText = document.getElementById('theme-toggle-text');
            if (userPreferences.darkMode) {
                toggleText.textContent = ' Disable Dark Mode';
            } else {
                toggleText.textContent = ' Enable Dark Mode';
            }
        }

        // Export All Data as JSON
        function exportAllDataJSON() {
            if (allReceipts.length === 0) {
                alert('No data to export! Scan some receipts first.');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                preferences: userPreferences,
                receipts: allReceipts,
                summary: {
                    totalReceipts: allReceipts.length,
                    totalSpent: allReceipts.reduce((sum, r) => sum + (r.total || 0), 0),
                    totalItems: allReceipts.reduce((sum, r) => sum + r.items.length, 0)
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `spendy-backup-${today}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert(` Exported ${allReceipts.length} receipts as JSON backup`);
        }

        // Delete Account
        async function deleteAccount() {
            const confirmation = prompt(' WARNING: This will permanently delete your account and ALL data.\n\nType "DELETE" to confirm:');

            if (confirmation !== 'DELETE') {
                alert('Account deletion cancelled.');
                return;
            }

            const { data: { user } } = await _supabase.auth.getUser();

            if (!user) {
                alert('You must be logged in to delete your account');
                return;
            }

            try {
                // Delete all user receipts from database
                const { error: deleteError } = await _supabase
                    .from('receipts')
                    .delete()
                    .eq('user_id', user.id);

                if (deleteError) {
                    console.error('Error deleting receipts:', deleteError);
                }

                // Sign out and clear local data
                await _supabase.auth.signOut();
                localStorage.removeItem('spendy-receipts');
                localStorage.removeItem('spendy-preferences');
                allReceipts = [];

                // Reset UI
                updateUserStatus(null);
                document.getElementById('login-overlay').style.display = 'flex';
                updateDashboard();
                updateHistory();
                updateDataTable();

                alert(' Account deleted successfully. We\'re sorry to see you go!');
            } catch (err) {
                alert('Error deleting account: ' + err.message);
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            const currency = userPreferences.currency || 'kr';
            if (currency === 'kr') {
                return amount.toFixed(2) + ' kr';
            } else {
                return currency + amount.toFixed(2);
            }
        }

        // ============ GAMIFICATION FUNCTIONS ============

        // Load gamification data from Supabase
        async function loadGamificationData() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;

                // Get user progress
                const { data: progressData, error: progressError } = await _supabase
                    .rpc('get_user_progress', { p_user_id: user.id });

                if (progressError) {
                    console.error('Error loading progress:', progressError);
                    return;
                }

                if (progressData && progressData.length > 0) {
                    const progress = progressData[0];
                    updateProgressUI(progress);
                }

                // Get active savings goal
                const { data: goalData, error: goalError } = await _supabase
                    .rpc('get_active_savings_goal', { p_user_id: user.id });

                if (goalError) {
                    console.error('Error loading goal:', goalError);
                }

                if (goalData && goalData.length > 0) {
                    const goal = goalData[0];
                    updateGoalUI(goal);
                } else {
                    showCreateGoalCard();
                }

            } catch (error) {
                console.error('Error loading gamification data:', error);
            }
        }

        // Update progress UI (Level, XP, Stats)
        function updateProgressUI(progress) {
            // Update level card
            document.getElementById('userLevel').textContent = progress.current_level;
            document.getElementById('levelName').textContent = progress.level_name;
            document.getElementById('totalXP').textContent = progress.total_xp;
            document.getElementById('xpToNext').textContent = progress.xp_for_next_level;
            document.getElementById('xpProgressPercent').textContent = progress.xp_progress_percent;
            document.getElementById('nextLevel').textContent = progress.current_level + 1;

            // Update progress bar
            const progressBar = document.getElementById('xpProgressBar');
            progressBar.style.width = progress.xp_progress_percent + '%';

            // Update stats card
            document.getElementById('receiptsThisMonth').textContent = progress.receipts_this_month;
            document.getElementById('totalSavings').textContent = progress.total_savings.toFixed(2);
            document.getElementById('biggestReceipt').textContent = progress.biggest_receipt.toFixed(2);
            document.getElementById('biggestDiscount').textContent = progress.biggest_discount.toFixed(2);
        }

        // Update goal UI
        function updateGoalUI(goal) {
            document.getElementById('savingsGoalCard').style.display = 'block';
            document.getElementById('createGoalCard').style.display = 'none';

            document.getElementById('goalCurrent').textContent = goal.current_amount.toFixed(0);
            document.getElementById('goalTarget').textContent = goal.target_amount.toFixed(0);
            document.getElementById('goalProgressPercent').textContent = goal.progress_percent;
            document.getElementById('goalDaysRemaining').textContent = goal.days_remaining;

            // Update progress bar
            const progressBar = document.getElementById('goalProgressBar');
            progressBar.style.width = Math.min(goal.progress_percent, 100) + '%';
            if (goal.progress_percent > 0) {
                progressBar.textContent = goal.progress_percent + '%';
            }
        }

        // Show create goal card
        function showCreateGoalCard() {
            document.getElementById('savingsGoalCard').style.display = 'none';
            document.getElementById('createGoalCard').style.display = 'block';
        }

        // Show goal modal
        function showGoalModal() {
            document.getElementById('goalModal').style.display = 'flex';
        }

        // Close goal modal
        function closeGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        // Save savings goal
        async function saveGoal() {
            const target = parseFloat(document.getElementById('goalTargetInput').value);

            if (!target || target <= 0) {
                showToast('Please enter a valid savings target', 'error');
                return;
            }

            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) {
                    showToast('You must be logged in to set goals', 'error');
                    return;
                }

                // Deactivate any existing goals
                await _supabase
                    .from('savings_goals')
                    .update({ is_active: false })
                    .eq('user_id', user.id)
                    .eq('is_active', true);

                // Create new goal for current month
                const startDate = new Date();
                startDate.setDate(1); // First day of month
                const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0); // Last day of month

                const { error } = await _supabase
                    .from('savings_goals')
                    .insert([{
                        user_id: user.id,
                        target_amount: target,
                        current_amount: 0,
                        goal_type: 'monthly',
                        start_date: startDate.toISOString().split('T')[0],
                        end_date: endDate.toISOString().split('T')[0],
                        is_active: true
                    }]);

                if (error) throw error;

                showToast(`Goal set! Save ${target} kr in discounts this month`, 'success');
                closeGoalModal();
                await loadGamificationData();

            } catch (error) {
                console.error('Error saving goal:', error);
                showToast('Error setting goal: ' + error.message, 'error');
            }
        }

        // Show quick stats after receipt upload (Feature #10)
        async function showQuickStats(receiptData) {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;

                // Get updated stats
                const { data: stats } = await _supabase
                    .rpc('get_user_progress', { p_user_id: user.id });

                if (stats && stats.length > 0) {
                    const progress = stats[0];
                    const savings = receiptData._financial?.total_discounts || 0;

                    let message = `Receipt #${progress.receipts_this_month} this month!`;
                    if (savings > 0) {
                        message += ` You saved ${savings.toFixed(2)} kr on this receipt.`;
                    }

                    // Check for level up
                    checkForLevelUp(progress.current_level);

                    // Check for goal completion
                    await checkGoalCompletion();

                    showToast(message, 'success', 'Receipt Saved!');
                    triggerConfetti();
                }
            } catch (error) {
                console.error('Error showing quick stats:', error);
            }
        }

        // Check if user leveled up
        let lastKnownLevel = null;

        function checkForLevelUp(currentLevel) {
            if (lastKnownLevel !== null && currentLevel > lastKnownLevel) {
                showLevelUpModal(currentLevel);
            }
            lastKnownLevel = currentLevel;
        }

        // Show level up modal
        function showLevelUpModal(level) {
            const levelNames = {
                1: 'Bronze',
                5: 'Silver',
                10: 'Gold',
                15: 'Diamond',
                20: 'Platinum'
            };

            let levelName = 'Bronze';
            for (let l in levelNames) {
                if (level >= parseInt(l)) levelName = levelNames[l];
            }

            document.getElementById('newLevelNumber').textContent = level;
            document.getElementById('newLevelName').textContent = levelName;
            document.getElementById('levelUpModal').style.display = 'flex';
            triggerConfetti();
        }

        // Close level up modal
        function closeLevelUpModal() {
            document.getElementById('levelUpModal').style.display = 'none';
        }

        // Check if savings goal was completed
        async function checkGoalCompletion() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;

                const { data: goalData } = await _supabase
                    .rpc('get_active_savings_goal', { p_user_id: user.id });

                if (goalData && goalData.length > 0) {
                    const goal = goalData[0];
                    if (goal.is_completed && goal.progress_percent >= 100) {
                        showGoalCompletedModal(goal.current_amount);
                    }
                }
            } catch (error) {
                console.error('Error checking goal completion:', error);
            }
        }

        // Show goal completed modal
        function showGoalCompletedModal(amount) {
            document.getElementById('goalAmountSaved').textContent = amount.toFixed(0);
            document.getElementById('goalCompletedModal').style.display = 'flex';
            triggerConfetti();
        }

        // Close goal completed modal
        function closeGoalCompletedModal() {
            document.getElementById('goalCompletedModal').style.display = 'none';
        }

        // Trigger confetti animation
        function triggerConfetti() {
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A78BFA', '#95E1D3', '#FF8E53'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 5000);
                }, i * 30);
            }
        }

        // ===== BUDGETING FUNCTIONS =====

        // Load and display budget data
        async function loadBudgetData() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;

            try {
                // Get budget overview
                const { data: overviewData, error: overviewError } = await _supabase
                    .rpc('get_budget_overview', { p_user_id: user.id });

                // Get budget status for all categories
                const { data: budgetsData, error: budgetsError } = await _supabase
                    .rpc('get_budget_status', { p_user_id: user.id });

                if (overviewError) {
                    console.error('Error loading budget overview:', overviewError);
                    return;
                }

                if (budgetsError) {
                    console.error('Error loading budgets:', budgetsError);
                    return;
                }

                // Show/hide cards based on whether budgets exist
                const hasBudgets = budgetsData && budgetsData.length > 0;
                document.getElementById('budgetOverviewCard').style.display = hasBudgets ? 'block' : 'none';
                document.getElementById('createBudgetCard').style.display = hasBudgets ? 'none' : 'block';

                if (hasBudgets && overviewData && overviewData.length > 0) {
                    updateBudgetOverviewUI(overviewData[0]);
                    updateCategoryBudgetsUI(budgetsData);
                }
            } catch (err) {
                console.error('Error loading budgets:', err);
            }
        }

        // Update budget overview UI
        function updateBudgetOverviewUI(overview) {
            document.getElementById('totalBudget').textContent = overview.total_budget.toFixed(0);
            document.getElementById('totalSpent').textContent = overview.total_spent.toFixed(0);
            document.getElementById('totalRemaining').textContent = overview.total_remaining.toFixed(0);
            document.getElementById('budgetDaysLeft').textContent = overview.days_left;

            const percentUsed = overview.percent_used || 0;
            const progressBar = document.getElementById('totalBudgetProgressBar');
            progressBar.style.width = Math.min(percentUsed, 100) + '%';

            // Change color based on usage
            if (percentUsed > 100) {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            } else if (percentUsed > 80) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            }
        }

        // Update category budgets UI
        function updateCategoryBudgetsUI(budgets) {
            const container = document.getElementById('categoryBudgets');
            container.innerHTML = '';

            budgets.forEach(budget => {
                const percentUsed = budget.percent_used || 0;
                const statusColor = budget.status === 'exceeded' ? '#ef4444' :
                                   budget.status === 'warning' ? '#f59e0b' : '#10b981';
                const statusIcon = budget.status === 'exceeded' ? '' :
                                  budget.status === 'warning' ? '' : '';

                const categoryCard = document.createElement('div');
                categoryCard.style.cssText = 'padding: 16px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px;';
                categoryCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 4px;">${budget.category}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">
                                <span style="font-weight: 600; color: ${statusColor};">${budget.spent.toFixed(0)} kr</span>
                                of ${budget.budget_limit.toFixed(0)} kr
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.8em;">${statusIcon}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${percentUsed.toFixed(0)}%</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(percentUsed, 100)}%; height: 100%; background: ${statusColor}; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                        <span>${budget.remaining.toFixed(0)} kr remaining</span>
                        <button onclick="editBudget('${budget.budget_id}', '${budget.category}', ${budget.budget_limit})"
                                style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline;">
                            Edit
                        </button>
                    </div>
                `;

                container.appendChild(categoryCard);
            });
        }

        // Show budget modal
        function showBudgetModal() {
            document.getElementById('budgetModal').style.display = 'flex';
            document.getElementById('budgetCategoryInput').value = '';
            document.getElementById('budgetLimitInput').value = '';
        }

        // Close budget modal
        function closeBudgetModal() {
            document.getElementById('budgetModal').style.display = 'none';
        }

        // Save budget
        async function saveBudget() {
            const category = document.getElementById('budgetCategoryInput').value;
            const limit = parseFloat(document.getElementById('budgetLimitInput').value);

            if (!category) {
                showToast('Please select a category', 'error');
                return;
            }

            if (!limit || limit <= 0) {
                showToast('Please enter a valid budget amount', 'error');
                return;
            }

            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) {
                showToast('Please sign in to set budgets', 'error');
                return;
            }

            try {
                // Insert or update budget
                const { error } = await _supabase
                    .from('category_budgets')
                    .upsert({
                        user_id: user.id,
                        category: category,
                        monthly_limit: limit,
                        start_date: new Date().toISOString().split('T')[0].substring(0, 7) + '-01',
                        is_active: true
                    }, {
                        onConflict: 'user_id,category,start_date'
                    });

                if (error) {
                    console.error('Error saving budget:', error);
                    showToast('Error saving budget: ' + error.message, 'error');
                    return;
                }

                showToast(`Budget set for ${category}: ${limit.toFixed(0)} kr/month`, 'success');
                closeBudgetModal();
                await loadBudgetData();

            } catch (err) {
                console.error('Error:', err);
                showToast('Error saving budget', 'error');
            }
        }

        // Edit budget
        async function editBudget(budgetId, category, currentLimit) {
            document.getElementById('budgetCategoryInput').value = category;
            document.getElementById('budgetLimitInput').value = currentLimit;
            showBudgetModal();
        }

        // Delete budget
        async function deleteBudget(budgetId) {
            if (!confirm('Are you sure you want to delete this budget?')) {
                return;
            }

            try {
                const { error } = await _supabase
                    .from('category_budgets')
                    .delete()
                    .eq('id', budgetId);

                if (error) {
                    console.error('Error deleting budget:', error);
                    showToast('Error deleting budget', 'error');
                    return;
                }

                showToast('Budget deleted', 'success');
                await loadBudgetData();
            } catch (err) {
                console.error('Error:', err);
                showToast('Error deleting budget', 'error');
            }
        }

        // Check for budget alerts after receipt is saved
        async function checkBudgetAlerts(receiptId) {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;

            try {
                const { data: alerts, error } = await _supabase
                    .rpc('check_budget_alerts', {
                        p_user_id: user.id,
                        p_receipt_id: receiptId
                    });

                if (error) {
                    console.error('Error checking budget alerts:', error);
                    return;
                }

                // Show alerts
                if (alerts && alerts.length > 0) {
                    alerts.forEach(alert => {
                        const alertType = alert.alert_type === 'exceeded' ? 'error' : 'warning';
                        const icon = alert.alert_type === 'exceeded' ? '' : '';
                        showToast(alert.message, alertType, icon + ' Budget Alert');
                    });
                }

                // Reload budget data to show updated progress
                await loadBudgetData();
            } catch (err) {
                console.error('Error checking alerts:', err);
            }
        }

        // ===== ENHANCED BUDGET GOALS FUNCTIONS =====

        // Update Budget Goals Tab UI
        async function updateBudgetGoalsUI() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;

            try {
                // Get current month's spending by category
                const currentMonthStart = new Date();
                currentMonthStart.setDate(1);
                currentMonthStart.setHours(0, 0, 0, 0);

                const categorySpending = {};
                allReceipts.forEach(receipt => {
                    const receiptDate = new Date(receipt.date);
                    if (receiptDate >= currentMonthStart) {
                        receipt.items.forEach(item => {
                            const cat = item.category || 'Other';
                            categorySpending[cat] = (categorySpending[cat] || 0) + (item.price || 0);
                        });
                    }
                });

                // Get budgets from Supabase
                const { data: budgetsData, error } = await _supabase
                    .rpc('get_budget_status', { p_user_id: user.id });

                if (error) {
                    console.error('Error loading budget status:', error);
                    return;
                }

                // Calculate budget health score
                let healthScore = 100;
                let totalBudget = 0;
                let totalSpent = 0;
                const alerts = [];

                if (budgetsData && budgetsData.length > 0) {
                    budgetsData.forEach(budget => {
                        totalBudget += budget.budget_limit;
                        totalSpent += budget.spent;

                        if (budget.status === 'exceeded') {
                            healthScore -= 30;
                            alerts.push({
                                category: budget.category,
                                message: `${budget.category} budget exceeded by ${(budget.spent - budget.budget_limit).toFixed(0)} kr`,
                                type: 'danger'
                            });
                        } else if (budget.status === 'warning') {
                            healthScore -= 10;
                            alerts.push({
                                category: budget.category,
                                message: `${budget.category} at ${budget.percent_used.toFixed(0)}% of budget`,
                                type: 'warning'
                            });
                        }
                    });

                    healthScore = Math.max(0, healthScore);

                    // Update health score
                    document.getElementById('budgetHealthScore').textContent = healthScore + '/100';
                    const healthMessage = healthScore >= 80 ? 'Excellent budget management! ' :
                                        healthScore >= 60 ? 'Good progress, watch a few categories' :
                                        healthScore >= 40 ? 'Some budgets need attention' :
                                        'Multiple budgets exceeded - time to review';
                    document.getElementById('budgetHealthMessage').textContent = healthMessage;

                    // Render budget cards
                    renderActiveBudgets(budgetsData);

                    // Show/hide alerts
                    if (alerts.length > 0) {
                        renderBudgetAlerts(alerts);
                        document.getElementById('budgetAlertsSection').style.display = 'block';
                    } else {
                        document.getElementById('budgetAlertsSection').style.display = 'none';
                    }
                } else {
                    document.getElementById('budgetHealthScore').textContent = '-';
                    document.getElementById('budgetHealthMessage').textContent = 'Set budgets to track your spending';
                }

                // Update monthly spending summary
                renderMonthlySpendingSummary(categorySpending);

            } catch (err) {
                console.error('Error updating budget goals UI:', err);
            }
        }

        // Render active budget cards
        function renderActiveBudgets(budgets) {
            const container = document.getElementById('activeBudgetsGrid');

            if (!budgets || budgets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-tertiary);">
                        <div style="font-size: 4em; margin-bottom: 16px; opacity: 0.3;"></div>
                        <h3 style="font-size: 1.3em; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">No budgets yet</h3>
                        <p style="font-size: 0.95em; margin-bottom: 24px;">Start by creating your first budget or use smart recommendations</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = budgets.map(budget => {
                const percentUsed = budget.percent_used || 0;
                // Coral Red for expenses (over budget), Emerald Green for good standing
                const statusColor = budget.status === 'exceeded' ? '#f87171' :  // Coral red
                                   budget.status === 'warning' ? 'var(--warning-yellow)' :
                                   '#10b981';  // Emerald green

                // Category icon (first letter)
                const categoryIcon = (budget.category || 'B')[0].toUpperCase();

                return `
                    <div style="
                        background: var(--card);
                        border: 1px solid #f3f4f6;
                        border-radius: var(--radius-medium);
                        padding: 20px;
                        margin-bottom: 12px;
                        transition: all var(--transition-fast);
                    " onmouseover="this.style.boxShadow='var(--shadow-low)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                        <!-- Header with Icon and Edit -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- Circular Category Icon -->
                                <div style="
                                    width: 44px;
                                    height: 44px;
                                    border-radius: 50%;
                                    background: var(--primary-alpha-10);
                                    color: var(--primary);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: var(--font-weight-bold);
                                    font-size: var(--font-size-lg);
                                    flex-shrink: 0;
                                ">
                                    ${categoryIcon}
                                </div>
                                <div>
                                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary);">
                                        ${budget.category}
                                    </div>
                                    <div style="font-size: var(--font-size-sm); color: var(--text-tertiary);">
                                        Monthly Budget
                                    </div>
                                </div>
                            </div>
                            <button onclick="editBudget('${budget.budget_id}', '${budget.category}', ${budget.budget_limit})"
                                    style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: var(--font-size-lg); padding: 8px;">
                                
                            </button>
                        </div>

                        <!-- Spent vs Budget (flex justify-between) -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Spent
                                </div>
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: #f87171;">
                                    ${budget.spent.toFixed(0)} kr
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${budget.remaining >= 0 ? 'Remaining' : 'Over'}
                                </div>
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: ${budget.remaining >= 0 ? '#10b981' : '#f87171'};">
                                    ${Math.abs(budget.remaining).toFixed(0)} kr
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div style="width: 100%; height: 8px; background: var(--divider); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                            <div style="width: ${Math.min(percentUsed, 100)}%; height: 100%; background: ${statusColor}; transition: width 0.5s ease;"></div>
                        </div>

                        <!-- Budget Limit Info -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                Budget: ${budget.budget_limit.toFixed(0)} kr
                            </div>
                            <div style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: ${statusColor};">
                                ${Math.min(percentUsed, 100).toFixed(0)}% used
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render budget alerts
        function renderBudgetAlerts(alerts) {
            const container = document.getElementById('budgetAlertsList');
            container.innerHTML = alerts.map(alert => {
                const bgColor = alert.type === 'danger' ? 'rgba(230, 57, 70, 0.1)' : 'rgba(244, 162, 97, 0.1)';
                const borderColor = alert.type === 'danger' ? 'var(--error-red)' : 'var(--warning-yellow)';
                const icon = alert.type === 'danger' ? '' : '';

                return `
                    <div style="padding: 16px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: var(--radius-medium); margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 24px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: 4px;">
                                    ${alert.category}
                                </div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                    ${alert.message}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render monthly spending summary
        function renderMonthlySpendingSummary(categorySpending) {
            const container = document.getElementById('monthlySpendingSummary');
            const categories = Object.entries(categorySpending).sort((a, b) => b[1] - a[1]);

            if (categories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No spending this month yet</p>';
                return;
            }

            const total = categories.reduce((sum, [_, amount]) => sum + amount, 0);

            container.innerHTML = categories.map(([category, amount]) => {
                const percentage = (amount / total * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: var(--font-weight-semibold); color: var(--text-primary);">${category}</span>
                            <span style="font-weight: var(--font-weight-bold); color: var(--text-primary);">${amount.toFixed(0)} kr</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--divider); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: var(--primary); transition: width 0.5s ease;"></div>
                        </div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: 4px;">
                            ${percentage}% of total spending
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show smart budget recommendations
        async function showSmartRecommendations() {
            // Calculate average spending per category over last 3 months
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            const categoryTotals = {};
            const categoryMonths = {};

            allReceipts.forEach(receipt => {
                const receiptDate = new Date(receipt.date);
                if (receiptDate >= threeMonthsAgo) {
                    receipt.items.forEach(item => {
                        const cat = item.category || 'Other';
                        const month = receiptDate.toISOString().substring(0, 7);

                        if (!categoryTotals[cat]) {
                            categoryTotals[cat] = 0;
                            categoryMonths[cat] = new Set();
                        }
                        categoryTotals[cat] += item.price || 0;
                        categoryMonths[cat].add(month);
                    });
                }
            });

            // Calculate averages and create recommendations
            const recommendations = Object.entries(categoryTotals).map(([category, total]) => {
                const monthCount = categoryMonths[category].size || 1;
                const avgMonthly = total / monthCount;
                const suggestedBudget = Math.ceil(avgMonthly * 1.1 / 50) * 50; // Round up to nearest 50, add 10% buffer

                return { category, avgMonthly, suggestedBudget };
            }).sort((a, b) => b.avgMonthly - a.avgMonthly);

            if (recommendations.length === 0) {
                showToast('Not enough spending history for recommendations', 'info');
                return;
            }

            // Show recommendations modal
            const modal = document.createElement('div');
            modal.id = 'budgetRecommendationsModal';
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div class="card" style="max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <h2 class="card-title"> Smart Budget Recommendations</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">Based on your last 3 months of spending</p>

                    ${recommendations.map(rec => `
                        <div style="padding: 16px; border: 1px solid var(--border); border-radius: var(--radius-medium); margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary);">${rec.category}</div>
                                <div style="font-weight: var(--font-weight-bold); color: var(--primary); font-size: var(--font-size-lg);">
                                    ${rec.suggestedBudget} kr
                                </div>
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                Avg: ${rec.avgMonthly.toFixed(0)} kr/month
                            </div>
                            <button onclick="applyRecommendedBudget('${rec.category}', ${rec.suggestedBudget}); this.disabled=true; this.textContent='Applied ';"
                                    class="btn" style="width: 100%; margin-top: 12px; padding: 8px;">
                                <span>Apply This Budget</span>
                            </button>
                        </div>
                    `).join('')}

                    <button onclick="closeBudgetRecommendationsModal()" class="btn btn-secondary" style="width: 100%; margin-top: 16px;">
                        <span>Close</span>
                    </button>
                </div>
            `;

            // Add click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'budgetRecommendationsModal') {
                    closeBudgetRecommendationsModal();
                }
            });

            document.body.appendChild(modal);
        }

        // Apply recommended budget
        async function applyRecommendedBudget(category, amount) {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) {
                showToast('Please sign in to set budgets', 'error');
                return;
            }

            try {
                const { error } = await _supabase
                    .from('category_budgets')
                    .upsert({
                        user_id: user.id,
                        category: category,
                        monthly_limit: amount,
                        start_date: new Date().toISOString().split('T')[0].substring(0, 7) + '-01',
                        is_active: true
                    }, {
                        onConflict: 'user_id,category,start_date'
                    });

                if (error) {
                    console.error('Error applying budget:', error);
                    showToast('Error applying budget', 'error');
                    return;
                }

                showToast(`Budget set for ${category}: ${amount} kr/month`, 'success');
                await loadBudgetData();
                await updateBudgetGoalsUI();
            } catch (err) {
                console.error('Error:', err);
                showToast('Error applying budget', 'error');
            }
        }

        // Open budget modal (enhanced)
        function openBudgetModal(mode, category = '', amount = 0) {
            if (mode === 'new') {
                document.getElementById('budgetCategoryInput').value = '';
                document.getElementById('budgetLimitInput').value = '';
            } else {
                document.getElementById('budgetCategoryInput').value = category;
                document.getElementById('budgetLimitInput').value = amount;
            }
            showBudgetModal();
        }

        // Initialize gamification when user logs in
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                await loadGamificationData();
                await loadBudgetData();
            }
        });

        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log(' Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, show elegant update banner
                                    showUpdateBanner();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log(' Service Worker registration failed:', error);
                    });
            });
        }

        // Show elegant update banner when new version is available
        function showUpdateBanner() {
            // Check if banner already exists
            if (document.getElementById('updateBanner')) return;

            const banner = document.createElement('div');
            banner.id = 'updateBanner';
            banner.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
                z-index: 100000;
                display: flex;
                align-items: center;
                gap: 16px;
                font-weight: 500;
                animation: slideDown 0.3s ease-out;
                max-width: 90%;
            `;

            banner.innerHTML = `
                <span style="font-size: 24px;"></span>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">New Version Available!</div>
                    <div style="font-size: 13px; opacity: 0.9;">Update now to get the latest features</div>
                </div>
                <button id="updateNowBtn" style="
                    background: white;
                    color: #059669;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">Update Now</button>
                <button id="updateLaterBtn" style="
                    background: transparent;
                    color: white;
                    border: 1px solid rgba(255, 255, 255, 0.5);
                    padding: 8px 16px;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">Later</button>
            `;

            // Add animation keyframes
            if (!document.getElementById('updateBannerStyle')) {
                const style = document.createElement('style');
                style.id = 'updateBannerStyle';
                style.textContent = `
                    @keyframes slideDown {
                        from {
                            transform: translateX(-50%) translateY(-100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(-50%) translateY(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(banner);

            // Update now button
            document.getElementById('updateNowBtn').addEventListener('click', () => {
                window.location.reload();
            });

            // Later button - hide banner
            document.getElementById('updateLaterBtn').addEventListener('click', () => {
                banner.style.animation = 'slideDown 0.3s ease-out reverse';
                setTimeout(() => banner.remove(), 300);
            });

            // Auto-hide after 10 seconds if no action
            setTimeout(() => {
                if (document.getElementById('updateBanner')) {
                    banner.style.animation = 'slideDown 0.3s ease-out reverse';
                    setTimeout(() => banner.remove(), 300);
                }
            }, 10000);
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.id = 'installButton';
        installButton.textContent = ' Install App';
        installButton.style.cssText = `
            position: fixed;
            bottom: 80px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, #4a90e2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(91, 168, 159, 0.3);
            z-index: 10000;
            display: none;
            font-size: 14px;
            transition: transform 0.2s;
        `;
        installButton.onmouseover = () => { installButton.style.transform = 'scale(1.05)'; };
        installButton.onmouseout = () => { installButton.style.transform = 'scale(1)'; };
        document.body.appendChild(installButton);

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing
            e.preventDefault();
            // Store the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            installButton.style.display = 'block';

            installButton.addEventListener('click', async () => {
                // Hide the install button
                installButton.style.display = 'none';
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user's response
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                // Clear the deferred prompt
                deferredPrompt = null;
            });
        });

        // Hide install button when app is installed
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            console.log(' PWA installed successfully');
            // Optional: Show a toast notification
            showToast('App installed! You can now use Spendy offline.', 'success');
        });

        // Detect if app is running as installed PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }

        if (isPWA()) {
            console.log(' Running as installed PWA');
            // Optional: Hide install button if already installed
            installButton.style.display = 'none';
        }

        // ============ ANALYTICS FUNCTIONS ============

        let currentAnalyticsPeriod = 'week';

        // Category colors for donut chart
        const categoryColors = {
            'Groceries': '#27AE60',
            'Dining': '#E67E22',
            'Transport': '#3498DB',
            'Entertainment': '#9B59B6',
            'Shopping': '#E74C3C',
            'Healthcare': '#1ABC9C',
            'Household': '#F39C12',
            'Personal Care': '#E91E63',
            'Other': '#95A5A6'
        };

        function setAnalyticsPeriod(period) {
            currentAnalyticsPeriod = period;

            // Update toggle buttons
            document.querySelectorAll('.time-toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`toggle-${period}`).classList.add('active');

            // Refresh analytics
            updateAnalytics();
        }

        function updateAnalytics() {
            const data = getAnalyticsData(currentAnalyticsPeriod);
            renderDonutChart(data.categoryBreakdown, data.totalSpent);
            renderAreaChart(data.trendData);
            updateQuickStats(data);
            renderTopSpending(data.categoryBreakdown, data.totalSpent);
        }

        function getAnalyticsData(period) {
            const now = new Date();
            let startDate;

            // Calculate start date based on period
            if (period === 'week') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
            } else if (period === 'month') {
                startDate = new Date(now);
                startDate.setMonth(now.getMonth() - 1);
            } else if (period === 'year') {
                startDate = new Date(now);
                startDate.setFullYear(now.getFullYear() - 1);
            }

            // Filter receipts within the period
            const periodReceipts = allReceipts.filter(receipt => {
                const receiptDate = new Date(receipt.purchase_date || receipt.date);
                return receiptDate >= startDate && receiptDate <= now;
            });

            // Calculate category breakdown
            const categoryBreakdown = {};
            let totalSpent = 0;

            periodReceipts.forEach(receipt => {
                if (receipt.items) {
                    receipt.items.forEach(item => {
                        const category = item.category || 'Other';
                        const price = item.total_price || item.price || 0;

                        if (!categoryBreakdown[category]) {
                            categoryBreakdown[category] = 0;
                        }
                        categoryBreakdown[category] += price;
                        totalSpent += price;
                    });
                }
            });

            // Calculate trend data
            const trendData = calculateTrendData(periodReceipts, period, startDate, now);

            // Calculate stats
            const daysInPeriod = period === 'week' ? 7 : period === 'month' ? 30 : 365;
            const avgPerDay = totalSpent / daysInPeriod;
            const topCategory = Object.entries(categoryBreakdown)
                .sort((a, b) => b[1] - a[1])[0]?.[0] || 'None';
            const transactionCount = periodReceipts.length;

            return {
                categoryBreakdown,
                totalSpent,
                trendData,
                avgPerDay,
                topCategory,
                transactionCount
            };
        }

        function calculateTrendData(receipts, period, startDate, endDate) {
            const dataPoints = period === 'week' ? 7 : period === 'month' ? 30 : 12;
            const trendData = [];

            if (period === 'year') {
                // Group by month for year view
                for (let i = 0; i < 12; i++) {
                    const monthStart = new Date(startDate);
                    monthStart.setMonth(startDate.getMonth() + i);
                    const monthEnd = new Date(monthStart);
                    monthEnd.setMonth(monthStart.getMonth() + 1);

                    const monthReceipts = receipts.filter(r => {
                        const date = new Date(r.purchase_date || r.date);
                        return date >= monthStart && date < monthEnd;
                    });

                    const monthTotal = monthReceipts.reduce((sum, r) => {
                        const total = r.total_amount || r.total || 0;
                        return sum + total;
                    }, 0);

                    trendData.push({
                        label: monthStart.toLocaleDateString('en-US', { month: 'short' }),
                        value: monthTotal
                    });
                }
            } else {
                // Group by day for week/month view
                for (let i = 0; i < dataPoints; i++) {
                    const dayDate = new Date(startDate);
                    dayDate.setDate(startDate.getDate() + i);
                    const dayEnd = new Date(dayDate);
                    dayEnd.setDate(dayDate.getDate() + 1);

                    const dayReceipts = receipts.filter(r => {
                        const date = new Date(r.purchase_date || r.date);
                        return date >= dayDate && date < dayEnd;
                    });

                    const dayTotal = dayReceipts.reduce((sum, r) => {
                        const total = r.total_amount || r.total || 0;
                        return sum + total;
                    }, 0);

                    const label = period === 'week'
                        ? dayDate.toLocaleDateString('en-US', { weekday: 'short' })
                        : dayDate.getDate().toString();

                    trendData.push({
                        label,
                        value: dayTotal
                    });
                }
            }

            return trendData;
        }

        function renderDonutChart(categoryBreakdown, totalSpent) {
            const svg = document.getElementById('donutChart');
            svg.innerHTML = '';

            // Update total amount
            document.getElementById('donutTotalAmount').textContent = totalSpent.toFixed(0) + ' kr';

            if (totalSpent === 0) {
                // Show empty state
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '100');
                text.setAttribute('y', '100');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#9CA3AF');
                text.setAttribute('font-size', '14');
                text.textContent = 'No data';
                svg.appendChild(text);

                document.getElementById('categoryLegend').innerHTML = '<p style="color: var(--text-tertiary); text-align: center;">No transactions in this period</p>';
                return;
            }

            // Calculate percentages and sort categories
            const categories = Object.entries(categoryBreakdown)
                .map(([cat, amount]) => ({
                    category: cat,
                    amount,
                    percentage: (amount / totalSpent) * 100
                }))
                .sort((a, b) => b.amount - a.amount);

            // Draw donut chart
            const centerX = 100;
            const centerY = 100;
            const radius = 80;
            const innerRadius = 55;
            let currentAngle = -90; // Start from top

            categories.forEach(({ category, percentage }) => {
                const angle = (percentage / 100) * 360;
                const endAngle = currentAngle + angle;

                // Create arc path
                const startX = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                const startY = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                const endX = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                const endY = centerY + radius * Math.sin((endAngle * Math.PI) / 180);

                const innerStartX = centerX + innerRadius * Math.cos((endAngle * Math.PI) / 180);
                const innerStartY = centerY + innerRadius * Math.sin((endAngle * Math.PI) / 180);
                const innerEndX = centerX + innerRadius * Math.cos((currentAngle * Math.PI) / 180);
                const innerEndY = centerY + innerRadius * Math.sin((currentAngle * Math.PI) / 180);

                const largeArcFlag = angle > 180 ? 1 : 0;

                const pathData = [
                    `M ${startX} ${startY}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                    `L ${innerStartX} ${innerStartY}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${innerEndX} ${innerEndY}`,
                    'Z'
                ].join(' ');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', categoryColors[category] || '#95A5A6');
                path.setAttribute('class', 'donut-segment');
                path.setAttribute('data-category', category);
                path.style.cursor = 'pointer';

                // Add click handler to donut segment
                path.addEventListener('click', () => selectCategory(category));

                svg.appendChild(path);

                currentAngle = endAngle;
            });

            // Render legend
            const legendHTML = categories.map(({ category, amount }) => `
                <div class="legend-item" data-category="${category}" onclick="selectCategory('${category}')">
                    <div class="legend-color" style="background: ${categoryColors[category] || '#95A5A6'};"></div>
                    <div class="legend-label">${category}</div>
                    <div class="legend-amount">${amount.toFixed(0)} kr</div>
                </div>
            `).join('');

            document.getElementById('categoryLegend').innerHTML = legendHTML;
        }

        function renderAreaChart(trendData) {
            const svg = document.getElementById('areaChart');
            svg.innerHTML = '';

            if (!trendData || trendData.length === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '400');
                text.setAttribute('y', '140');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#9CA3AF');
                text.setAttribute('font-size', '16');
                text.textContent = 'No trend data available';
                svg.appendChild(text);
                return;
            }

            const width = 800;
            const height = 280;
            const padding = { top: 20, right: 40, bottom: 40, left: 60 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Find max value for scaling
            const maxValue = Math.max(...trendData.map(d => d.value), 1);
            const yScale = chartHeight / maxValue;
            const xStep = chartWidth / (trendData.length - 1 || 1);

            // Create points for line and area
            const points = trendData.map((d, i) => ({
                x: padding.left + (i * xStep),
                y: padding.top + chartHeight - (d.value * yScale)
            }));

            // Draw area (gradient fill)
            const areaPath = [
                `M ${points[0].x} ${height - padding.bottom}`,
                ...points.map(p => `L ${p.x} ${p.y}`),
                `L ${points[points.length - 1].x} ${height - padding.bottom}`,
                'Z'
            ].join(' ');

            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', 'areaGradient');
            gradient.setAttribute('x1', '0');
            gradient.setAttribute('x2', '0');
            gradient.setAttribute('y1', '0');
            gradient.setAttribute('y2', '1');

            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('stop-color', '#2D9CDB');
            stop1.setAttribute('stop-opacity', '0.3');

            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('stop-color', '#2D9CDB');
            stop2.setAttribute('stop-opacity', '0.05');

            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            defs.appendChild(gradient);
            svg.appendChild(defs);

            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', areaPath);
            area.setAttribute('fill', 'url(#areaGradient)');
            svg.appendChild(area);

            // Draw line
            const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('d', linePath);
            line.setAttribute('stroke', '#2D9CDB');
            line.setAttribute('stroke-width', '3');
            line.setAttribute('fill', 'none');
            line.setAttribute('stroke-linecap', 'round');
            line.setAttribute('stroke-linejoin', 'round');
            svg.appendChild(line);

            // Draw data points
            points.forEach((p, i) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', p.x);
                circle.setAttribute('cy', p.y);
                circle.setAttribute('r', '4');
                circle.setAttribute('fill', '#2D9CDB');
                circle.setAttribute('stroke', 'white');
                circle.setAttribute('stroke-width', '2');
                svg.appendChild(circle);
            });

            // Draw X-axis labels
            trendData.forEach((d, i) => {
                const x = padding.left + (i * xStep);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', height - padding.bottom + 25);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('class', 'chart-axis-label');
                text.textContent = d.label;
                svg.appendChild(text);
            });

            // Draw Y-axis labels (simplified)
            const yTicks = 5;
            for (let i = 0; i <= yTicks; i++) {
                const value = (maxValue / yTicks) * i;
                const y = padding.top + chartHeight - (value * yScale);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', padding.left - 10);
                text.setAttribute('y', y);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('class', 'chart-axis-label');
                text.textContent = value.toFixed(0);
                svg.appendChild(text);

                // Grid line
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', padding.left);
                gridLine.setAttribute('y1', y);
                gridLine.setAttribute('x2', width - padding.right);
                gridLine.setAttribute('y2', y);
                gridLine.setAttribute('stroke', '#E5E7EB');
                gridLine.setAttribute('stroke-width', '1');
                gridLine.setAttribute('stroke-dasharray', '4 4');
                svg.insertBefore(gridLine, svg.firstChild);
            }
        }

        function updateQuickStats(data) {
            document.getElementById('avgPerDay').textContent = data.avgPerDay.toFixed(0) + ' kr';
            document.getElementById('topCategory').textContent = data.topCategory;
            document.getElementById('transactionCount').textContent = data.transactionCount;
        }

        // Category icons mapping
        const categoryIcons = {
            'Groceries': '',
            'Dining': '',
            'Transport': '',
            'Entertainment': '',
            'Shopping': '',
            'Healthcare': '',
            'Household': '',
            'Personal Care': '',
            'Other': ''
        };

        function renderTopSpending(categoryBreakdown, totalSpent) {
            const container = document.getElementById('topSpendingList');

            if (!categoryBreakdown || totalSpent === 0) {
                container.innerHTML = '<p style="color: var(--text-tertiary); text-align: center; padding: 40px 20px;">No spending data available for this period</p>';
                return;
            }

            // Sort categories by amount (highest first) and take top 5
            const sortedCategories = Object.entries(categoryBreakdown)
                .map(([category, amount]) => ({
                    category,
                    amount,
                    percentage: (amount / totalSpent) * 100
                }))
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 5);

            const cardsHTML = sortedCategories.map(({ category, amount, percentage }) => {
                const color = categoryColors[category] || '#95A5A6';
                const icon = categoryIcons[category] || '';
                const lightColor = `${color}20`; // Add alpha for light background

                return `
                    <div class="category-spending-card" onclick="showCategoryDetail('${category}')">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <!-- Category Icon -->
                            <div class="category-icon-circle" style="background: ${lightColor};">
                                ${icon}
                            </div>

                            <!-- Category Info -->
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--text-primary);">
                                        ${category}
                                    </div>
                                    <div style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: ${color};">
                                        ${amount.toFixed(0)} kr
                                    </div>
                                </div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: 8px;">
                                    ${percentage.toFixed(1)}% of total spending
                                </div>

                                <!-- Progress Bar -->
                                <div class="spending-progress-bar">
                                    <div class="spending-progress-fill" style="width: ${percentage}%; background: ${color};"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cardsHTML;
        }

        // ============ AI INSIGHT GENERATION ============

        function generateInsight() {
            const insightElement = document.getElementById('insightText');

            if (!allReceipts || allReceipts.length === 0) {
                insightElement.textContent = 'Start scanning receipts to get personalized spending insights!';
                return;
            }

            // Calculate spending data for insights
            const now = new Date();
            const lastWeek = new Date(now);
            lastWeek.setDate(now.getDate() - 7);
            const lastMonth = new Date(now);
            lastMonth.setMonth(now.getMonth() - 1);

            const thisWeekReceipts = allReceipts.filter(r => new Date(r.purchase_date || r.date) >= lastWeek);
            const lastMonthReceipts = allReceipts.filter(r => {
                const date = new Date(r.purchase_date || r.date);
                return date >= lastMonth && date < lastWeek;
            });

            // Calculate category totals
            const categoryTotals = {};
            const categoryWeekTotals = {};
            allReceipts.forEach(receipt => {
                if (receipt.items) {
                    receipt.items.forEach(item => {
                        const category = item.category || 'Other';
                        const price = item.total_price || item.price || 0;
                        categoryTotals[category] = (categoryTotals[category] || 0) + price;
                    });
                }
            });

            thisWeekReceipts.forEach(receipt => {
                if (receipt.items) {
                    receipt.items.forEach(item => {
                        const category = item.category || 'Other';
                        const price = item.total_price || item.price || 0;
                        categoryWeekTotals[category] = (categoryWeekTotals[category] || 0) + price;
                    });
                }
            });

            // Calculate total spending
            const thisWeekTotal = thisWeekReceipts.reduce((sum, r) => sum + (r.total_amount || r.total || 0), 0);
            const lastMonthTotal = lastMonthReceipts.reduce((sum, r) => sum + (r.total_amount || r.total || 0), 0);
            const avgWeeklySpending = lastMonthTotal / 4;

            // Find top category
            const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];

            // Generate insights
            const insights = [];

            // Insight 1: Weekly spending comparison
            if (avgWeeklySpending > 0) {
                const percentChange = ((thisWeekTotal - avgWeeklySpending) / avgWeeklySpending) * 100;
                if (percentChange < -10) {
                    insights.push(` Great job! You've spent ${Math.abs(percentChange).toFixed(0)}% less this week than your average. Keep it up!`);
                } else if (percentChange > 10) {
                    insights.push(` You've spent ${percentChange.toFixed(0)}% more this week than usual. Consider reviewing your budget.`);
                } else {
                    insights.push(` Your spending this week is on track with your average of ${avgWeeklySpending.toFixed(0)} kr.`);
                }
            }

            // Insight 2: Top category
            if (topCategory) {
                const percentage = (topCategory[1] / Object.values(categoryTotals).reduce((a, b) => a + b, 0)) * 100;
                insights.push(`${categoryIcons[topCategory[0]] || ''} Your biggest spending category is ${topCategory[0]} at ${percentage.toFixed(0)}% of total (${topCategory[1].toFixed(0)} kr).`);
            }

            // Insight 3: Transaction frequency
            const avgTransactionsPerWeek = (allReceipts.length / Math.max(1, Math.ceil((now - new Date(allReceipts[allReceipts.length - 1]?.purchase_date || allReceipts[allReceipts.length - 1]?.date)) / (7 * 24 * 60 * 60 * 1000))));
            if (thisWeekReceipts.length > avgTransactionsPerWeek * 1.5) {
                insights.push(` You've made ${thisWeekReceipts.length} purchases this week, more than your usual ${avgTransactionsPerWeek.toFixed(0)} per week.`);
            } else if (thisWeekReceipts.length < avgTransactionsPerWeek * 0.5) {
                insights.push(` You've made fewer purchases this week (${thisWeekReceipts.length}) compared to your average of ${avgTransactionsPerWeek.toFixed(0)} per week.`);
            }

            // Insight 4: Category-specific insights
            const groceriesThisWeek = categoryWeekTotals['Groceries'] || 0;
            const diningThisWeek = categoryWeekTotals['Dining'] || 0;

            if (diningThisWeek > groceriesThisWeek && diningThisWeek > 500) {
                insights.push(` You're spending more on dining (${diningThisWeek.toFixed(0)} kr) than groceries this week. Cooking at home could save you money!`);
            }

            // Insight 5: Streak or milestone
            if (allReceipts.length >= 10) {
                insights.push(` You've tracked ${allReceipts.length} receipts! You're building great financial awareness.`);
            }

            // Select a random insight or combine them
            let finalInsight = insights[Math.floor(Math.random() * insights.length)];

            if (!finalInsight) {
                finalInsight = ` You've tracked ${allReceipts.length} receipt${allReceipts.length > 1 ? 's' : ''} with a total of ${Object.values(categoryTotals).reduce((a, b) => a + b, 0).toFixed(0)} kr in spending. Keep tracking to get personalized insights!`;
            }

            insightElement.textContent = finalInsight;
        }

        // ============ INTERACTIVE CATEGORY SELECTION ============

        let selectedCategory = null;

        function selectCategory(category) {
            selectedCategory = category;

            // Highlight the selected segment in donut chart
            document.querySelectorAll('.donut-segment').forEach(segment => {
                if (segment.getAttribute('data-category') === category) {
                    segment.classList.add('selected');
                } else {
                    segment.classList.remove('selected');
                }
            });

            // Highlight the selected legend item
            document.querySelectorAll('.legend-item').forEach(item => {
                if (item.getAttribute('data-category') === category) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });

            // Scroll legend item into view
            const selectedLegendItem = document.querySelector(`.legend-item[data-category="${category}"]`);
            if (selectedLegendItem) {
                selectedLegendItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Show category detail modal
            showCategoryDetail(category);
        }

        function showCategoryDetail(category) {
            const modal = document.getElementById('categoryModal');
            const color = categoryColors[category] || '#95A5A6';
            const icon = categoryIcons[category] || '';
            const lightColor = `${color}20`;

            // Set modal header
            document.getElementById('modalCategoryName').textContent = category;
            document.getElementById('modalCategoryPeriod').textContent = `${currentAnalyticsPeriod === 'week' ? 'This Week' : currentAnalyticsPeriod === 'month' ? 'This Month' : 'This Year'}`;

            const modalIcon = document.getElementById('modalCategoryIcon');
            modalIcon.textContent = icon;
            modalIcon.style.background = lightColor;

            // Calculate category data
            const now = new Date();
            let startDate;
            if (currentAnalyticsPeriod === 'week') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
            } else if (currentAnalyticsPeriod === 'month') {
                startDate = new Date(now);
                startDate.setMonth(now.getMonth() - 1);
            } else {
                startDate = new Date(now);
                startDate.setFullYear(now.getFullYear() - 1);
            }

            // Get all items in this category within the period
            const categoryItems = [];
            allReceipts.forEach(receipt => {
                const receiptDate = new Date(receipt.purchase_date || receipt.date);
                if (receiptDate >= startDate && receiptDate <= now) {
                    if (receipt.items) {
                        receipt.items.forEach(item => {
                            if ((item.category || 'Other') === category) {
                                categoryItems.push({
                                    name: item.name,
                                    price: item.total_price || item.price || 0,
                                    store: receipt.store || 'Unknown',
                                    date: receipt.date || receipt.purchase_date
                                });
                            }
                        });
                    }
                }
            });

            // Calculate total and count
            const total = categoryItems.reduce((sum, item) => sum + item.price, 0);
            const count = categoryItems.length;

            document.getElementById('modalCategoryTotal').textContent = total.toFixed(0) + ' kr';
            document.getElementById('modalCategoryCount').textContent = count;

            // Sort items by price (highest first)
            categoryItems.sort((a, b) => b.price - a.price);

            // Render items list
            const itemsHTML = categoryItems.length > 0
                ? categoryItems.map(item => `
                    <div class="category-detail-item">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: 2px;">
                                ${item.name}
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                ${item.store}  ${item.date}
                            </div>
                        </div>
                        <div style="font-weight: var(--font-weight-bold); color: ${color}; font-size: var(--font-size-lg);">
                            ${item.price.toFixed(2)} kr
                        </div>
                    </div>
                `).join('')
                : '<p style="color: var(--text-tertiary); text-align: center; padding: 20px;">No items in this category</p>';

            document.getElementById('modalCategoryItems').innerHTML = itemsHTML;

            // Show modal
            modal.classList.add('active');
        }

        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('active');

            // Clear selection
            document.querySelectorAll('.donut-segment.selected').forEach(segment => {
                segment.classList.remove('selected');
            });
            document.querySelectorAll('.legend-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            selectedCategory = null;
        }

        // Close budget recommendations modal
        function closeBudgetRecommendationsModal() {
            const modal = document.getElementById('budgetRecommendationsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ============ TAG SYSTEM ============

        let currentTagContext = null; // Stores { receiptId, itemId }
        let activeTagFilter = null;
        const commonTagSuggestions = ['Work', 'Personal', 'Gift', 'Business', 'Reimbursable', 'Tax Deductible', 'Recurring', 'One-time', 'Essential', 'Luxury'];

        // Open tag input popup
        function openTagInputPopup(receiptId, itemId) {
            currentTagContext = { receiptId, itemId };
            const popup = document.getElementById('tagInputPopup');
            const input = document.getElementById('tagInputField');

            input.value = '';
            input.focus();

            // Populate suggestions
            renderTagSuggestions();

            popup.classList.add('active');
        }

        // Close tag input popup
        function closeTagInputPopup() {
            const popup = document.getElementById('tagInputPopup');
            popup.classList.remove('active');
            currentTagContext = null;
        }

        // Render tag suggestions
        function renderTagSuggestions() {
            const container = document.getElementById('tagSuggestions');

            // Get existing tags for this item
            const existingTags = getItemTags(currentTagContext.receiptId, currentTagContext.itemId);

            // Filter suggestions to exclude already added tags
            const availableSuggestions = commonTagSuggestions.filter(tag => !existingTags.includes(tag));

            container.innerHTML = availableSuggestions.map(tag => `
                <div class="tag-suggestion" onclick="addTagFromSuggestion('${tag}')">
                    ${tag}
                </div>
            `).join('');
        }

        // Add tag from input field
        async function addTagFromInput() {
            const input = document.getElementById('tagInputField');
            const tagName = input.value.trim();

            if (!tagName) {
                showToast('Please enter a tag name', 'warning');
                return;
            }

            if (!currentTagContext) {
                showToast('Tag context lost. Please try again', 'error');
                return;
            }

            await addTag(currentTagContext.receiptId, currentTagContext.itemId, tagName);
            input.value = '';
            renderTagSuggestions();
        }

        // Add tag from suggestion
        async function addTagFromSuggestion(tagName) {
            if (!currentTagContext) return;
            await addTag(currentTagContext.receiptId, currentTagContext.itemId, tagName);
            closeTagInputPopup();
        }

        // Add tag to item
        async function addTag(receiptId, itemId, tagName) {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) {
                    showToast('Please sign in to add tags', 'error');
                    return;
                }

                // Get current tags
                const existingTags = getItemTags(receiptId, itemId);

                // Check if tag already exists
                if (existingTags.includes(tagName)) {
                    showToast('Tag already exists', 'warning');
                    return;
                }

                // Add new tag
                const updatedTags = [...existingTags, tagName];

                // Update the receipt in allReceipts
                const receipt = allReceipts.find(r => r.id === receiptId);
                if (receipt && receipt.items) {
                    const item = receipt.items.find((_, idx) => idx === itemId);
                    if (item) {
                        if (!item.tags) item.tags = [];
                        item.tags = updatedTags;

                        // Update in Supabase
                        const { error } = await _supabase
                            .from('receipts')
                            .update({ items: receipt.items })
                            .eq('id', receiptId);

                        if (error) throw error;

                        showToast(`Tag "${tagName}" added`, 'success');
                        updateDataTable();
                        updateTagFilters();
                    }
                }
            } catch (error) {
                console.error('Error adding tag:', error);
                showToast('Failed to add tag', 'error');
            }
        }

        // Remove tag from item
        async function removeTag(receiptId, itemId, tagName) {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;

                // Get current tags
                const existingTags = getItemTags(receiptId, itemId);
                const updatedTags = existingTags.filter(t => t !== tagName);

                // Update the receipt in allReceipts
                const receipt = allReceipts.find(r => r.id === receiptId);
                if (receipt && receipt.items) {
                    const item = receipt.items.find((_, idx) => idx === itemId);
                    if (item) {
                        item.tags = updatedTags;

                        // Update in Supabase
                        const { error } = await _supabase
                            .from('receipts')
                            .update({ items: receipt.items })
                            .eq('id', receiptId);

                        if (error) throw error;

                        showToast(`Tag "${tagName}" removed`, 'info');
                        updateDataTable();
                        updateTagFilters();
                    }
                }
            } catch (error) {
                console.error('Error removing tag:', error);
                showToast('Failed to remove tag', 'error');
            }
        }

        // Get tags for an item
        function getItemTags(receiptId, itemId) {
            const receipt = allReceipts.find(r => r.id === receiptId);
            if (receipt && receipt.items) {
                const item = receipt.items.find((_, idx) => idx === itemId);
                return item?.tags || [];
            }
            return [];
        }

        // Render tags for an item
        function renderTags(receiptId, itemId) {
            const tags = getItemTags(receiptId, itemId);

            const tagsHTML = tags.map(tag => `
                <span class="tag-pill">
                    ${tag}
                    <button class="tag-remove" onclick="removeTag('${receiptId}', ${itemId}, '${tag}')" title="Remove tag">
                        
                    </button>
                </span>
            `).join('');

            const addButton = `<button class="tag-add-btn" onclick="openTagInputPopup('${receiptId}', ${itemId})" title="Add tag">+</button>`;

            return `<div class="tag-container">${tagsHTML}${addButton}</div>`;
        }

        // Update tag filters
        function updateTagFilters() {
            const allTags = new Set();

            // Collect all unique tags from all items
            allReceipts.forEach(receipt => {
                if (receipt.items) {
                    receipt.items.forEach(item => {
                        if (item.tags && Array.isArray(item.tags)) {
                            item.tags.forEach(tag => allTags.add(tag));
                        }
                    });
                }
            });

            const container = document.getElementById('tagFilterContainer');
            const pillsContainer = document.getElementById('tagFilterPills');

            if (allTags.size === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';

            // Create clear filter option
            let pillsHTML = `<div class="tag-filter-pill ${!activeTagFilter ? 'active' : ''}" onclick="setTagFilter(null)">All</div>`;

            // Create filter pill for each tag
            pillsHTML += Array.from(allTags).sort().map(tag => `
                <div class="tag-filter-pill ${activeTagFilter === tag ? 'active' : ''}" onclick="setTagFilter('${tag}')">
                     ${tag}
                </div>
            `).join('');

            pillsContainer.innerHTML = pillsHTML;
        }

        // Set tag filter
        function setTagFilter(tag) {
            activeTagFilter = tag;
            updateTagFilters();
            updateDataTable();
        }

        // Close popup when clicking outside
        document.getElementById('tagInputPopup')?.addEventListener('click', (e) => {
            if (e.target.id === 'tagInputPopup') {
                closeTagInputPopup();
            }
        });

        // ============ MANUAL ENTRY SYSTEM ============

        // Open manual entry modal
        function openManualEntryModal() {
            const modal = document.getElementById('manualEntryModal');
            const form = document.getElementById('manualEntryForm');

            // Reset form
            form.reset();

            // Reset amount display
            document.getElementById('manualAmount').value = '';

            // Reset category selection
            document.querySelectorAll('.category-pill').forEach(pill => {
                pill.classList.remove('selected');
            });

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('manualDate').value = today;

            modal.classList.add('active');
        }

        // Category selection handler
        function selectCategory(category, button) {
            // Remove selected from all pills
            document.querySelectorAll('.category-pill').forEach(pill => {
                pill.classList.remove('selected');
            });

            // Add selected to clicked pill
            button.classList.add('selected');

            // Set hidden input value
            document.getElementById('manualCategory').value = category;
        }

        // Keypad append number
        function appendNumber(digit) {
            const amountInput = document.getElementById('manualAmount');
            let currentValue = amountInput.value;

            // Prevent multiple decimal points
            if (digit === '.' && currentValue.includes('.')) {
                return;
            }

            // Limit to 2 decimal places
            if (currentValue.includes('.')) {
                const decimalPart = currentValue.split('.')[1];
                if (decimalPart && decimalPart.length >= 2) {
                    return;
                }
            }

            amountInput.value = currentValue + digit;
        }

        // Keypad backspace
        function backspaceNumber() {
            const amountInput = document.getElementById('manualAmount');
            amountInput.value = amountInput.value.slice(0, -1);
        }

        // Close manual entry modal
        function closeManualEntryModal() {
            const modal = document.getElementById('manualEntryModal');
            modal.classList.remove('active');
        }

        // Submit manual entry
        async function submitManualEntry(event) {
            event.preventDefault();

            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) {
                    showToast('Please sign in to add expenses', 'error');
                    return;
                }

                // Get form values
                const store = document.getElementById('manualStore').value.trim();
                const itemName = document.getElementById('manualItem').value.trim();
                const amount = parseFloat(document.getElementById('manualAmount').value);
                const category = document.getElementById('manualCategory').value;
                const date = document.getElementById('manualDate').value;

                // Validate
                if (!store || !itemName || isNaN(amount) || amount <= 0 || !category || !date) {
                    showToast('Please fill in all required fields', 'warning');
                    return;
                }

                // Create receipt object (compatible with scanned receipts)
                const manualReceipt = {
                    user_id: user.id,
                    store_name: store,
                    purchase_date: date,
                    total_amount: amount,
                    items: [
                        {
                            name: itemName,
                            category: category,
                            subcategory: 'Manual Entry',
                            price: amount,
                            total_price: amount,
                            quantity: 1,
                            notes: null
                        }
                    ],
                    is_manual_entry: true,
                    items_count: 1,
                    currency: 'SEK'
                };

                // Save to Supabase
                const { data, error } = await _supabase
                    .from('receipts')
                    .insert([manualReceipt])
                    .select();

                if (error) throw error;

                // Add to local array
                if (data && data.length > 0) {
                    allReceipts.unshift(data[0]);
                }

                // Close modal
                closeManualEntryModal();

                // Show success message
                showToast(`Expense added: ${amount.toFixed(2)} kr at ${store}`, 'success');

                // Update displays
                updateHistory();
                updateDataTable();
                document.querySelector('.nav-tab[onclick*="history"]').click(); // Navigate to history tab to show the new entry

                // Show celebration for first manual entry
                const manualEntryCount = allReceipts.filter(r => r.is_manual_entry).length;
                if (manualEntryCount === 1) {
                    setTimeout(() => {
                        showToast(' Great! You can now track expenses without receipts!', 'success');
                    }, 1000);
                }

            } catch (error) {
                console.error('Error adding manual entry:', error);
                showToast('Failed to add expense. Please try again.', 'error');
            }
        }

        // Close modal when clicking outside
        document.getElementById('manualEntryModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'manualEntryModal') {
                closeManualEntryModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('categoryModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'categoryModal') {
                closeCategoryModal();
            }
        });
    </script>
</body>
</html>
